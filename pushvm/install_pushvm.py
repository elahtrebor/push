import ubinascii
import os
import sys
import gc

import uos, ubinascii, gc

def mkdir_p(path):
    parts = path.split("/")
    cur = ""
    for p in parts:
        if not p:
            continue
        cur += "/" + p
        try:
            uos.stat(cur)
        except OSError:
            try:
                uos.mkdir(cur)
            except OSError:
                pass

def write_b64_chunks_to_file(path, b64_chunks, gc_every=32):
    parent = path.rsplit("/", 1)[0]
    if parent:
        mkdir_p(parent)

    tmp = path + ".tmp"
    try:
        uos.remove(tmp)
    except OSError:
        pass

    with open(tmp, "wb") as f:
        for i, ch in enumerate(b64_chunks, 1):
            if isinstance(ch, str):
                ch = ch.encode()
            f.write(ubinascii.a2b_base64(ch))
            if i % gc_every == 0:
                gc.collect()

    try:
        uos.remove(path)
    except OSError:
        pass
    uos.rename(tmp, path)
    gc.collect()




def decode_b64_to_text(b64_chunks):
    if isinstance(b64_chunks, (tuple, list)):
        b64 = "".join(b64_chunks)
    else:
        b64 = b64_chunks
    raw = ubinascii.a2b_base64(b64.encode() if isinstance(b64, str) else b64)
    return raw.decode("utf-8")

def write_text_file(path, text):
    parent = path.rsplit("/", 1)[0]
    if parent:
        mkdir_p(parent)

    tmp = path + ".tmp"
    try:
        uos.remove(tmp)
    except OSError:
        pass
    with open(tmp, "w") as f:
        f.write(text)
    try:
        uos.remove(path)
    except OSError:
        pass
    uos.rename(tmp, path)
    gc.collect()     

def append_to_file(fname, data):
    with open(fname, "a") as f:
     f.write(data)
     f.close()

print("Installing pushvm /lib and xpkg...")

mkdir_p("/lib")


PUSHB64 = (
    "IyBwdXNodm0ucHkKIyBQVVNIIFZNIChFU1AzMi1maXJzdCBjb21wbGV0ZSB2ZXJzaW9uKQojIEZlYXR1cmVzOgojIC0gQ29tbWFuZHM6IGhlbHAsIGxzLCB1bmFtZSwgZnJlZSwgZGYsIHB3ZCwgY2F0LCB3YywgZ3JlcCwgY3AsIGNkLCByZW5hbWUsCiMgICAgICAgICAgICBta2Rpciwgcm1kaXIsIGV4ZWMsIHJtLCBkYXRlLCBzY2Fud2lmaSwgY29ubmVjdCwgaWZjb25maWcsIGVkaXQsCiMgICAgICAgICAgICBlY2hvLCB1cHBlciwgdGVzdCAoWyksIHdyaXRlICg+KSwgYXBwZW5kICg+PiksIHNsZWVwCiMgLSBQaXBlbGluZXM6IHwKIyAtIFJlZGlyZWN0aW9uOiA+IGFuZCA+PiAoY29tcGlsZWQgdG8gfCB3cml0ZSAvIHwgYXBwZW5kKQojIC0gVmFyaWFibGVzOiB4PTMgYW5kICR4IGV4cGFuc2lvbgojIC0gQ29udHJvbCBmbG93OgojICAgICBpZiA8cGlwZWxpbmU+IHRoZW4gPHN0bXRzPiBbZWxzZSA8c3RtdHM+XSBmaQojICAgICB3aGlsZSA8cGlwZWxpbmU+IGRvIDxzdG10cz4gZG9uZQojICAgICBmb3IgaSAxIDEwIFtzdGVwXSBkbyA8c3RtdHM+IGRvbmUKIyAgICAgZm9yZWFjaCB2IGluIGEgYiBjIGRvIDxzdG10cz4gZG9uZQojICAgICBmb3JlYWNo",
    "IHYgaW4gPHBpcGVsaW5lPiBkbyA8c3RtdHM+IGRvbmUgICAoc3BsaXRzIG91dHB1dCBieSBsaW5lcykKIyAgICAgYnJlYWsgLyBjb250aW51ZQojIC0gU2hvcnQtY2lyY3VpdDogJiYgYW5kIHx8CiMgLSBCYWNrZ3JvdW5kIGpvYnM6IHRyYWlsaW5nICYgKGpvYnMva2lsbC9mZykKIyAtIEh5YnJpZCBwaXBlIHNwb29saW5nOiBSQU0gdW50aWwgdGhyZXNob2xkIHRoZW4gc3BpbGwgdG8gU1RET1VUIGZpbGUKIyAtIFJFUEw6IGF1dG8gc2VsZWN0cyBsaXZlIG1vZGUgKG5vbi1ibG9ja2luZykgb24gTWljcm9QeXRob24gd2hlbiBwb2xsYWJsZSwKIyAgICAgICAgIG90aGVyd2lzZSB1c2VzIGJhc2ljIGlucHV0KCkgKGJldHRlciBmb3IgZGVza3RvcCB0ZXN0aW5nKQojCiMgTm90ZXM6CiMgLSBEZXNpZ25lZCBmb3IgRVNQMzIvV2ViUkVQTCArIFRob25ueTsgYWxzbyBydW5zIG9uIENQeXRob24gZm9yIGRldmVsb3BtZW50LgojIC0gc2xlZXAgd29ya3MgY29ycmVjdGx5IGluIGJhY2tncm91bmQgam9icyAobm8gZ2VuZXJhdG9yIHJlLWVudHJhbmN5KS4KCmltcG9ydCBvcwppbXBvcnQgdGltZQppbXBvcnQgc3lzCgp0cnk6CiAgICBpbXBvcnQgZ2MKZXhjZXB0",
    "IEV4Y2VwdGlvbjoKICAgIGdjID0gTm9uZQoKdHJ5OgogICAgaW1wb3J0IG5ldHdvcmsKZXhjZXB0IEV4Y2VwdGlvbjoKICAgIG5ldHdvcmsgPSBOb25lCgp0cnk6CiAgICBpbXBvcnQgdXNlbGVjdCBhcyBzZWxlY3QgICMgTWljcm9QeXRob24KZXhjZXB0IEV4Y2VwdGlvbjoKICAgIHRyeToKICAgICAgICBpbXBvcnQgc2VsZWN0ICAjIENQeXRob24gZmFsbGJhY2sKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgc2VsZWN0ID0gTm9uZQoKVkVSU0lPTiA9ICJwdXNodm0tY29tcGxldGUtMC4xIgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIEdsb2JhbCAiY3VycmVudCBWTSIgcG9pbnRlciBzbyBjb21tYW5kcyBjYW4gYWZmZWN0IHRoZSBWTSB0aGF0IGlzIGFjdHVhbGx5IGV4ZWN1dGluZy4KIyBUaGlzIGtlZXBzIGNvbW1hbmRzIGRpY3Qgc2hhcmVkIGFjcm9zcyBiYWNrZ3JvdW5kIGpvYiBjbG9uZXMgd2l0aG91dCBjbG9zdXJlcyBib3VuZCB0byB0aGUgd3JvbmcgVk0uCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KX0NVUlJFTlRfVk0gPSBOb25lCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgVGltZSBoZWxwZXJzCiMgLS0tLS0tLS0t",
    "LS0tLS0tLS0tLS0tLS0KZGVmIF9zbGVlcF9tcyhtcyk6CiAgICBpZiBoYXNhdHRyKHRpbWUsICJzbGVlcF9tcyIpOgogICAgICAgIHRpbWUuc2xlZXBfbXMobXMpCiAgICBlbHNlOgogICAgICAgIHRpbWUuc2xlZXAobXMgLyAxMDAwLjApCgpkZWYgX3RpY2tzX21zKCk6CiAgICBpZiBoYXNhdHRyKHRpbWUsICJ0aWNrc19tcyIpOgogICAgICAgIHJldHVybiB0aW1lLnRpY2tzX21zKCkKICAgIHJldHVybiBpbnQodGltZS50aW1lKCkgKiAxMDAwKQoKZGVmIF90aWNrc19hZGQoYSwgbXMpOgogICAgaWYgaGFzYXR0cih0aW1lLCAidGlja3NfYWRkIik6CiAgICAgICAgcmV0dXJuIHRpbWUudGlja3NfYWRkKGEsIG1zKQogICAgcmV0dXJuIGEgKyBtcwoKZGVmIF90aWNrc19kaWZmKGEsIGIpOgogICAgaWYgaGFzYXR0cih0aW1lLCAidGlja3NfZGlmZiIpOgogICAgICAgIHJldHVybiB0aW1lLnRpY2tzX2RpZmYoYSwgYikKICAgIHJldHVybiBhIC0gYgoKZGVmIGlzX21pY3JvcHl0aG9uKCk6CiAgICB0cnk6CiAgICAgICAgcmV0dXJuIHN5cy5pbXBsZW1lbnRhdGlvbi5uYW1lID09ICJtaWNyb3B5dGhvbiIKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAg",
    "cmV0dXJuIEZhbHNlCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgT3Bjb2RlcwojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCk9QX0xPQUQgICAgICA9IDEKT1BfQVJHICAgICAgID0gMgpPUF9QSVBFICAgICAgPSAzCk9QX0VYRUMgICAgICA9IDQgICAgICAjIGV4ZWN1dGUgKyBwcmludApPUF9TRVQgICAgICAgPSA1Ck9QX0dFVCAgICAgICA9IDYKT1BfSk1QICAgICAgID0gNwpPUF9KWiAgICAgICAgPSA4Ck9QX0VYRUNRICAgICA9IDkgICAgICAjIGV4ZWN1dGUgcXVpZXRseQpPUF9TRVRMSVNUICAgPSAxMCAgICAgIyB2YXJzW25hbWVdID0gbGlzdChpdGVtcykKT1BfU1BMSVRMICAgID0gMTEgICAgICMgdmFyc1tuYW1lXSA9IGxhc3Rfb3V0cHV0LnNwbGl0bGluZXMoKQpPUF9GT1JFX0lOSVQgPSAxMiAgICAgIyBpbml0IGZvcmVhY2ggaXRlcmF0b3IKT1BfRk9SRV9ORVhUID0gMTMgICAgICMgYWR2YW5jZSBmb3JlYWNoOyBpZiBkb25lIGp1bXAKT1BfRU5EICAgICAgID0gMjU1CgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgSHlicmlkIFBpcGVEYXRhIChSQU0gb3Igc3Bvb2wgZmlsZSkKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFz",
    "cyBQaXBlRGF0YToKICAgIF9fc2xvdHNfXyA9ICgidGV4dCIsICJwYXRoIiwgImlzX2ZpbGUiKQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0ZXh0PU5vbmUsIHBhdGg9Tm9uZSwgaXNfZmlsZT1GYWxzZSk6CiAgICAgICAgc2VsZi50ZXh0ID0gdGV4dAogICAgICAgIHNlbGYucGF0aCA9IHBhdGgKICAgICAgICBzZWxmLmlzX2ZpbGUgPSBpc19maWxlCgogICAgZGVmIGFzX3RleHQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5pc19maWxlOgogICAgICAgICAgICB3aXRoIG9wZW4oc2VsZi5wYXRoLCAiciIpIGFzIGY6CiAgICAgICAgICAgICAgICByZXR1cm4gZi5yZWFkKCkKICAgICAgICByZXR1cm4gIiIgaWYgc2VsZi50ZXh0IGlzIE5vbmUgZWxzZSBzdHIoc2VsZi50ZXh0KQoKICAgIGRlZiBvcGVuX3JlYWRlcihzZWxmKToKICAgICAgICBpZiBzZWxmLmlzX2ZpbGU6CiAgICAgICAgICAgIHJldHVybiBvcGVuKHNlbGYucGF0aCwgInIiKQogICAgICAgIHJldHVybiBfU3RyaW5nTGluZVJlYWRlcihzZWxmLmFzX3RleHQoKSkKCmNsYXNzIF9TdHJpbmdMaW5lUmVhZGVyOgogICAgX19zbG90c19fID0gKCJfcyIsICJfaSIsICJfbiIpCiAgICBkZWYgX19pbml0",
    "X18oc2VsZiwgcyk6CiAgICAgICAgc2VsZi5fcyA9IHMKICAgICAgICBzZWxmLl9pID0gMAogICAgICAgIHNlbGYuX24gPSBsZW4ocykKCiAgICBkZWYgX19pdGVyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgX19uZXh0X18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5faSA+PSBzZWxmLl9uOgogICAgICAgICAgICByYWlzZSBTdG9wSXRlcmF0aW9uCiAgICAgICAgcyA9IHNlbGYuX3MKICAgICAgICBqID0gcy5maW5kKCJcbiIsIHNlbGYuX2kpCiAgICAgICAgaWYgaiA9PSAtMToKICAgICAgICAgICAgbGluZSA9IHNbc2VsZi5faTpdCiAgICAgICAgICAgIHNlbGYuX2kgPSBzZWxmLl9uCiAgICAgICAgICAgIHJldHVybiBsaW5lCiAgICAgICAgbGluZSA9IHNbc2VsZi5faTpqKzFdCiAgICAgICAgc2VsZi5faSA9IGogKyAxCiAgICAgICAgcmV0dXJuIGxpbmUKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgcGFzcwoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIFRva2VuaXplciAocXVvdGVzICsgc3BlY2lhbHM6IHwgOyA+ID4+ICYmIHx8ICYpCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZGVmIHRva2VuaXplKHMpOgog",
    "ICAgb3V0ID0gW10KICAgIGJ1ZiA9ICIiCiAgICBpbl9xID0gRmFsc2UKICAgIGkgPSAwCiAgICBuID0gbGVuKHMpCgogICAgZGVmIGZsdXNoKCk6CiAgICAgICAgbm9ubG9jYWwgYnVmCiAgICAgICAgaWYgYnVmICE9ICIiOgogICAgICAgICAgICBvdXQuYXBwZW5kKGJ1ZikKICAgICAgICAgICAgYnVmID0gIiIKCiAgICB3aGlsZSBpIDwgbjoKICAgICAgICBjaCA9IHNbaV0KCiAgICAgICAgaWYgY2ggPT0gJyInOgogICAgICAgICAgICBpbl9xID0gbm90IGluX3EKICAgICAgICAgICAgaSArPSAxCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIG5vdCBpbl9xOgogICAgICAgICAgICBpZiBjaC5pc3NwYWNlKCk6CiAgICAgICAgICAgICAgICBmbHVzaCgpCiAgICAgICAgICAgICAgICBpICs9IDEKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIHR3by1jaGFyIG9wcwogICAgICAgICAgICBpZiBjaCA9PSAiJiIgYW5kIGkgKyAxIDwgbiBhbmQgc1tpKzFdID09ICImIjoKICAgICAgICAgICAgICAgIGZsdXNoKCk7IG91dC5hcHBlbmQoIiYmIik7IGkgKz0gMjsgY29udGludWUKICAgICAgICAgICAgaWYgY2ggPT0gInwiIGFu",
    "ZCBpICsgMSA8IG4gYW5kIHNbaSsxXSA9PSAifCI6CiAgICAgICAgICAgICAgICBmbHVzaCgpOyBvdXQuYXBwZW5kKCJ8fCIpOyBpICs9IDI7IGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGNoID09ICI+IiBhbmQgaSArIDEgPCBuIGFuZCBzW2krMV0gPT0gIj4iOgogICAgICAgICAgICAgICAgZmx1c2goKTsgb3V0LmFwcGVuZCgiPj4iKTsgaSArPSAyOyBjb250aW51ZQoKICAgICAgICAgICAgIyBvbmUtY2hhciBzcGVjaWFscwogICAgICAgICAgICBpZiBjaCBpbiAoInwiLCAiOyIsICI+IiwgIiYiKToKICAgICAgICAgICAgICAgIGZsdXNoKCk7IG91dC5hcHBlbmQoY2gpOyBpICs9IDE7IGNvbnRpbnVlCgogICAgICAgIGJ1ZiArPSBjaAogICAgICAgIGkgKz0gMQoKICAgIGZsdXNoKCkKICAgIHJldHVybiBvdXQKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBDb21waWxlciB3aXRoIGxvb3BzICsgaWYgKyBjaGFpbnMgJiYvfHwgKyByZWRpcmVjdGlvbgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNsYXNzIENvbXBpbGVFcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKY2xhc3MgQ29tcGlsZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdG9rZW5z",
    "KToKICAgICAgICBzZWxmLnRva3MgPSB0b2tlbnMKICAgICAgICBzZWxmLmkgPSAwCiAgICAgICAgc2VsZi5jb2RlID0gW10KICAgICAgICBzZWxmLmxvb3Bfc3RhY2sgPSBbXSAgICMgeyJzdGFydCI6IHBjLCAiYnJlYWtfam1wcyI6Wy4uLl19CiAgICAgICAgc2VsZi5fdG1wX2NvdW50ZXIgPSAwCgogICAgZGVmIHBlZWsoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYudG9rc1tzZWxmLmldIGlmIHNlbGYuaSA8IGxlbihzZWxmLnRva3MpIGVsc2UgTm9uZQoKICAgIGRlZiBwb3Aoc2VsZik6CiAgICAgICAgdCA9IHNlbGYucGVlaygpCiAgICAgICAgaWYgdCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHNlbGYuaSArPSAxCiAgICAgICAgcmV0dXJuIHQKCiAgICBkZWYgZXhwZWN0KHNlbGYsIHMpOgogICAgICAgIHQgPSBzZWxmLnBvcCgpCiAgICAgICAgaWYgdCAhPSBzOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoIkV4cGVjdGVkICclcycgYnV0IGdvdCAnJXMnIiAlIChzLCB0KSkKCiAgICBkZWYgZW1pdChzZWxmLCBvcCwgYXJnPU5vbmUpOgogICAgICAgIHNlbGYuY29kZS5hcHBlbmQoKG9wLCBhcmcpKQogICAg",
    "ICAgIHJldHVybiBsZW4oc2VsZi5jb2RlKSAtIDEKCiAgICBkZWYgcGF0Y2goc2VsZiwgaWR4LCBuZXdfYXJnKToKICAgICAgICBvcCwgXyA9IHNlbGYuY29kZVtpZHhdCiAgICAgICAgc2VsZi5jb2RlW2lkeF0gPSAob3AsIG5ld19hcmcpCgogICAgZGVmIG5ld190bXAoc2VsZiwgcHJlZml4PSJfX3RtcCIpOgogICAgICAgIHNlbGYuX3RtcF9jb3VudGVyICs9IDEKICAgICAgICByZXR1cm4gIiVzJWQiICUgKHByZWZpeCwgc2VsZi5fdG1wX2NvdW50ZXIpCgogICAgZGVmIGNvbXBpbGUoc2VsZik6CiAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXNldCgpKQogICAgICAgIHNlbGYuZW1pdChPUF9FTkQsIE5vbmUpCiAgICAgICAgcmV0dXJuIHNlbGYuY29kZQoKICAgIGRlZiBjb21waWxlX3N0bXRzKHNlbGYsIHRlcm1pbmF0b3JzKToKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0ID0gc2VsZi5wZWVrKCkKICAgICAgICAgICAgaWYgdCBpcyBOb25lIG9yIHQgaW4gdGVybWluYXRvcnM6CiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIHQgPT0gIjsiOgogICAgICAgICAgICAgICAgc2VsZi5wb3AoKQog",
    "ICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIHQgPT0gImlmIjoKICAgICAgICAgICAgICAgIHNlbGYuY29tcGlsZV9pZigpCiAgICAgICAgICAgIGVsaWYgdCA9PSAid2hpbGUiOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX3doaWxlKCkKICAgICAgICAgICAgZWxpZiB0ID09ICJmb3IiOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX2ZvcigpCiAgICAgICAgICAgIGVsaWYgdCA9PSAiZm9yZWFjaCI6CiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfZm9yZWFjaCgpCiAgICAgICAgICAgIGVsaWYgdCA9PSAiYnJlYWsiOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX2JyZWFrKCkKICAgICAgICAgICAgICAgIHNlbGYuZW1pdChPUF9FWEVDUSwgTm9uZSkgICMgYm91bmRhcnkKICAgICAgICAgICAgZWxpZiB0ID09ICJjb250aW51ZSI6CiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfY29udGludWUoKQogICAgICAgICAgICAgICAgc2VsZi5lbWl0KE9QX0VYRUNRLCBOb25lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX2NoYWluKHN0b3BfdG9rZW5zPXRlcm1pbmF0",
    "b3JzKQoKICAgICAgICAgICAgaWYgc2VsZi5wZWVrKCkgPT0gIjsiOgogICAgICAgICAgICAgICAgc2VsZi5wb3AoKQoKICAgICMgLS0tLSBpZiAvIHdoaWxlIC8gZm9yIC8gZm9yZWFjaCAtLS0tCiAgICBkZWYgY29tcGlsZV9pZihzZWxmKToKICAgICAgICBzZWxmLmV4cGVjdCgiaWYiKQogICAgICAgIHNlbGYuY29tcGlsZV9waXBlbGluZShzdG9wX3Rva2Vucz17InRoZW4ifSkKICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAganpfaWR4ID0gc2VsZi5lbWl0KE9QX0paLCBOb25lKQoKICAgICAgICBzZWxmLmV4cGVjdCgidGhlbiIpCiAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXsiZWxzZSIsICJmaSJ9KQoKICAgICAgICBpZiBzZWxmLnBlZWsoKSA9PSAiZWxzZSI6CiAgICAgICAgICAgIGptcF9lbmQgPSBzZWxmLmVtaXQoT1BfSk1QLCBOb25lKQogICAgICAgICAgICBzZWxmLmV4cGVjdCgiZWxzZSIpCiAgICAgICAgICAgIHNlbGYucGF0Y2goanpfaWR4LCBsZW4oc2VsZi5jb2RlKSkKICAgICAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXsiZmkifSkKICAgICAgICAgICAgc2Vs",
    "Zi5leHBlY3QoImZpIikKICAgICAgICAgICAgc2VsZi5wYXRjaChqbXBfZW5kLCBsZW4oc2VsZi5jb2RlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmV4cGVjdCgiZmkiKQogICAgICAgICAgICBzZWxmLnBhdGNoKGp6X2lkeCwgbGVuKHNlbGYuY29kZSkpCgogICAgZGVmIGNvbXBpbGVfd2hpbGUoc2VsZik6CiAgICAgICAgc2VsZi5leHBlY3QoIndoaWxlIikKICAgICAgICBsb29wX3N0YXJ0ID0gbGVuKHNlbGYuY29kZSkKCiAgICAgICAgc2VsZi5jb21waWxlX3BpcGVsaW5lKHN0b3BfdG9rZW5zPXsiZG8ifSkKICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAganpfZXhpdCA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKCiAgICAgICAgc2VsZi5leHBlY3QoImRvIikKICAgICAgICBjdHggPSB7InN0YXJ0IjogbG9vcF9zdGFydCwgImJyZWFrX2ptcHMiOiBbXX0KICAgICAgICBzZWxmLmxvb3Bfc3RhY2suYXBwZW5kKGN0eCkKCiAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXsiZG9uZSJ9KQogICAgICAgIHNlbGYuZXhwZWN0KCJkb25lIikKCiAgICAgICAgc2VsZi5lbWl0KE9QX0pNUCwgbG9v",
    "cF9zdGFydCkKCiAgICAgICAgZXhpdF90YXJnZXQgPSBsZW4oc2VsZi5jb2RlKQogICAgICAgIHNlbGYucGF0Y2goanpfZXhpdCwgZXhpdF90YXJnZXQpCiAgICAgICAgZm9yIGppZHggaW4gY3R4WyJicmVha19qbXBzIl06CiAgICAgICAgICAgIHNlbGYucGF0Y2goamlkeCwgZXhpdF90YXJnZXQpCiAgICAgICAgc2VsZi5sb29wX3N0YWNrLnBvcCgpCgogICAgZGVmIGNvbXBpbGVfZm9yKHNlbGYpOgogICAgICAgICMgZm9yIGkgMSAxMCBbc3RlcF0gZG8gLi4uIGRvbmUKICAgICAgICBzZWxmLmV4cGVjdCgiZm9yIikKICAgICAgICB2YXIgPSBzZWxmLnBvcCgpCiAgICAgICAgaWYgbm90IHZhcjoKICAgICAgICAgICAgcmFpc2UgQ29tcGlsZUVycm9yKCJmb3I6IG1pc3NpbmcgdmFyaWFibGUgbmFtZSIpCgogICAgICAgIHN0YXJ0ID0gc2VsZi5wb3AoKQogICAgICAgIGVuZCA9IHNlbGYucG9wKCkKICAgICAgICBpZiBzdGFydCBpcyBOb25lIG9yIGVuZCBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImZvcjogbmVlZHMgc3RhcnQgYW5kIGVuZCIpCgogICAgICAgIHN0ZXAgPSBOb25lCiAgICAgICAgaWYgc2VsZi5wZWVrKCkgIT0g",
    "ImRvIjoKICAgICAgICAgICAgc3RlcCA9IHNlbGYucG9wKCkKICAgICAgICBpZiBzZWxmLnBlZWsoKSAhPSAiZG8iOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImZvcjogZXhwZWN0ZWQgJ2RvJyIpCgogICAgICAgICMgaW5pdCB2YXI9c3RhcnQKICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCBzdGFydCkKICAgICAgICBzZWxmLmVtaXQoT1BfU0VULCB2YXIpCgogICAgICAgIGxvb3Bfc3RhcnQgPSBsZW4oc2VsZi5jb2RlKQoKICAgICAgICAjIGNvbmRpdGlvbiB1c2luZyB0ZXN0OgogICAgICAgIGNtcG9wID0gIi1sZSIKICAgICAgICBpZiBzdGVwIGlzIG5vdCBOb25lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBpbnQoc3RyKHN0ZXApLnN0cmlwKCkpIDwgMDoKICAgICAgICAgICAgICAgICAgICBjbXBvcCA9ICItZ2UiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBjbXBvcCA9ICItbGUiCgogICAgICAgIHNlbGYuZW1pdChPUF9MT0FELCAidGVzdCIpCiAgICAgICAgc2VsZi5lbWl0KE9QX0dFVCwgdmFyKQogICAgICAgIHNlbGYuZW1pdChPUF9BUkcsIGNtcG9wKQogICAgICAgIHNl",
    "bGYuZW1pdChPUF9BUkcsIGVuZCkKICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAganpfZXhpdCA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKCiAgICAgICAgc2VsZi5leHBlY3QoImRvIikKCiAgICAgICAgY3R4ID0geyJzdGFydCI6IGxvb3Bfc3RhcnQsICJicmVha19qbXBzIjogW119CiAgICAgICAgc2VsZi5sb29wX3N0YWNrLmFwcGVuZChjdHgpCgogICAgICAgIHNlbGYuY29tcGlsZV9zdG10cyh0ZXJtaW5hdG9ycz17ImRvbmUifSkKICAgICAgICBzZWxmLmV4cGVjdCgiZG9uZSIpCgogICAgICAgIGlmIHN0ZXAgaXMgTm9uZToKICAgICAgICAgICAgc3RlcCA9ICIxIgogICAgICAgICMgaW5jcmVtZW50IHZhciBieSBzdGVwIChxdWlldCkKICAgICAgICBzZWxmLmVtaXQoT1BfTE9BRCwgImFkZHYiKQogICAgICAgIHNlbGYuZW1pdChPUF9BUkcsIHZhcikKICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCBzdGVwKQogICAgICAgIHNlbGYuZW1pdChPUF9FWEVDUSwgTm9uZSkKCiAgICAgICAgc2VsZi5lbWl0KE9QX0pNUCwgbG9vcF9zdGFydCkKCiAgICAgICAgZXhpdF90YXJnZXQgPSBsZW4oc2VsZi5jb2RlKQogICAgICAgIHNl",
    "bGYucGF0Y2goanpfZXhpdCwgZXhpdF90YXJnZXQpCiAgICAgICAgZm9yIGppZHggaW4gY3R4WyJicmVha19qbXBzIl06CiAgICAgICAgICAgIHNlbGYucGF0Y2goamlkeCwgZXhpdF90YXJnZXQpCiAgICAgICAgc2VsZi5sb29wX3N0YWNrLnBvcCgpCgogICAgZGVmIGNvbXBpbGVfZm9yZWFjaChzZWxmKToKICAgICAgICAjIGZvcmVhY2ggdiBpbiBhIGIgYyBkbyAuLi4gZG9uZQogICAgICAgICMgZm9yZWFjaCB2IGluIDxwaXBlbGluZT4gZG8gLi4uIGRvbmUgICAoc3BsaXQgcGlwZWxpbmUgb3V0cHV0IGJ5IGxpbmVzKQogICAgICAgIHNlbGYuZXhwZWN0KCJmb3JlYWNoIikKICAgICAgICB2YXIgPSBzZWxmLnBvcCgpCiAgICAgICAgaWYgbm90IHZhcjoKICAgICAgICAgICAgcmFpc2UgQ29tcGlsZUVycm9yKCJmb3JlYWNoOiBtaXNzaW5nIHZhcmlhYmxlIG5hbWUiKQogICAgICAgIHNlbGYuZXhwZWN0KCJpbiIpCgogICAgICAgIGxpc3RfdmFyID0gc2VsZi5uZXdfdG1wKCJfX2ZvcmVhY2hfbGlzdF8iKQoKICAgICAgICBjb2xsZWN0ZWQgPSBbXQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgICAgICBp",
    "ZiB0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImZvcmVhY2g6IG1pc3NpbmcgJ2RvJyIpCiAgICAgICAgICAgIGlmIHQgPT0gImRvIjoKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGNvbGxlY3RlZC5hcHBlbmQoc2VsZi5wb3AoKSkKCiAgICAgICAgaWYgInwiIGluIGNvbGxlY3RlZDoKICAgICAgICAgICAgc3ViID0gQ29tcGlsZXIoY29sbGVjdGVkKQogICAgICAgICAgICBzdWIuY29tcGlsZV9waXBlbGluZShzdG9wX3Rva2Vucz1zZXQoKSkKICAgICAgICAgICAgc2VsZi5jb2RlLmV4dGVuZChzdWIuY29kZSkKICAgICAgICAgICAgc2VsZi5lbWl0KE9QX0VYRUNRLCBOb25lKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfU1BMSVRMLCBsaXN0X3ZhcikKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmVtaXQoT1BfU0VUTElTVCwgKGxpc3RfdmFyLCBjb2xsZWN0ZWQpKQoKICAgICAgICBzZWxmLmV4cGVjdCgiZG8iKQoKICAgICAgICBzZWxmLmVtaXQoT1BfRk9SRV9JTklULCAodmFyLCBsaXN0X3ZhcikpCiAgICAgICAgbG9vcF9zdGFydCA9IGxlbihzZWxmLmNvZGUpCiAgICAgICAgZm9yZV9u",
    "ZXh0ID0gc2VsZi5lbWl0KE9QX0ZPUkVfTkVYVCwgTm9uZSkgICMgcGF0Y2hlZCB0byBleGl0CgogICAgICAgIGN0eCA9IHsic3RhcnQiOiBsb29wX3N0YXJ0LCAiYnJlYWtfam1wcyI6IFtdfQogICAgICAgIHNlbGYubG9vcF9zdGFjay5hcHBlbmQoY3R4KQoKICAgICAgICBzZWxmLmNvbXBpbGVfc3RtdHModGVybWluYXRvcnM9eyJkb25lIn0pCiAgICAgICAgc2VsZi5leHBlY3QoImRvbmUiKQoKICAgICAgICBzZWxmLmVtaXQoT1BfSk1QLCBsb29wX3N0YXJ0KQoKICAgICAgICBleGl0X3RhcmdldCA9IGxlbihzZWxmLmNvZGUpCiAgICAgICAgc2VsZi5wYXRjaChmb3JlX25leHQsIGV4aXRfdGFyZ2V0KQogICAgICAgIGZvciBqaWR4IGluIGN0eFsiYnJlYWtfam1wcyJdOgogICAgICAgICAgICBzZWxmLnBhdGNoKGppZHgsIGV4aXRfdGFyZ2V0KQogICAgICAgIHNlbGYubG9vcF9zdGFjay5wb3AoKQoKICAgIGRlZiBjb21waWxlX2JyZWFrKHNlbGYpOgogICAgICAgIHNlbGYuZXhwZWN0KCJicmVhayIpCiAgICAgICAgaWYgbm90IHNlbGYubG9vcF9zdGFjazoKICAgICAgICAgICAgcmFpc2UgQ29tcGlsZUVycm9yKCJicmVhayB1c2VkIG91dHNpZGUgb2Yg",
    "YSBsb29wIikKICAgICAgICBqaWR4ID0gc2VsZi5lbWl0KE9QX0pNUCwgTm9uZSkKICAgICAgICBzZWxmLmxvb3Bfc3RhY2tbLTFdWyJicmVha19qbXBzIl0uYXBwZW5kKGppZHgpCgogICAgZGVmIGNvbXBpbGVfY29udGludWUoc2VsZik6CiAgICAgICAgc2VsZi5leHBlY3QoImNvbnRpbnVlIikKICAgICAgICBpZiBub3Qgc2VsZi5sb29wX3N0YWNrOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImNvbnRpbnVlIHVzZWQgb3V0c2lkZSBvZiBhIGxvb3AiKQogICAgICAgIHNlbGYuZW1pdChPUF9KTVAsIHNlbGYubG9vcF9zdGFja1stMV1bInN0YXJ0Il0pCgogICAgIyAtLS0tICYmIC8gfHwgY2hhaW5zICsgcmVkaXJlY3Rpb24gLS0tLQogICAgZGVmIGNvbXBpbGVfY2hhaW4oc2VsZiwgc3RvcF90b2tlbnMpOgogICAgICAgICMgYXNzaWdubWVudCBsaWtlIHg9MwogICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgIGlmIHQgaXMgbm90IE5vbmUgYW5kICgiPSIgaW4gdCkgYW5kIChub3QgdC5zdGFydHN3aXRoKCIkIikpIGFuZCAodCAhPSAifCIpOgogICAgICAgICAgICBuYW1lLCB2YWwgPSB0LnNwbGl0KCI9IiwgMSkKICAgICAgICAgICAg",
    "c2VsZi5wb3AoKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCB2YWwpCiAgICAgICAgICAgIHNlbGYuZW1pdChPUF9TRVQsIG5hbWUpCiAgICAgICAgICAgICMgdXBkYXRlIGxhc3RfdHJ1dGggcXVpZXRseSBiYXNlZCBvbiB2YWx1ZQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfTE9BRCwgImVjaG8iKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfR0VULCBuYW1lKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5jb21waWxlX3BpcGVsaW5lKHN0b3BfdG9rZW5zPXN0b3BfdG9rZW5zLnVuaW9uKHsiJiYiLCAifHwiLCAiPiIsICI+PiJ9KSkKICAgICAgICAgICAgc2VsZi5jb21waWxlX3JlZGlyZWN0aW9uX2lmX3ByZXNlbnQoKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQywgTm9uZSkKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgb3AgPSBzZWxmLnBlZWsoKQogICAgICAgICAgICBpZiBvcCBub3QgaW4gKCImJiIsICJ8fCIpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHNlbGYucG9wKCkKCiAgICAgICAgICAgIGlmIG9wID09ICIm",
    "JiI6CiAgICAgICAgICAgICAgICBza2lwX3JocyA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYuY29tcGlsZV9waXBlbGluZShzdG9wX3Rva2Vucz1zdG9wX3Rva2Vucy51bmlvbih7IiYmIiwgInx8IiwgIj4iLCAiPj4ifSkpCiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfcmVkaXJlY3Rpb25faWZfcHJlc2VudCgpCiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQywgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYucGF0Y2goc2tpcF9yaHMsIGxlbihzZWxmLmNvZGUpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcnVuX3JocyA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKICAgICAgICAgICAgICAgIHNraXBfcmhzID0gc2VsZi5lbWl0KE9QX0pNUCwgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYucGF0Y2gocnVuX3JocywgbGVuKHNlbGYuY29kZSkpCiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfcGlwZWxpbmUoc3RvcF90b2tlbnM9c3RvcF90b2tlbnMudW5pb24oeyImJiIsICJ8fCIsICI+IiwgIj4+In0pKQogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX3JlZGlyZWN0aW9u",
    "X2lmX3ByZXNlbnQoKQogICAgICAgICAgICAgICAgc2VsZi5lbWl0KE9QX0VYRUMsIE5vbmUpCiAgICAgICAgICAgICAgICBzZWxmLnBhdGNoKHNraXBfcmhzLCBsZW4oc2VsZi5jb2RlKSkKCiAgICBkZWYgY29tcGlsZV9yZWRpcmVjdGlvbl9pZl9wcmVzZW50KHNlbGYpOgogICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgIGlmIHQgbm90IGluICgiPiIsICI+PiIpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBvcCA9IHNlbGYucG9wKCkKICAgICAgICBmbmFtZSA9IHNlbGYucG9wKCkKICAgICAgICBpZiBmbmFtZSBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoInJlZGlyZWN0aW9uIG1pc3NpbmcgZmlsZW5hbWUiKQogICAgICAgIHNlbGYuZW1pdChPUF9QSVBFLCBOb25lKQogICAgICAgIHNlbGYuZW1pdChPUF9MT0FELCAiYXBwZW5kIiBpZiBvcCA9PSAiPj4iIGVsc2UgIndyaXRlIikKICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCBmbmFtZSkKCiAgICAjIC0tLS0gcGlwZWxpbmVzIC0tLS0KICAgIGRlZiBjb21waWxlX3BpcGVsaW5lKHNlbGYsIHN0b3BfdG9rZW5zKToKICAgICAgICBleHBlY3RpbmdfY21kID0gVHJ1",
    "ZQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgICAgICBpZiB0IGlzIE5vbmUgb3IgdCBpbiBzdG9wX3Rva2VucyBvciB0ID09ICI7IjoKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgaWYgdCA9PSAifCI6CiAgICAgICAgICAgICAgICBzZWxmLnBvcCgpCiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfUElQRSwgTm9uZSkKICAgICAgICAgICAgICAgIGV4cGVjdGluZ19jbWQgPSBUcnVlCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgc2VsZi5wb3AoKQoKICAgICAgICAgICAgaWYgdC5zdGFydHN3aXRoKCIkIikgYW5kIGxlbih0KSA+IDE6CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfR0VULCB0WzE6XSkKICAgICAgICAgICAgICAgIGV4cGVjdGluZ19jbWQgPSBGYWxzZQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIGV4cGVjdGluZ19jbWQ6CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfTE9BRCwgdCkKICAgICAgICAgICAgICAgIGV4cGVjdGluZ19jbWQgPSBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAg",
    "ICAgICAgc2VsZi5lbWl0KE9QX0FSRywgdCkKCmRlZiBjb21waWxlX2xpbmUobGluZSk6CiAgICB0b2tzID0gdG9rZW5pemUobGluZS5zdHJpcCgpKQogICAgYmcgPSBGYWxzZQogICAgaWYgdG9rcyBhbmQgdG9rc1stMV0gPT0gIiYiOgogICAgICAgIGJnID0gVHJ1ZQogICAgICAgIHRva3MgPSB0b2tzWzotMV0KICAgIGMgPSBDb21waWxlcih0b2tzKQogICAgcmV0dXJuIGMuY29tcGlsZSgpLCBiZwoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIENvb3BlcmF0aXZlIGpvYiBzeXN0ZW0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFzcyBKb2I6CiAgICBfX3Nsb3RzX18gPSAoImppZCIsICJuYW1lIiwgImdlbiIsICJkb25lIiwgImVycm9yIikKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBqaWQsIG5hbWUsIGdlbik6CiAgICAgICAgc2VsZi5qaWQgPSBqaWQKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5nZW4gPSBnZW4KICAgICAgICBzZWxmLmRvbmUgPSBGYWxzZQogICAgICAgIHNlbGYuZXJyb3IgPSBOb25lCgogICAgZGVmIHN0ZXAoc2VsZiwgbj0xKToKICAgICAgICBpZiBzZWxmLmRvbmU6CiAgICAgICAgICAgIHJldHVy",
    "bgogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2Uobik6CiAgICAgICAgICAgICAgICBuZXh0KHNlbGYuZ2VuKQogICAgICAgIGV4Y2VwdCBTdG9wSXRlcmF0aW9uOgogICAgICAgICAgICBzZWxmLmRvbmUgPSBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmRvbmUgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZXJyb3IgPSBlCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgVk0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFzcyBWTToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb21tYW5kcz1Ob25lLCBzcG9vbF9wYXRoPSJTVERPVVQiLCBzcG9vbF90aHJlc2hvbGQ9MjA0OCk6CiAgICAgICAgc2VsZi50b2tlbl9zdGFjayA9IFtdCiAgICAgICAgc2VsZi52YWx1ZV9zdGFjayA9IFtdCiAgICAgICAgc2VsZi52YXJzID0ge30KICAgICAgICBzZWxmLnBjID0gMAogICAgICAgIHNlbGYuY29kZSA9IFtdCiAgICAgICAgc2VsZi5jb21tYW5kcyA9IGNvbW1hbmRzIG9yIHt9CgogICAgICAgIHNlbGYubGFzdF9vdXRwdXQgPSAiIgogICAgICAgIHNlbGYubGFzdF90cnV0aCA9IEZhbHNl",
    "CgogICAgICAgIHNlbGYuc3Bvb2xfcGF0aCA9IHNwb29sX3BhdGgKICAgICAgICBzZWxmLnNwb29sX3RocmVzaG9sZCA9IHNwb29sX3RocmVzaG9sZAoKICAgICAgICBzZWxmLl9mb3JlYWNoX3N0YWNrID0gW10gICMgKHZhcm5hbWUsIGl0ZXJhdG9yKQoKICAgICAgICAjIGpvYnMKICAgICAgICBzZWxmLmpvYnMgPSB7fQogICAgICAgIHNlbGYubmV4dF9qaWQgPSAxCgogICAgICAgICMgc2NoZWR1bGVyLXNhZmUgc2xlZXAgc3RhdGUKICAgICAgICBzZWxmLnNsZWVwX3VudGlsID0gTm9uZQoKICAgIGRlZiBjbG9uZV9mb3Jfam9iKHNlbGYpOgogICAgICAgIGp2bSA9IFZNKGNvbW1hbmRzPXNlbGYuY29tbWFuZHMsIHNwb29sX3BhdGg9c2VsZi5zcG9vbF9wYXRoLCBzcG9vbF90aHJlc2hvbGQ9c2VsZi5zcG9vbF90aHJlc2hvbGQpCiAgICAgICAganZtLnZhcnMgPSBkaWN0KHNlbGYudmFycykKICAgICAgICByZXR1cm4ganZtCgogICAgZGVmIHRydXRoeShzZWxmLCBzKToKICAgICAgICBpZiBzIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHR4dCA9IHN0cihzKS5zdHJpcCgpCiAgICAgICAgaWYgdHh0ID09ICIiOgogICAgICAg",
    "ICAgICByZXR1cm4gRmFsc2UKICAgICAgICBsb3cgPSB0eHQubG93ZXIoKQogICAgICAgIHJldHVybiBsb3cgbm90IGluICgiMCIsICJmYWxzZSIsICJubyIsICJuaWwiKQoKICAgIGRlZiBfbWF5YmVfc3Bvb2woc2VsZiwgb3V0KToKICAgICAgICBpZiBvdXQgaXMgTm9uZToKICAgICAgICAgICAgcyA9ICIiCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKG91dCwgc3RyKToKICAgICAgICAgICAgcyA9IG91dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHMgPSBzdHIob3V0KQoKICAgICAgICBpZiBzZWxmLnNwb29sX3RocmVzaG9sZCBhbmQgbGVuKHMpID49IHNlbGYuc3Bvb2xfdGhyZXNob2xkOgogICAgICAgICAgICB3aXRoIG9wZW4oc2VsZi5zcG9vbF9wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKHMpCiAgICAgICAgICAgIHJldHVybiBQaXBlRGF0YShwYXRoPXNlbGYuc3Bvb2xfcGF0aCwgaXNfZmlsZT1UcnVlKQoKICAgICAgICByZXR1cm4gUGlwZURhdGEodGV4dD1zLCBpc19maWxlPUZhbHNlKQoKICAgIGRlZiBydW4oc2VsZiwgdHJhY2U9RmFsc2UpOgogICAgICAgIHNlbGYucGMgPSAwCiAgICAgICAgd2hpbGUgc2VsZi5w",
    "YyA8IGxlbihzZWxmLmNvZGUpOgogICAgICAgICAgICAjIEZvcmVncm91bmQgc2xlZXA6IGJsb2NrLCBidXQga2VlcCBiYWNrZ3JvdW5kIGpvYnMgYWxpdmUuCiAgICAgICAgICAgIGlmIHNlbGYuc2xlZXBfdW50aWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB3aGlsZSBfdGlja3NfZGlmZihzZWxmLnNsZWVwX3VudGlsLCBfdGlja3NfbXMoKSkgPiAwOgogICAgICAgICAgICAgICAgICAgIHNlbGYucG9sbF9qb2JzKHN0ZXBzPTgwKQogICAgICAgICAgICAgICAgICAgIF9zbGVlcF9tcygyMCkKICAgICAgICAgICAgICAgIHNlbGYuc2xlZXBfdW50aWwgPSBOb25lCgogICAgICAgICAgICBvcCwgYXJnID0gc2VsZi5jb2RlW3NlbGYucGNdCiAgICAgICAgICAgIHNlbGYucGMgKz0gMQoKICAgICAgICAgICAgaWYgdHJhY2U6CiAgICAgICAgICAgICAgICBwcmludCgiUEMiLCBzZWxmLnBjLTEsICJPUCIsIG9wLCAiQVJHIiwgYXJnKQoKICAgICAgICAgICAgaWYgb3AgPT0gT1BfTE9BRDoKICAgICAgICAgICAgICAgIHNlbGYudG9rZW5fc3RhY2suYXBwZW5kKCgiY21kIiwgYXJnKSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfQVJHOgogICAgICAg",
    "ICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJhcmciLCBhcmcpKQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjay5hcHBlbmQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9QSVBFOgogICAgICAgICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJwaXBlIiwgTm9uZSkpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVDoKICAgICAgICAgICAgICAgIHZhbCA9IHNlbGYudmFsdWVfc3RhY2sucG9wKCkgaWYgc2VsZi52YWx1ZV9zdGFjayBlbHNlICIiCiAgICAgICAgICAgICAgICBzZWxmLnZhcnNbYXJnXSA9IHZhbAoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9HRVQ6CiAgICAgICAgICAgICAgICB2YWwgPSBzZWxmLnZhcnMuZ2V0KGFyZywgIiIpCiAgICAgICAgICAgICAgICBzZWxmLnRva2VuX3N0YWNrLmFwcGVuZCgoImFyZyIsIHZhbCkpCiAgICAgICAgICAgICAgICBzZWxmLnZhbHVlX3N0YWNrLmFwcGVuZCh2YWwpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VYRUMgb3Igb3AgPT0gT1BfRVhFQ1E6CiAgICAgICAgICAgICAgICBvdXQgPSBzZWxmLmV4ZWNfcGlwZWxpbmUoKQogICAgICAg",
    "ICAgICAgICAgc2VsZi5sYXN0X291dHB1dCA9IG91dAogICAgICAgICAgICAgICAgc2VsZi5sYXN0X3RydXRoID0gc2VsZi50cnV0aHkob3V0KQogICAgICAgICAgICAgICAgaWYgb3AgPT0gT1BfRVhFQyBhbmQgb3V0IGlzIG5vdCBOb25lIGFuZCBvdXQgIT0gIiI6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQob3V0KQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjayA9IFtdCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0pNUDoKICAgICAgICAgICAgICAgIHNlbGYucGMgPSBpbnQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9KWjoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmxhc3RfdHJ1dGg6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVExJU1Q6CiAgICAgICAgICAgICAgICBuYW1lLCBpdGVtcyA9IGFyZwogICAgICAgICAgICAgICAgc2VsZi52YXJzW25hbWVdID0gbGlzdChpdGVtcykKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfU1BMSVRMOgogICAgICAgICAgICAgICAgcyA9ICIiIGlmIHNlbGYubGFzdF9vdXRwdXQgaXMgTm9uZSBl",
    "bHNlIHN0cihzZWxmLmxhc3Rfb3V0cHV0KQogICAgICAgICAgICAgICAgc2VsZi52YXJzW2FyZ10gPSBzLnNwbGl0bGluZXMoKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9GT1JFX0lOSVQ6CiAgICAgICAgICAgICAgICB2YXJuYW1lLCBsaXN0bmFtZSA9IGFyZwogICAgICAgICAgICAgICAgaXRlbXMgPSBzZWxmLnZhcnMuZ2V0KGxpc3RuYW1lLCBbXSkKICAgICAgICAgICAgICAgIGlmIGl0ZW1zIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSBbXQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtcywgc3RyKToKICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IGl0ZW1zLnNwbGl0bGluZXMoKQogICAgICAgICAgICAgICAgaXQgPSBpdGVyKGl0ZW1zKQogICAgICAgICAgICAgICAgc2VsZi5fZm9yZWFjaF9zdGFjay5hcHBlbmQoKHZhcm5hbWUsIGl0KSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfRk9SRV9ORVhUOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2ZvcmVhY2hfc3RhY2s6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAg",
    "ICAgICAgICAgICAgIHZhcm5hbWUsIGl0ID0gc2VsZi5fZm9yZWFjaF9zdGFja1stMV0KICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG54dCA9IG5leHQoaXQpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudmFyc1t2YXJuYW1lXSA9IHN0cihueHQpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFN0b3BJdGVyYXRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2ZvcmVhY2hfc3RhY2sucG9wKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VORDoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJVbmtub3duIG9wY29kZTogJXIiICUgb3ApCgogICAgICAgIHJldHVybiBzZWxmLmxhc3Rfb3V0cHV0CgogICAgZGVmIHJ1bl9nZW5lcmF0b3Ioc2VsZik6CiAgICAgICAgIyBDb29wZXJhdGl2ZSBydW5uZXI6IHlpZWxkcyBmcmVxdWVudGx5IHNvIGl0IGNhbiBiZSB1c2VkIGFzIGEgYmFja2dyb3VuZCBqb2IuCiAgICAgICAgc2VsZi5w",
    "YyA9IDAKICAgICAgICB3aGlsZSBzZWxmLnBjIDwgbGVuKHNlbGYuY29kZSk6CiAgICAgICAgICAgICMgQmFja2dyb3VuZCBzbGVlcDogeWllbGQgcXVpY2tseSB1bnRpbCB3YWtlIHRpbWUgKG5vIHJlLWVudHJhbmN5KS4KICAgICAgICAgICAgaWYgc2VsZi5zbGVlcF91bnRpbCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmIF90aWNrc19kaWZmKHNlbGYuc2xlZXBfdW50aWwsIF90aWNrc19tcygpKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgeWllbGQgTm9uZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2xlZXBfdW50aWwgPSBOb25lCgogICAgICAgICAgICBvcCwgYXJnID0gc2VsZi5jb2RlW3NlbGYucGNdCiAgICAgICAgICAgIHNlbGYucGMgKz0gMQoKICAgICAgICAgICAgaWYgb3AgPT0gT1BfTE9BRDoKICAgICAgICAgICAgICAgIHNlbGYudG9rZW5fc3RhY2suYXBwZW5kKCgiY21kIiwgYXJnKSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfQVJHOgogICAgICAgICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJhcmciLCBhcmcp",
    "KQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjay5hcHBlbmQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9QSVBFOgogICAgICAgICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJwaXBlIiwgTm9uZSkpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVDoKICAgICAgICAgICAgICAgIHZhbCA9IHNlbGYudmFsdWVfc3RhY2sucG9wKCkgaWYgc2VsZi52YWx1ZV9zdGFjayBlbHNlICIiCiAgICAgICAgICAgICAgICBzZWxmLnZhcnNbYXJnXSA9IHZhbAoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9HRVQ6CiAgICAgICAgICAgICAgICB2YWwgPSBzZWxmLnZhcnMuZ2V0KGFyZywgIiIpCiAgICAgICAgICAgICAgICBzZWxmLnRva2VuX3N0YWNrLmFwcGVuZCgoImFyZyIsIHZhbCkpCiAgICAgICAgICAgICAgICBzZWxmLnZhbHVlX3N0YWNrLmFwcGVuZCh2YWwpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VYRUMgb3Igb3AgPT0gT1BfRVhFQ1E6CiAgICAgICAgICAgICAgICBvdXQgPSBzZWxmLmV4ZWNfcGlwZWxpbmUoKQogICAgICAgICAgICAgICAgc2VsZi5sYXN0X291dHB1dCA9IG91dAogICAgICAgICAgICAg",
    "ICAgc2VsZi5sYXN0X3RydXRoID0gc2VsZi50cnV0aHkob3V0KQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjayA9IFtdCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0pNUDoKICAgICAgICAgICAgICAgIHNlbGYucGMgPSBpbnQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9KWjoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmxhc3RfdHJ1dGg6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVExJU1Q6CiAgICAgICAgICAgICAgICBuYW1lLCBpdGVtcyA9IGFyZwogICAgICAgICAgICAgICAgc2VsZi52YXJzW25hbWVdID0gbGlzdChpdGVtcykKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfU1BMSVRMOgogICAgICAgICAgICAgICAgcyA9ICIiIGlmIHNlbGYubGFzdF9vdXRwdXQgaXMgTm9uZSBlbHNlIHN0cihzZWxmLmxhc3Rfb3V0cHV0KQogICAgICAgICAgICAgICAgc2VsZi52YXJzW2FyZ10gPSBzLnNwbGl0bGluZXMoKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9GT1JFX0lOSVQ6CiAgICAgICAgICAgICAgICB2YXJuYW1lLCBsaXN0bmFt",
    "ZSA9IGFyZwogICAgICAgICAgICAgICAgaXRlbXMgPSBzZWxmLnZhcnMuZ2V0KGxpc3RuYW1lLCBbXSkKICAgICAgICAgICAgICAgIGlmIGl0ZW1zIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSBbXQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtcywgc3RyKToKICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IGl0ZW1zLnNwbGl0bGluZXMoKQogICAgICAgICAgICAgICAgaXQgPSBpdGVyKGl0ZW1zKQogICAgICAgICAgICAgICAgc2VsZi5fZm9yZWFjaF9zdGFjay5hcHBlbmQoKHZhcm5hbWUsIGl0KSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfRk9SRV9ORVhUOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2ZvcmVhY2hfc3RhY2s6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHZhcm5hbWUsIGl0ID0gc2VsZi5fZm9yZWFjaF9zdGFja1stMV0KICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG54dCA9IG5leHQoaXQpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYu",
    "dmFyc1t2YXJuYW1lXSA9IHN0cihueHQpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFN0b3BJdGVyYXRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2ZvcmVhY2hfc3RhY2sucG9wKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VORDoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICB5aWVsZCBOb25lICAjIGNvb3BlcmF0ZSBvZnRlbgoKICAgIGRlZiBleGVjX3BpcGVsaW5lKHNlbGYpOgogICAgICAgIGl0ZW1zID0gc2VsZi50b2tlbl9zdGFjawogICAgICAgIHNlbGYudG9rZW5fc3RhY2sgPSBbXQoKICAgICAgICBwaXBlbGluZSA9IFtdCiAgICAgICAgY3VycmVudF9jbWQgPSBOb25lCiAgICAgICAgY3VycmVudF9hcmdzID0gW10KCiAgICAgICAgZGVmIGZsdXNoKCk6CiAgICAgICAgICAgIG5vbmxvY2FsIGN1cnJlbnRfY21kLCBjdXJyZW50X2FyZ3MKICAgICAgICAgICAgaWYgY3VycmVudF9jbWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBwaXBlbGluZS5hcHBlbmQoKGN1cnJlbnRfY21kLCBjdXJyZW50X2FyZ3MpKQogICAg",
    "ICAgICAgICBjdXJyZW50X2NtZCA9IE5vbmUKICAgICAgICAgICAgY3VycmVudF9hcmdzID0gW10KCiAgICAgICAgZm9yIGtpbmQsIHZhbCBpbiBpdGVtczoKICAgICAgICAgICAgaWYga2luZCA9PSAicGlwZSI6CiAgICAgICAgICAgICAgICBmbHVzaCgpCiAgICAgICAgICAgIGVsaWYga2luZCA9PSAiY21kIjoKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfY21kIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGZsdXNoKCkKICAgICAgICAgICAgICAgIGN1cnJlbnRfY21kID0gdmFsCiAgICAgICAgICAgIGVsaWYga2luZCA9PSAiYXJnIjoKICAgICAgICAgICAgICAgIGN1cnJlbnRfYXJncy5hcHBlbmQodmFsKQoKICAgICAgICBmbHVzaCgpCgogICAgICAgIG91dCA9IFBpcGVEYXRhKHRleHQ9IiIsIGlzX2ZpbGU9RmFsc2UpCiAgICAgICAgZm9yIGNtZCwgYXJncyBpbiBwaXBlbGluZToKICAgICAgICAgICAgb3V0X3JhdyA9IHNlbGYucnVuX2NvbW1hbmQoY21kLCBhcmdzLCBvdXQpCiAgICAgICAgICAgIG91dCA9IHNlbGYuX21heWJlX3Nwb29sKG91dF9yYXcpCgogICAgICAgIHJldHVybiBvdXQuYXNfdGV4dCgpCgogICAgZGVmIHJ1bl9j",
    "b21tYW5kKHNlbGYsIGNtZCwgYXJncywgaW5wdXRfZGF0YSk6CiAgICAgICAgZ2xvYmFsIF9DVVJSRU5UX1ZNCiAgICAgICAgZm4gPSBzZWxmLmNvbW1hbmRzLmdldChjbWQpCiAgICAgICAgaWYgZm4gaXMgTm9uZToKICAgICAgICAgICAgIyBBdXRvLXJlc29sdmU6IGlmIC9saWIvPGNtZD4ucHkgZXhpc3RzLCB0cmVhdCBpdCBsaWtlOiBydW4gPGNtZD4gPGFyZ3MuLi4+CiAgICAgICAgICAgICMgVGhpcyBtYWtlcyBpbnN0YWxsZWQgbW9kdWxlcyBmZWVsIGxpa2UgYnVpbHQtaW4gY29tbWFuZHMuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxpYl9wYXRoID0gIi9saWIvJXMucHkiICUgY21kCiAgICAgICAgICAgICAgICBvcy5zdGF0KGxpYl9wYXRoKSAgIyBleGlzdHM/CiAgICAgICAgICAgICAgICBydW5mbiA9IHNlbGYuY29tbWFuZHMuZ2V0KCJydW4iKQogICAgICAgICAgICAgICAgaWYgcnVuZm4gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgX0NVUlJFTlRfVk0gPSBzZWxmCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJ1bmZuKFtjbWRdICsgbGlzdChhcmdzKSwgaW5wdXRfZGF0YSkKICAgICAgICAgICAgZXhjZXB0",
    "IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuICJFcnJvcjogY29tbWFuZCBub3QgZm91bmQ6ICVzCiIgJSBjbWQKICAgICAgICBfQ1VSUkVOVF9WTSA9IHNlbGYKICAgICAgICByZXR1cm4gZm4oYXJncywgaW5wdXRfZGF0YSkKCiAgICAjIC0tLS0gam9icyAtLS0tCiAgICBkZWYgc3RhcnRfam9iKHNlbGYsIGNvZGUsIG5hbWUpOgogICAgICAgIGp2bSA9IHNlbGYuY2xvbmVfZm9yX2pvYigpCiAgICAgICAganZtLmNvZGUgPSBjb2RlCiAgICAgICAgamlkID0gc2VsZi5uZXh0X2ppZAogICAgICAgIHNlbGYubmV4dF9qaWQgKz0gMQogICAgICAgIHNlbGYuam9ic1tqaWRdID0gSm9iKGppZCwgbmFtZSwganZtLnJ1bl9nZW5lcmF0b3IoKSkKICAgICAgICByZXR1cm4gamlkCgogICAgZGVmIHBvbGxfam9icyhzZWxmLCBzdGVwcz01MCk6CiAgICAgICAgZGVhZCA9IFtdCiAgICAgICAgZm9yIGppZCwgam9iIGluIHNlbGYuam9icy5pdGVtcygpOgogICAgICAgICAgICBqb2Iuc3RlcChuPXN0ZXBzKQogICAgICAgICAgICBpZiBqb2IuZG9uZToKICAgICAgICAgICAgICAgIGRlYWQuYXBwZW5kKGppZCkKCiAgICAgICAg",
    "Zm9yIGppZCBpbiBkZWFkOgogICAgICAgICAgICBqb2IgPSBzZWxmLmpvYnNbamlkXQogICAgICAgICAgICBpZiBqb2IuZXJyb3I6CiAgICAgICAgICAgICAgICBwcmludCgiW3t9XSB7fSAoZXJyb3I6IHt9KSIuZm9ybWF0KGppZCwgam9iLm5hbWUsIGpvYi5lcnJvcikpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCgiW3t9XSB7fSAoZG9uZSkiLmZvcm1hdChqaWQsIGpvYi5uYW1lKSkKICAgICAgICAgICAgZGVsIHNlbGYuam9ic1tqaWRdCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgc2xlZXAgY29tbWFuZCAoc2NoZWR1bGVyLXNhZmUsIHdvcmtzIGZvciBiZyBqb2JzKQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmRlZiBjbWRfc2xlZXAoYXJncywgaW5wdXRfZGF0YSk6CiAgICBnbG9iYWwgX0NVUlJFTlRfVk0KICAgIGlmIG5vdCBhcmdzOgogICAgICAgIHJldHVybiAiIgoKCmRlZiBjbWRfcnVuKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgIyBydW4gPG1vZHVsZT4gW2FyZ3MuLi5dCiAgICAjIEltcG9ydHMgbW9kdWxlICh0eXBpY2FsbHkgZnJvbSAvbGliKSBhbmQgY2FsbHMgaXRzIG1haW4oYXJndikgaWYgcHJlc2Vu",
    "dC4KICAgICMgYXJndiBpcyBhIGxpc3Qgb2Ygc3RyaW5nczogZS5nLiBbImluc3RhbGwiLCJ1cGluZyJdLgogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICJydW46IHVzYWdlIHJ1biA8bW9kdWxlPiBbYXJncy4uLl1cbiIKICAgIG1vZG5hbWUgPSBhcmdzWzBdCiAgICBhcmd2ID0gW3N0cihhKSBmb3IgYSBpbiBhcmdzWzE6XV0KCmRlZiBjbWRfcmVsb2FkKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgIyByZWxvYWQgPG1vZHVsZT4gW21vZHVsZTIgLi4uXQogICAgIyBSZW1vdmVzIG1vZHVsZXMgZnJvbSBzeXMubW9kdWxlcyBzbyB0aGUgbmV4dCBpbXBvcnQgcGlja3MgdXAgZmlsZSBjaGFuZ2VzLgogICAgIyBVc2VmdWwgd2hlbiBlZGl0aW5nIC9saWIvKi5weSB0b29scyBkdXJpbmcgZGV2ZWxvcG1lbnQuCiAgICBpZiBub3QgYXJnczoKICAgICAgICByZXR1cm4gInJlbG9hZDogdXNhZ2UgcmVsb2FkIDxtb2R1bGU+IFttb2R1bGUyIC4uLl1cbiIKCiAgICByZW1vdmVkID0gW10KICAgIGZvciBuYW1lIGluIGFyZ3M6CiAgICAgICAgbW9kbmFtZSA9IG5hbWUKICAgICAgICBpZiBtb2RuYW1lLmVuZHN3aXRoKCIucHkiKToKICAgICAgICAgICAgbW9k",
    "bmFtZSA9IG1vZG5hbWVbOi0zXQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbW9kbmFtZSBpbiBzeXMubW9kdWxlczoKICAgICAgICAgICAgICAgIGRlbCBzeXMubW9kdWxlc1ttb2RuYW1lXQogICAgICAgICAgICAgICAgcmVtb3ZlZC5hcHBlbmQobW9kbmFtZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgaWYgbm90IHJlbW92ZWQ6CiAgICAgICAgcmV0dXJuICJyZWxvYWQ6IG5vdGhpbmcgdG8gZG9cbiIKICAgIHJldHVybiAicmVsb2FkZWQ6ICIgKyAiICIuam9pbihyZW1vdmVkKSArICJcbiIKCiAgICAjIEFsbG93ICJmb28ucHkiIGFzIG1vZHVsZSBuYW1lCiAgICBpZiBtb2RuYW1lLmVuZHN3aXRoKCIucHkiKToKICAgICAgICBtb2RuYW1lID0gbW9kbmFtZVs6LTNdCgogICAgIyBFbnN1cmUgL2xpYiBpcyBvbiBwYXRoIChNaWNyb1B5dGhvbiB1c3VhbGx5IGluY2x1ZGVzIGl0LCBidXQgbWFrZSBpdCByb2J1c3QpCiAgICB0cnk6CiAgICAgICAgaWYgIi9saWIiIG5vdCBpbiBzeXMucGF0aDoKICAgICAgICAgICAgc3lzLnBhdGguYXBwZW5kKCIvbGliIikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAg",
    "ICAgcGFzcwoKICAgIHRyeToKICAgICAgICBtb2QgPSBfX2ltcG9ydF9fKG1vZG5hbWUpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuICJydW46IGNvdWxkbid0IGltcG9ydCAlcyAoJXMpXG4iICUgKG1vZG5hbWUsIGUpCgogICAgIyBQcmVmZXIgbWFpbihhcmd2KS4gRmFsbGJhY2sgdG8gcnVuKGFyZ3YpLgogICAgZm4gPSBnZXRhdHRyKG1vZCwgIm1haW4iLCBOb25lKQogICAgaWYgZm4gaXMgTm9uZToKICAgICAgICBmbiA9IGdldGF0dHIobW9kLCAicnVuIiwgTm9uZSkKCiAgICBpZiBmbiBpcyBOb25lOgogICAgICAgIHJldHVybiAicnVuOiAlcyBoYXMgbm8gbWFpbihhcmd2KVxuIiAlIG1vZG5hbWUKCiAgICB0cnk6CiAgICAgICAgcmVzID0gZm4oYXJndikKICAgICAgICBpZiByZXMgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgcmV0dXJuIHN0cihyZXMpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuICJydW46IGVycm9yIHJ1bm5pbmcgJXM6ICVzXG4iICUgKG1vZG5hbWUsIGUpCgogICAgdHJ5OgogICAgICAgIHNlY3MgPSBmbG9hdChhcmdzWzBdKQogICAgZXhjZXB0",
    "IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIiIKICAgIG1zID0gaW50KHNlY3MgKiAxMDAwKQogICAgaWYgbXMgPD0gMDoKICAgICAgICByZXR1cm4gIiIKICAgIGlmIF9DVVJSRU5UX1ZNIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuICIiCiAgICBfQ1VSUkVOVF9WTS5zbGVlcF91bnRpbCA9IF90aWNrc19hZGQoX3RpY2tzX21zKCksIG1zKQogICAgcmV0dXJuICIiCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgQ29tbWFuZHMgKFNpZ25hdHVyZTogZm4oYXJncywgaW5wdXRfZGF0YSktPnN0cikKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpkZWYgY21kX2hlbHAoYXJncywgaW5wdXRfZGF0YSk6CiAgICByZXR1cm4gKAogICAgICAgICJQVVNIIHZlcjogIiArIFZFUlNJT04gKyAiXG5cbiIKICAgICAgICAiY29tbWFuZHM6IGV4aXQsIGxzLCB1bmFtZSwgZnJlZSwgZGYsIHB3ZCwgY2F0LCBjcCwgY2QsIG1rZGlyLFxuIgogICAgICAgICJncmVwLCBybWRpciwgZXhlYywgcm0sIGRhdGUsXG4iCiAgICAgICAgInNjYW53aWZpLCBjb25uZWN0LCBpZmNvbmZpZywgZWRpdCwgcmVuYW1lXG4iCiAgICAgICAgImV4dHJhczogZWNobywgdXBwZXIsIHdjLCB0",
    "ZXN0LCB3cml0ZSAoPiksIGFwcGVuZCAoPj4pLCBzbGVlcFxuIgogICAgICAgICJmbG93OiBpZi93aGlsZS9mb3IvZm9yZWFjaCwgYnJlYWsvY29udGludWUsICYmL3x8LCB2YXJzIHg9dmFsICR4LCBqb2JzICZcbiIKICAgICAgICAiam9iY3RsOiBqb2JzLCBraWxsIDxpZD4sIGZnIDxpZD5cbiIKICAgICkKCmRlZiBjbWRfbHMoYXJncywgaW5wdXRfZGF0YSk6CiAgICBwYXRoID0gYXJnc1swXSBpZiBhcmdzIGVsc2UgIiIKICAgIHRyeToKICAgICAgICBpZiBwYXRoOgogICAgICAgICAgICByZXR1cm4gIlxuIi5qb2luKG9zLmxpc3RkaXIocGF0aCkpCiAgICAgICAgcmV0dXJuICJcbiIuam9pbihvcy5saXN0ZGlyKCkpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiU3ludGF4IEVycm9yXG4iCgpkZWYgY21kX3VuYW1lKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgdHJ5OgogICAgICAgIHJldHVybiAiXG4iLmpvaW4ob3MudW5hbWUoKSkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJ1bmFtZSBub3Qgc3VwcG9ydGVkXG4iCgpkZWYgY21kX2ZyZWUoYXJncywgaW5wdXRfZGF0YSk6CiAgICBpZiBnYyBpcyBOb25lOgog",
    "ICAgICAgIHJldHVybiAiZnJlZSBub3Qgc3VwcG9ydGVkXG4iCiAgICByZXR1cm4gc3RyKGdjLm1lbV9mcmVlKCkpCgpkZWYgY21kX2RmKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgdHJ5OgogICAgICAgIHN0ID0gb3Muc3RhdHZmcygiLyIpCiAgICAgICAgdG90YWwgPSBmbG9hdChzdFsyXSkgKiBmbG9hdChzdFswXSkKICAgICAgICB1c2VkICA9IGZsb2F0KHN0WzNdKSAqIGZsb2F0KHN0WzBdKQogICAgICAgIGZyZWUgID0gdG90YWwgLSB1c2VkCiAgICAgICAgcmV0dXJuICJGcmVlOiAlcyBVc2VkOiAlcyBUb3RhbDogJXMiICUgKGZyZWUsIHVzZWQsIHRvdGFsKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gImRmIGVycm9yXG4iCgpkZWYgY21kX3B3ZChhcmdzLCBpbnB1dF9kYXRhKToKICAgIHJldHVybiBvcy5nZXRjd2QoKQoKZGVmIGNtZF9jZChhcmdzLCBpbnB1dF9kYXRhKToKICAgIHBhdGggPSBhcmdzWzBdIGlmIGFyZ3MgZWxzZSAiIgogICAgdHJ5OgogICAgICAgIG9zLmNoZGlyKHBhdGgpCiAgICAgICAgcmV0dXJuIHBhdGgKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJFcnJvci4gQ291bGRuJ3QgY2Rc",
    "biIKCmRlZiBjbWRfY2F0KGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaWYgYXJnczoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihhcmdzWzBdLCAiciIpIGFzIGY6CiAgICAgICAgICAgICAgICByZXR1cm4gZi5yZWFkKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gIkNvdWxkbid0IG9wZW4gZmlsZVxuIgogICAgcmV0dXJuIGlucHV0X2RhdGEuYXNfdGV4dCgpIGlmIGlucHV0X2RhdGEgaXMgbm90IE5vbmUgZWxzZSAiIgoKZGVmIGNtZF93YyhhcmdzLCBpbnB1dF9kYXRhKToKICAgIHRyeToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICB4ID0gMAogICAgICAgICAgICB3aXRoIG9wZW4oYXJnc1swXSwgInIiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIF8gaW4gZjoKICAgICAgICAgICAgICAgICAgICB4ICs9IDEKICAgICAgICAgICAgcmV0dXJuIHN0cih4KSArICJcbiIKICAgICAgICBzID0gaW5wdXRfZGF0YS5hc190ZXh0KCkgaWYgaW5wdXRfZGF0YSBpcyBub3QgTm9uZSBlbHNlICIiCiAgICAgICAgcmV0dXJuIHN0cihsZW4ocy5zcGxpdGxpbmVzKCkpKSArICJcbiIKICAgIGV4Y2VwdCBF",
    "eGNlcHRpb246CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCBvcGVuIGZpbGVcbiIKCmRlZiBjbWRfZ3JlcChhcmdzLCBpbnB1dF9kYXRhKToKICAgIGltcG9ydCByZQogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICIiCiAgICByZ3ggPSBhcmdzWzBdCiAgICBvdXQgPSBbXQogICAgdHJ5OgogICAgICAgIGlmIGxlbihhcmdzKSA+PSAyOgogICAgICAgICAgICB3aXRoIG9wZW4oYXJnc1sxXSwgInIiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBpZiByZS5zZWFyY2gocmd4LCBsaW5lKToKICAgICAgICAgICAgICAgICAgICAgICAgb3V0LmFwcGVuZChsaW5lKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHIgPSBpbnB1dF9kYXRhLm9wZW5fcmVhZGVyKCkgaWYgaW5wdXRfZGF0YSBpcyBub3QgTm9uZSBlbHNlIF9TdHJpbmdMaW5lUmVhZGVyKCIiKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiByOgogICAgICAgICAgICAgICAgICAgIGlmIHJlLnNlYXJjaChyZ3gsIGxpbmUpOgogICAgICAgICAgICAgICAgICAgICAgICBvdXQuYXBwZW5kKGxpbmUpCiAg",
    "ICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICB0cnk6IHIuY2xvc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgcmV0dXJuICIiLmpvaW4ob3V0KQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IHBlcmZvcm0uXG4iCgpkZWYgY21kX2NwKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaWYgbGVuKGFyZ3MpIDwgMjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IGNvcHkuXG4iCiAgICBzcmMsIGRzdCA9IGFyZ3NbMF0sIGFyZ3NbMV0KICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oc3JjLCAiciIpIGFzIGY6CiAgICAgICAgICAgIGRhdGEgPSBmLnJlYWQoKQogICAgICAgIHdpdGggb3Blbihkc3QsICJ3IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShkYXRhKQogICAgICAgIHJldHVybiAiRmlsZSAiICsgc3JjICsgIiBjb3BpZWQuIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IGNvcHkuXG4iCgpkZWYgY21kX3JlbmFtZShhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIGxlbihhcmdzKSA8IDI6CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCByZW5h",
    "bWVcbiIKICAgIHNyYywgZHN0ID0gYXJnc1swXSwgYXJnc1sxXQogICAgdHJ5OgogICAgICAgIG9zLnJlbmFtZShzcmMsIGRzdCkKICAgICAgICByZXR1cm4gc3JjICsgIiByZW5hbWVkLi4iCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3QgcmVuYW1lXG4iCgpkZWYgY21kX21rZGlyKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgbmFtZSA9IGFyZ3NbMF0gaWYgYXJncyBlbHNlICIiCiAgICB0cnk6CiAgICAgICAgb3MubWtkaXIobmFtZSkKICAgICAgICByZXR1cm4gIkRpcmVjdG9yeSAiICsgbmFtZSArICIgY3JlYXRlZC5cbiIKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCBtYWtlIGRpcmVjdG9yeVxuIgoKZGVmIGNtZF9ybWRpcihhcmdzLCBpbnB1dF9kYXRhKToKICAgIG5hbWUgPSBhcmdzWzBdIGlmIGFyZ3MgZWxzZSAiIgogICAgdHJ5OgogICAgICAgIG9zLnJtZGlyKG5hbWUpCiAgICAgICAgcmV0dXJuICJSZW1vdmVkICIgKyBuYW1lICsgIi5cbiIKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCByZW1vdmUgZGlyLlxuIgoKZGVmIGNtZF9ybShh",
    "cmdzLCBpbnB1dF9kYXRhKToKICAgIG5hbWUgPSBhcmdzWzBdIGlmIGFyZ3MgZWxzZSAiIgogICAgdHJ5OgogICAgICAgIG9zLnVubGluayhuYW1lKQogICAgICAgIHJldHVybiAiUmVtb3ZlZCBmaWxlICIgKyBuYW1lICsgIlxuIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IHJlbW92ZSBmaWxlXG4iCgpkZWYgY21kX2RhdGUoYXJncywgaW5wdXRfZGF0YSk6CiAgICBkYXRlVGltZU9iaiA9IHRpbWUubG9jYWx0aW1lKCkKICAgIHllYXIsbW9udGgsZGF5LGhvdXIsbWludSxzZWMsd2RheSx5ZGF5ID0gKGRhdGVUaW1lT2JqKQogICAgcmV0dXJuICIlcy8lcy8lcyAlczolczolcyIgJSAobW9udGgsIGRheSwgeWVhciwgaG91ciwgbWludSwgc2VjKQoKZGVmIGNtZF9leGVjKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgIyBleGVjIG1vZHVsZS5mdW5jKCJhcmciKQogICAgaW1wb3J0IHJlCiAgICBzID0gIiAiLmpvaW4oYXJncykKICAgIGlmICIuIiBub3QgaW4gcyBvciAiKCIgbm90IGluIHMgb3IgIikiIG5vdCBpbiBzOgogICAgICAgIHJldHVybiAiRXJyb3I6IENoZWNrIFN5bnRheFxuIgogICAgdHJ5OgogICAgICAgIG1v",
    "ZHVsZSA9IHJlLnNlYXJjaChyIl4oLio/KVwuIiwgcykuZ3JvdXAoMSkKICAgICAgICByZXN0ID0gc1tsZW4obW9kdWxlKSsxOl0KICAgICAgICBmdW5jID0gcmUuc2VhcmNoKHIiXiguKj8pXCgiLCByZXN0KS5ncm91cCgxKQogICAgICAgIGFyZ3N0ciA9IHJlLnNlYXJjaChyIlwoKC4qPylcKSIsIHJlc3QpLmdyb3VwKDEpCgogICAgICAgIHNjcmlwdCA9IGdldGF0dHIoX19pbXBvcnRfXyhtb2R1bGUpLCBmdW5jKQogICAgICAgIGlmIG5vdCBhcmdzdHI6CiAgICAgICAgICAgIHJldHVybiBzdHIoc2NyaXB0KCkpCiAgICAgICAgYXJnc3RyID0gYXJnc3RyLnJlcGxhY2UoJyInLCAiIikKICAgICAgICByZXR1cm4gc3RyKHNjcmlwdChhcmdzdHIpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkVycm9yOiBDaGVjayBTeW50YXhcbiIKCmRlZiBjbWRfc2NhbndpZmkoYXJncywgaW5wdXRfZGF0YSk6CiAgICBpZiBuZXR3b3JrIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuICJzY2Fud2lmaTogbmV0d29yayBtb2R1bGUgbm90IGF2YWlsYWJsZVxuIgogICAgdHJ5OgogICAgICAgIHdsYW4gPSBuZXR3b3JrLldMQU4obmV0d29yay5TVEFfSUYp",
    "CiAgICAgICAgd2xhbi5hY3RpdmUoVHJ1ZSkKICAgICAgICBuZXRzID0gd2xhbi5zY2FuKCkKICAgICAgICBvdXQgPSBbXQogICAgICAgIGZvciBpIGluIG5ldHM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG91dC5hcHBlbmQoaVswXS5kZWNvZGUoKSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIG91dC5hcHBlbmQoc3RyKGlbMF0pKQogICAgICAgIHJldHVybiAiXG4iLmpvaW4ob3V0KSArICgiXG4iIGlmIG91dCBlbHNlICIiKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IHNjYW4gbmV0d29ya3MuXG4iCgpkZWYgY21kX2Nvbm5lY3QoYXJncywgaW5wdXRfZGF0YSk6CiAgICBpZiBuZXR3b3JrIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuICJjb25uZWN0OiBuZXR3b3JrIG1vZHVsZSBub3QgYXZhaWxhYmxlXG4iCiAgICBwcmludCgiRW50ZXIgU1NJRDogIikKICAgIHNzaWQgPSBpbnB1dCgpCiAgICBwcmludCgiRW50ZXIgd2lmaSBwdzogIikKICAgIHdpZmlwdyA9IGlucHV0KCkKICAgIHRyeToKICAgICAgICBwcmludCgiYXR0ZW1wdGluZyB0byBjb25uZWN0Li5c",
    "biIpCiAgICAgICAgd2xhbiA9IG5ldHdvcmsuV0xBTihuZXR3b3JrLlNUQV9JRikKICAgICAgICB3bGFuLmFjdGl2ZShUcnVlKQogICAgICAgIHdsYW4uY29ubmVjdChzc2lkLCB3aWZpcHcpCiAgICAgICAgdGltZS5zbGVlcCg1KQogICAgICAgIHJldHVybiAiQ2hlY2sgaWZjb25maWcuLlxuIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkVycm9yOiBjb3VsZG4ndCBvYnRhaW4gYWRkcmVzc1xuIgoKZGVmIGNtZF9pZmNvbmZpZyhhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIG5ldHdvcmsgaXMgTm9uZToKICAgICAgICByZXR1cm4gImlmY29uZmlnOiBuZXR3b3JrIG1vZHVsZSBub3QgYXZhaWxhYmxlXG4iCiAgICB0cnk6CiAgICAgICAgd2xhbiA9IG5ldHdvcmsuV0xBTihuZXR3b3JrLlNUQV9JRikKICAgICAgICBzdGF0dXMgPSB3bGFuLmlmY29uZmlnKCkKICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAiXG5JUC4uLi4uLi4uLi4uICIgKyBzdGF0dXNbMF0gKwogICAgICAgICAgICAiXG5ORVRNQVNLLi4uLi4uLiIgKyBzdGF0dXNbMV0gKyAiXG4iICsKICAgICAgICAgICAgIkdBVEVXQVkuLi4uLi4uIiArIHN0YXR1c1syXQog",
    "ICAgICAgICkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCBnZXQgaW50ZXJmYWNlIG9yIGNoZWNrIHN5bnRheC5cbiIKCmRlZiBjbWRfZWRpdChhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIG5vdCBhcmdzOgogICAgICAgIHJldHVybiAiQ291bGRuJ3Qgd3JpdGUgZmlsZVxuIgogICAgcGF0aCA9IGFyZ3NbMF0KICAgIHByaW50KCJFRElUIE1PREUgREVURUNURUQuLi5cbiIpCiAgICBwcmludCgiKEVOVEVSIFNUT1BFRElUIHRvIHN0b3ApXG4iKQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihwYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBsaW5lID0gaW5wdXQoKQogICAgICAgICAgICAgICAgaWYgIlNUT1BFRElUIiBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBmLndyaXRlKGxpbmUgKyAiXG4iKQogICAgICAgIHJldHVybiAiRmlsZSAiICsgcGF0aCArICIgY3JlYXRlZC4uXG4iCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3Qgd3JpdGUgZmlsZVxuIgoKIyBleHRyYXMKZGVmIGNt",
    "ZF9lY2hvKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgcmV0dXJuICIgIi5qb2luKFtzdHIoYSkgZm9yIGEgaW4gYXJnc10pCgpkZWYgY21kX3VwcGVyKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgcyA9IGlucHV0X2RhdGEuYXNfdGV4dCgpIGlmIGlucHV0X2RhdGEgaXMgbm90IE5vbmUgZWxzZSAiIgogICAgcmV0dXJuIHMudXBwZXIoKQoKZGVmIGNtZF93cml0ZShhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIG5vdCBhcmdzOgogICAgICAgIHJldHVybiAid3JpdGU6IG1pc3NpbmcgZmlsZW5hbWVcbiIKICAgIHBhdGggPSBhcmdzWzBdCiAgICBzID0gaW5wdXRfZGF0YS5hc190ZXh0KCkgaWYgaW5wdXRfZGF0YSBpcyBub3QgTm9uZSBlbHNlICIiCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShzKQogICAgICAgIHJldHVybiAiIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IHdyaXRlIGZpbGVcbiIKCmRlZiBjbWRfYXBwZW5kKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICJhcHBlbmQ6IG1pc3NpbmcgZmlsZW5h",
    "bWVcbiIKICAgIHBhdGggPSBhcmdzWzBdCiAgICBzID0gaW5wdXRfZGF0YS5hc190ZXh0KCkgaWYgaW5wdXRfZGF0YSBpcyBub3QgTm9uZSBlbHNlICIiCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJhIikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShzKQogICAgICAgIHJldHVybiAiIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAjIGZhbGxiYWNrIGlmIGFwcGVuZCBub3Qgc3VwcG9ydGVkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvbGQgPSAiIgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInIiKSBhcyByOgogICAgICAgICAgICAgICAgICAgIG9sZCA9IHIucmVhZCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBvbGQgPSAiIgogICAgICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInciKSBhcyB3OgogICAgICAgICAgICAgICAgdy53cml0ZShvbGQgKyBzKQogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gIkNvdWxkbid0IGFwcGVuZCBmaWxlXG4iCgpkZWYgY21kX3Rlc3Qo",
    "YXJncywgaW5wdXRfZGF0YSk6CiAgICAjIHN1cHBvcnQgWyAuLi4gXSBieSBpZ25vcmluZyB0cmFpbGluZyBdCiAgICBpZiBhcmdzIGFuZCBhcmdzWy0xXSA9PSAiXSI6CiAgICAgICAgYXJncyA9IGFyZ3NbOi0xXQogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICIiCgogICAgaWYgbGVuKGFyZ3MpID09IDI6CiAgICAgICAgb3AsIGEgPSBhcmdzWzBdLCBhcmdzWzFdCiAgICAgICAgaWYgb3AgPT0gIi1mIjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3Muc3RhdChhKQogICAgICAgICAgICAgICAgcmV0dXJuICIxIgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgaWYgb3AgPT0gIi1kIjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MubGlzdGRpcihhKQogICAgICAgICAgICAgICAgcmV0dXJuICIxIgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgaWYgb3AgPT0gIi16IjoKICAgICAgICAgICAgcmV0dXJuICIxIiBpZiBzdHIoYSkgPT0gIiIgZWxzZSAiIgogICAgICAgIGlmIG9w",
    "ID09ICItbiI6CiAgICAgICAgICAgIHJldHVybiAiMSIgaWYgc3RyKGEpICE9ICIiIGVsc2UgIiIKCiAgICBpZiBsZW4oYXJncykgPj0gMzoKICAgICAgICBhLCBvcCwgYiA9IGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0KICAgICAgICBpZiBvcCA9PSAiPSI6CiAgICAgICAgICAgIHJldHVybiAiMSIgaWYgc3RyKGEpID09IHN0cihiKSBlbHNlICIiCiAgICAgICAgaWYgb3AgPT0gIiE9IjoKICAgICAgICAgICAgcmV0dXJuICIxIiBpZiBzdHIoYSkgIT0gc3RyKGIpIGVsc2UgIiIKICAgICAgICBpZiBvcCBpbiAoIi1lcSIsICItbmUiLCAiLWx0IiwgIi1sZSIsICItZ3QiLCAiLWdlIik6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGFpID0gaW50KHN0cihhKS5zdHJpcCgpKQogICAgICAgICAgICAgICAgYmkgPSBpbnQoc3RyKGIpLnN0cmlwKCkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgaWYgb3AgPT0gIi1lcSI6IHJldHVybiAiMSIgaWYgYWkgPT0gYmkgZWxzZSAiIgogICAgICAgICAgICBpZiBvcCA9PSAiLW5lIjogcmV0dXJuICIxIiBpZiBhaSAhPSBiaSBl",
    "bHNlICIiCiAgICAgICAgICAgIGlmIG9wID09ICItbHQiOiByZXR1cm4gIjEiIGlmIGFpIDwgIGJpIGVsc2UgIiIKICAgICAgICAgICAgaWYgb3AgPT0gIi1sZSI6IHJldHVybiAiMSIgaWYgYWkgPD0gYmkgZWxzZSAiIgogICAgICAgICAgICBpZiBvcCA9PSAiLWd0IjogcmV0dXJuICIxIiBpZiBhaSA+ICBiaSBlbHNlICIiCiAgICAgICAgICAgIGlmIG9wID09ICItZ2UiOiByZXR1cm4gIjEiIGlmIGFpID49IGJpIGVsc2UgIiIKICAgIHJldHVybiAiIgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIFZNIGNvbnN0cnVjdGlvbiAoY29tbWFuZHMgKyBqb2IgY29udHJvbCkKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpkZWYgbWFrZV92bSgpOgogICAgIyBJZiB5b3UncmUgdGlnaHQgb24gUkFNLCBsb3dlciB0aGlzIHRvIDUxMiBvciAyNTYuCiAgICB2bSA9IFZNKGNvbW1hbmRzPXt9LCBzcG9vbF9wYXRoPSJTVERPVVQiLCBzcG9vbF90aHJlc2hvbGQ9MjA0OCkKCiAgICBkZWYgY21kX2FkZHYoYXJncywgaW5wdXRfZGF0YSk6CiAgICAgICAgIyBhZGR2IHZhciBkZWx0YSAocXVpZXQpCiAgICAgICAgaWYgbGVuKGFyZ3MpIDwgMjoKICAgICAgICAgICAg",
    "cmV0dXJuICIiCiAgICAgICAgbmFtZSwgZGVsdGFfcyA9IGFyZ3NbMF0sIGFyZ3NbMV0KICAgICAgICB2ID0gdm0udmFycy5nZXQobmFtZSwgIjAiKQogICAgICAgIHRyeToKICAgICAgICAgICAgbiA9IGludChzdHIodikuc3RyaXAoKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBuID0gMAogICAgICAgIHRyeToKICAgICAgICAgICAgZCA9IGludChzdHIoZGVsdGFfcykuc3RyaXAoKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBkID0gMAogICAgICAgIHZtLnZhcnNbbmFtZV0gPSBzdHIobiArIGQpCiAgICAgICAgcmV0dXJuICIiCgogICAgZGVmIGNtZF9qb2JzKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgICAgIGlmIG5vdCB2bS5qb2JzOgogICAgICAgICAgICByZXR1cm4gIihubyBqb2JzKVxuIgogICAgICAgIGxpbmVzID0gW10KICAgICAgICBmb3IgamlkLCBqb2IgaW4gdm0uam9icy5pdGVtcygpOgogICAgICAgICAgICBzdGF0ZSA9ICJkb25lIiBpZiBqb2IuZG9uZSBlbHNlICJydW5uaW5nIgogICAgICAgICAgICBsaW5lcy5hcHBlbmQoIlt7fV0ge30gLSB7fSIuZm9ybWF0KGppZCwgc3RhdGUsIGpv",
    "Yi5uYW1lKSkKICAgICAgICByZXR1cm4gIlxuIi5qb2luKGxpbmVzKSArICJcbiIKCiAgICBkZWYgY21kX2tpbGwoYXJncywgaW5wdXRfZGF0YSk6CiAgICAgICAgaWYgbm90IGFyZ3M6CiAgICAgICAgICAgIHJldHVybiAia2lsbDogdXNhZ2Uga2lsbCA8am9iaWQ+XG4iCiAgICAgICAgdHJ5OgogICAgICAgICAgICBqaWQgPSBpbnQoYXJnc1swXSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gImtpbGw6IGJhZCBqb2JpZFxuIgogICAgICAgIGpvYiA9IHZtLmpvYnMuZ2V0KGppZCkKICAgICAgICBpZiBub3Qgam9iOgogICAgICAgICAgICByZXR1cm4gImtpbGw6IG5vIHN1Y2ggam9iXG4iCiAgICAgICAgam9iLmRvbmUgPSBUcnVlCiAgICAgICAgcmV0dXJuICIiCgogICAgZGVmIGNtZF9mZyhhcmdzLCBpbnB1dF9kYXRhKToKICAgICAgICBpZiBub3QgYXJnczoKICAgICAgICAgICAgcmV0dXJuICJmZzogdXNhZ2UgZmcgPGpvYmlkPlxuIgogICAgICAgIHRyeToKICAgICAgICAgICAgamlkID0gaW50KGFyZ3NbMF0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuICJmZzogYmFkIGpvYmlk",
    "XG4iCiAgICAgICAgam9iID0gdm0uam9icy5nZXQoamlkKQogICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgIHJldHVybiAiZmc6IG5vIHN1Y2ggam9iXG4iCiAgICAgICAgd2hpbGUgbm90IGpvYi5kb25lOgogICAgICAgICAgICBqb2Iuc3RlcChuPTIwMCkKICAgICAgICBlcnIgPSBqb2IuZXJyb3IKICAgICAgICBkZWwgdm0uam9ic1tqaWRdCiAgICAgICAgaWYgZXJyOgogICAgICAgICAgICByZXR1cm4gImZnOiBqb2IgZXJyb3I6ICVzXG4iICUgZXJyCiAgICAgICAgcmV0dXJuICIiCgogICAgdm0uY29tbWFuZHMudXBkYXRlKHsKICAgICAgICAjIHlvdXIgY29tbWFuZHMKICAgICAgICAiaGVscCI6IGNtZF9oZWxwLAogICAgICAgICJscyI6IGNtZF9scywKICAgICAgICAidW5hbWUiOiBjbWRfdW5hbWUsCiAgICAgICAgImZyZWUiOiBjbWRfZnJlZSwKICAgICAgICAiZGYiOiBjbWRfZGYsCiAgICAgICAgInB3ZCI6IGNtZF9wd2QsCiAgICAgICAgImNhdCI6IGNtZF9jYXQsCiAgICAgICAgIndjIjogY21kX3djLAogICAgICAgICJncmVwIjogY21kX2dyZXAsCiAgICAgICAgImNwIjogY21kX2NwLAogICAgICAgICJjZCI6IGNtZF9jZCwKICAgICAg",
    "ICAicmVuYW1lIjogY21kX3JlbmFtZSwKICAgICAgICAibWtkaXIiOiBjbWRfbWtkaXIsCiAgICAgICAgInJtZGlyIjogY21kX3JtZGlyLAogICAgICAgICJleGVjIjogY21kX2V4ZWMsCiAgICAgICAgInJtIjogY21kX3JtLAogICAgICAgICJkYXRlIjogY21kX2RhdGUsCiAgICAgICAgInNjYW53aWZpIjogY21kX3NjYW53aWZpLAogICAgICAgICJjb25uZWN0IjogY21kX2Nvbm5lY3QsCiAgICAgICAgImlmY29uZmlnIjogY21kX2lmY29uZmlnLAogICAgICAgICJlZGl0IjogY21kX2VkaXQsCgogICAgICAgICMgZXh0cmFzCiAgICAgICAgImVjaG8iOiBjbWRfZWNobywKICAgICAgICAidXBwZXIiOiBjbWRfdXBwZXIsCgogICAgICAgICMgcmVkaXJlY3Rpb24KICAgICAgICAid3JpdGUiOiBjbWRfd3JpdGUsCiAgICAgICAgImFwcGVuZCI6IGNtZF9hcHBlbmQsCgogICAgICAgICMgdGVzdCArIGhlbHBlcnMgdXNlZCBieSBsb29wcy9jaGFpbnMKICAgICAgICAidGVzdCI6IGNtZF90ZXN0LAogICAgICAgICJbIjogY21kX3Rlc3QsCiAgICAgICAgImFkZHYiOiBjbWRfYWRkdiwKCiAgICAgICAgIyBzbGVlcAogICAgICAgICJzbGVlcCI6IGNtZF9zbGVlcCwK",
    "ICAgICAgICAicnVuIjogY21kX3J1biwKICAgICAgICAicmVsb2FkIjogY21kX3JlbG9hZCwKCiAgICAgICAgIyBqb2IgY29udHJvbAogICAgICAgICJqb2JzIjogY21kX2pvYnMsCiAgICAgICAgImtpbGwiOiBjbWRfa2lsbCwKICAgICAgICAiZmciOiBjbWRfZmcsCiAgICB9KQoKICAgIHJldHVybiB2bQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIFJFUEwgKGF1dG86IGxpdmUgb24gTWljcm9QeXRob24gd2hlbiBwb2xsYWJsZSwgYmFzaWMgb3RoZXJ3aXNlKQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmRlZiBzdGRpbl9pc19wb2xsYWJsZSgpOgogICAgaWYgc2VsZWN0IGlzIE5vbmU6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICB0cnk6CiAgICAgICAgcCA9IHNlbGVjdC5wb2xsKCkKICAgICAgICBwLnJlZ2lzdGVyKHN5cy5zdGRpbiwgc2VsZWN0LlBPTExJTikKICAgICAgICBwLnBvbGwoMCkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBydW5fbGluZSh2bSwgbGluZSk6CiAgICBjb2RlLCBiZyA9IGNvbXBpbGVfbGluZShsaW5lKQogICAgaWYgYmc6CiAgICAgICAg",
    "amlkID0gdm0uc3RhcnRfam9iKGNvZGUsIG5hbWU9bGluZSkKICAgICAgICBwcmludCgiW3t9XSBzdGFydGVkIHt9Ii5mb3JtYXQoamlkLCBsaW5lKSkKICAgIGVsc2U6CiAgICAgICAgdm0uY29kZSA9IGNvZGUKICAgICAgICB2bS5ydW4odHJhY2U9RmFsc2UpCgpkZWYgcmVwbF9ibG9ja2luZyh2bSk6CiAgICB3aGlsZSBUcnVlOgogICAgICAgIHZtLnBvbGxfam9icyhzdGVwcz0yMDApCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsaW5lID0gaW5wdXQoInB1c2g+ICIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgY29udGludWUKICAgICAgICBsaW5lID0gbGluZS5zdHJpcCgpCiAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgbGluZSA9PSAiZXhpdCI6CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgdHJ5OgogICAgICAgICAgICBydW5fbGluZSh2bSwgbGluZSkKICAgICAgICBleGNlcHQgQ29tcGlsZUVycm9yIGFzIGNlOgogICAgICAgICAgICBwcmludCgiQ29tcGlsZSBlcnJvcjoiLCBjZSkKICAgICAgICBleGNl",
    "cHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KCJFcnJvcjoiLCBlKQoKZGVmIHJlcGxfbm9uYmxvY2tpbmcodm0pOgogICAgcCA9IHNlbGVjdC5wb2xsKCkKICAgIHAucmVnaXN0ZXIoc3lzLnN0ZGluLCBzZWxlY3QuUE9MTElOKQoKICAgIGJ1ZiA9ICIiCiAgICBzeXMuc3Rkb3V0LndyaXRlKCJwdXNoPiAiKQogICAgdHJ5OgogICAgICAgIHN5cy5zdGRvdXQuZmx1c2goKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgd2hpbGUgVHJ1ZToKICAgICAgICB2bS5wb2xsX2pvYnMoc3RlcHM9ODApCgogICAgICAgIHRyeToKICAgICAgICAgICAgZXYgPSBwLnBvbGwoMCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwcmludCgiXG4obGl2ZSBpbnB1dCB1bmF2YWlsYWJsZTsgc3dpdGNoaW5nIHRvIGJhc2ljIG1vZGUpIikKICAgICAgICAgICAgcmVwbF9ibG9ja2luZyh2bSkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIG5vdCBldjoKICAgICAgICAgICAgX3NsZWVwX21zKDEwKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNoID0gc3lzLnN0ZGlu",
    "LnJlYWQoMSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBfc2xlZXBfbXMoMTApCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIG5vdCBjaDoKICAgICAgICAgICAgX3NsZWVwX21zKDEwKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBpZiBjaCA9PSAiXHIiOgogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBpZiBjaCA9PSAiXG4iOgogICAgICAgICAgICBsaW5lID0gYnVmLnN0cmlwKCkKICAgICAgICAgICAgYnVmID0gIiIKICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgiXG4iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIGlmIGxpbmUgPT0gImV4aXQiOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGlmIGxpbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcnVuX2xpbmUodm0sIGxpbmUpCiAgICAgICAgICAgICAgICBleGNlcHQgQ29tcGlsZUVycm9yIGFzIGNlOgogICAgICAgICAgICAg",
    "ICAgICAgIHByaW50KCJDb21waWxlIGVycm9yOiIsIGNlKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJFcnJvcjoiLCBlKQoKICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgicHVzaD4gIikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc3lzLnN0ZG91dC5mbHVzaCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIGNoID09ICJceDA4IiBvciBjaCA9PSAiXHg3ZiI6CiAgICAgICAgICAgIGlmIGJ1ZjoKICAgICAgICAgICAgICAgIGJ1ZiA9IGJ1Zls6LTFdCiAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCJcYiBcYiIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc3lzLnN0ZG91dC5mbHVzaCgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgYnVmICs9IGNoCiAgICAgICAgc3lzLnN0ZG91dC53cml0ZShjaCkK",
    "ICAgICAgICB0cnk6CiAgICAgICAgICAgIHN5cy5zdGRvdXQuZmx1c2goKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCmRlZiByZXBsX2F1dG8odm0pOgogICAgIyBBdm9pZCAiZG91YmxlLWVjaG8iIGlzc3VlcyBvbiBkZXNrdG9wIHRlcm1pbmFsczogb25seSBkbyBsaXZlIG1vZGUgb24gTWljcm9QeXRob24uCiAgICBpZiBpc19taWNyb3B5dGhvbigpIGFuZCBzdGRpbl9pc19wb2xsYWJsZSgpOgogICAgICAgIHByaW50KCJJbnRlcmFjdGl2ZSBtb2RlOiBsaXZlIChiYWNrZ3JvdW5kIGpvYnMgcnVuIHdoaWxlIHlvdSB0eXBlKSIpCiAgICAgICAgcmVwbF9ub25ibG9ja2luZyh2bSkKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIkludGVyYWN0aXZlIG1vZGU6IGJhc2ljIChiYWNrZ3JvdW5kIGpvYnMgcnVuIGJldHdlZW4gY29tbWFuZHMpIikKICAgICAgICByZXBsX2Jsb2NraW5nKHZtKQoKZGVmIHJlcGwoKToKICAgIHZtID0gbWFrZV92bSgpCiAgICBwcmludCgiUFVTSCBWTSIsIFZFUlNJT04pCiAgICBwcmludCgiVHlwZSAnaGVscCcuIFVzZSAnZXhpdCcgdG8gcXVpdC4iKQogICAgcHJpbnQoIkJhY2tncm91bmQ6IGFk",
    "ZCAnJicgYXQgZW5kLiBKb2IgY29udHJvbDogam9icy9raWxsL2ZnLiIpCiAgICByZXBsX2F1dG8odm0pCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgcmVwbCgpCgoK",
)

XPKGB64 = (
    "aW1wb3J0IHVyZXF1ZXN0cwppbXBvcnQganNvbgppbXBvcnQgc3lzCgpSRVBPX0xJTks9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9lbGFodHJlYm9yL3hwa2cvbWFpbiIKCmRlZiBmZXRjaF9pbmRleChyZXBvX3VybCk6CiAgICB1cmwgPSBSRVBPX0xJTksgKyAiL2luZGV4Lmpzb24iCiAgICByID0gdXJlcXVlc3RzLmdldCh1cmwpCiAgICB0cnk6CiAgICAgICAgaWYgci5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiSFRUUCAlZCIgJSByLnN0YXR1c19jb2RlKQogICAgICAgIHJldHVybiBqc29uLmxvYWRzKHIudGV4dCkKICAgIGZpbmFsbHk6CiAgICAgICAgci5jbG9zZSgpCgpkZWYgY21kX2xpc3QoKToKICAgIGlkeCA9IGZldGNoX2luZGV4KFJFUE9fTElOSykKICAgIG91dCA9IFtdCiAgICBmb3IgbmFtZSwgbWV0YSBpbiBpZHguaXRlbXMoKToKICAgICAgICBpZiBuYW1lIGluICgicmVwbyIsICJ1cGRhdGVkIik6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgb3V0LmFwcGVuZCgiJS0xMHMgJXMgLSAlcyIgJSAoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIG1ldGEuZ2V0KCJ2",
    "ZXJzaW9uIiwgIj8iKSwKICAgICAgICAgICAgbWV0YS5nZXQoImRlc2MiLCAiIikKICAgICAgICApKQogICAgcmV0dXJuICJcbiIuam9pbihvdXQpICsgIlxuIgoKCmRlZiBjbWRfaW5zdGFsbChwa2cpOgogICAgcmVwbyA9IFJFUE9fTElOSwogICAgaWR4ID0gZmV0Y2hfaW5kZXgocmVwbykKICAgIGlmIHBrZyBub3QgaW4gaWR4OgogICAgICAgIHJldHVybiAieHBrZzogcGFja2FnZSBub3QgZm91bmRcbiIKCiAgICBtZXRhID0gaWR4W3BrZ10KICAgIHNyYyA9IHJlcG8gKyAiLyIgKyBtZXRhWyJmaWxlIl0KICAgIGRzdCA9IG1ldGEuZ2V0KCJpbnN0YWxsIiwgIi9saWIvIiArIHBrZyArICIucHkiKQoKICAgIHIgPSB1cmVxdWVzdHMuZ2V0KHNyYykKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZHN0LCAidyIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoci50ZXh0KQogICAgZmluYWxseToKICAgICAgICByLmNsb3NlKCkKCiAgICByZXR1cm4gImluc3RhbGxlZCAlc1xuIiAlIHBrZwoKCmRlZiBtYWluKGFyZ3YpOgogICAgY21kID0gYXJndlswXQoKICAgIGlmIGNtZCA9PSAibGlzdCI6CiAgICAgICAgcmV0dXJuIGNtZF9saXN0KCkKICAgIAogICAg",
    "ZWxpZiBjbWQgPT0gImluc3RhbGwiOgogICAgICAgIHBrZyA9IGFyZ3ZbMV0KICAgICAgICByZXR1cm4gY21kX2luc3RhbGwocGtnKQogICAgcmV0dXJuICJva1xuIgoKCg=="
)

DHCPB64 = (
    "aW1wb3J0IG5ldHdvcmsKIyBOT1RFIEVkaXQgdGhpcyBmaWxlIGFuZCBjaGFuZ2UgaXQgdG8gY2hhbmdlIG5ldHdvcmsgY29ubmVjdGlvbgpzc2lkID0gIlNTSURfVkFSIgp3a2V5ID0gIldLRVlfVkFSIgoKd2xhbiA9IG5ldHdvcmsuV0xBTihuZXR3b3JrLlNUQV9JRikKd2xhbi5hY3RpdmUoVHJ1ZSkKc2Nhbm5lZCA9IHdsYW4uc2NhbigpCndsYW4uY29ubmVjdChzc2lkLCB3a2V5KQoKCg==",
)
#for line in PUSHB64:
#  chunk = decode_b64_to_text(line)
#  append_to_file("/pushvm.py", chunk)

write_b64_chunks_to_file("/pushvm.py", PUSHB64)

del PUSHB64
gc.collect()


print("Installing xpkg...")

write_b64_chunks_to_file("/lib/xpkg.py", XPKGB64)
del XPKGB64
gc.collect()

installNetwork = input("Do you want to setup wireless networking? (y|n)")
if installNetwork == "y":
     print("Note this will create a script called dhcp.py and include your credentials in it.")
     print("It will also add the dhcp script to boot so networking is automatic..")
     ssid = input("Enter the SSID>")
     wkey = input("Enter the password")
     print ("Creating dhcp.py")
     dhtxt = decode_b64_to_text(DHCPB64)
     dhtxt = dhtxt.replace("SSID_VAR", ssid).replace("WKEY_VAR", wkey)
     write_text_file("/dhcp.py", dhtxt)
     print ("Appending import dhcp in boot.py")
     append_to_file("/boot.py", "\n" + "import dhcp" + "\n")
else:
     print("Skipping network setup")

print("Install complete.. Please reboot your microcontroller now..")
print("After install.\nTo run push enter:\nimport pushvm\npushvm.repl()\n")





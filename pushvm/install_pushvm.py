import ubinascii
import os
import sys
import gc

import uos, ubinascii, gc

def mkdir_p(path):
    parts = path.split("/")
    cur = ""
    for p in parts:
        if not p:
            continue
        cur += "/" + p
        try:
            uos.stat(cur)
        except OSError:
            try:
                uos.mkdir(cur)
            except OSError:
                pass

def write_b64_chunks_to_file(path, b64_chunks, gc_every=32):
    parent = path.rsplit("/", 1)[0]
    if parent:
        mkdir_p(parent)

    tmp = path + ".tmp"
    try:
        uos.remove(tmp)
    except OSError:
        pass

    with open(tmp, "wb") as f:
        for i, ch in enumerate(b64_chunks, 1):
            if isinstance(ch, str):
                ch = ch.encode()
            f.write(ubinascii.a2b_base64(ch))
            if i % gc_every == 0:
                gc.collect()

    try:
        uos.remove(path)
    except OSError:
        pass
    uos.rename(tmp, path)
    gc.collect()




def decode_b64_to_text(b64_chunks):
    if isinstance(b64_chunks, (tuple, list)):
        b64 = "".join(b64_chunks)
    else:
        b64 = b64_chunks
    raw = ubinascii.a2b_base64(b64.encode() if isinstance(b64, str) else b64)
    return raw.decode("utf-8")

def write_text_file(path, text):
    parent = path.rsplit("/", 1)[0]
    if parent:
        mkdir_p(parent)

    tmp = path + ".tmp"
    try:
        uos.remove(tmp)
    except OSError:
        pass
    with open(tmp, "w") as f:
        f.write(text)
    try:
        uos.remove(path)
    except OSError:
        pass
    uos.rename(tmp, path)
    gc.collect()     

def append_to_file(fname, data):
    with open(fname, "a") as f:
     f.write(data)
     f.close()

print("Installing pushvm /lib and xpkg...")

mkdir_p("/lib")


PUSHB64 = (
    "IyBwdXNodm0ucHkKIyBQVVNIIFZNIChFU1AzMi1maXJzdCBjb21wbGV0ZSB2ZXJzaW9uKQojIEZlYXR1cmVzOgojIC0gQ29tbWFuZHM6IGhlbHAsIGxzLCB1bmFtZSwgZnJlZSwgZGYsIHB3ZCwgY2F0LCB3YywgZ3JlcCwgY3AsIGNkLCByZW5hbWUsCiMgICAgICAgICAgICBta2Rpciwgcm1kaXIsIGV4ZWMsIHJtLCBkYXRlLCBzY2Fud2lmaSwgY29ubmVjdCwgaWZjb25maWcsIGVkaXQsCiMgICAgICAgICAgICBlY2hvLCB1cHBlciwgdGVzdCAoWyksIHdyaXRlICg+KSwgYXBwZW5kICg+PiksIHNsZWVwCiMgLSBQaXBlbGluZXM6IHwKIyAtIFJlZGlyZWN0aW9uOiA+IGFuZCA+PiAoY29tcGlsZWQgdG8gfCB3cml0ZSAvIHwgYXBwZW5kKQojIC0gVmFyaWFibGVzOiB4PTMgYW5kICR4IGV4cGFuc2lvbgojIC0gQ29udHJvbCBmbG93OgojICAgICBpZiA8cGlwZWxpbmU+IHRoZW4gPHN0bXRzPiBbZWxzZSA8c3RtdHM+XSBmaQojICAgICB3aGlsZSA8cGlwZWxpbmU+IGRvIDxzdG10cz4gZG9uZQojICAgICBmb3IgaSAxIDEwIFtzdGVwXSBkbyA8c3RtdHM+IGRvbmUKIyAgICAgZm9yZWFjaCB2IGluIGEgYiBjIGRvIDxzdG10cz4gZG9uZQojICAgICBmb3JlYWNo",
    "IHYgaW4gPHBpcGVsaW5lPiBkbyA8c3RtdHM+IGRvbmUgICAoc3BsaXRzIG91dHB1dCBieSBsaW5lcykKIyAgICAgYnJlYWsgLyBjb250aW51ZQojIC0gU2hvcnQtY2lyY3VpdDogJiYgYW5kIHx8CiMgLSBCYWNrZ3JvdW5kIGpvYnM6IHRyYWlsaW5nICYgKGpvYnMva2lsbC9mZykKIyAtIEh5YnJpZCBwaXBlIHNwb29saW5nOiBSQU0gdW50aWwgdGhyZXNob2xkIHRoZW4gc3BpbGwgdG8gU1RET1VUIGZpbGUKIyAtIFJFUEw6IGF1dG8gc2VsZWN0cyBsaXZlIG1vZGUgKG5vbi1ibG9ja2luZykgb24gTWljcm9QeXRob24gd2hlbiBwb2xsYWJsZSwKIyAgICAgICAgIG90aGVyd2lzZSB1c2VzIGJhc2ljIGlucHV0KCkgKGJldHRlciBmb3IgZGVza3RvcCB0ZXN0aW5nKQojCiMgTm90ZXM6CiMgLSBEZXNpZ25lZCBmb3IgRVNQMzIvV2ViUkVQTCArIFRob25ueTsgYWxzbyBydW5zIG9uIENQeXRob24gZm9yIGRldmVsb3BtZW50LgojIC0gc2xlZXAgd29ya3MgY29ycmVjdGx5IGluIGJhY2tncm91bmQgam9icyAobm8gZ2VuZXJhdG9yIHJlLWVudHJhbmN5KS4KCmltcG9ydCBvcwppbXBvcnQgdGltZQppbXBvcnQgc3lzCgp0cnk6CiAgICBpbXBvcnQgZ2MKZXhjZXB0",
    "IEV4Y2VwdGlvbjoKICAgIGdjID0gTm9uZQoKdHJ5OgogICAgaW1wb3J0IG5ldHdvcmsKZXhjZXB0IEV4Y2VwdGlvbjoKICAgIG5ldHdvcmsgPSBOb25lCgp0cnk6CiAgICBpbXBvcnQgdXNlbGVjdCBhcyBzZWxlY3QgICMgTWljcm9QeXRob24KZXhjZXB0IEV4Y2VwdGlvbjoKICAgIHRyeToKICAgICAgICBpbXBvcnQgc2VsZWN0ICAjIENQeXRob24gZmFsbGJhY2sKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgc2VsZWN0ID0gTm9uZQoKVkVSU0lPTiA9ICJwdXNodm0tY29tcGxldGUtMC4xIgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIEdsb2JhbCAiY3VycmVudCBWTSIgcG9pbnRlciBzbyBjb21tYW5kcyBjYW4gYWZmZWN0IHRoZSBWTSB0aGF0IGlzIGFjdHVhbGx5IGV4ZWN1dGluZy4KIyBUaGlzIGtlZXBzIGNvbW1hbmRzIGRpY3Qgc2hhcmVkIGFjcm9zcyBiYWNrZ3JvdW5kIGpvYiBjbG9uZXMgd2l0aG91dCBjbG9zdXJlcyBib3VuZCB0byB0aGUgd3JvbmcgVk0uCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KX0NVUlJFTlRfVk0gPSBOb25lCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgVGltZSBoZWxwZXJzCiMgLS0tLS0tLS0t",
    "LS0tLS0tLS0tLS0tLS0KZGVmIF9zbGVlcF9tcyhtcyk6CiAgICBpZiBoYXNhdHRyKHRpbWUsICJzbGVlcF9tcyIpOgogICAgICAgIHRpbWUuc2xlZXBfbXMobXMpCiAgICBlbHNlOgogICAgICAgIHRpbWUuc2xlZXAobXMgLyAxMDAwLjApCgpkZWYgX3RpY2tzX21zKCk6CiAgICBpZiBoYXNhdHRyKHRpbWUsICJ0aWNrc19tcyIpOgogICAgICAgIHJldHVybiB0aW1lLnRpY2tzX21zKCkKICAgIHJldHVybiBpbnQodGltZS50aW1lKCkgKiAxMDAwKQoKZGVmIF90aWNrc19hZGQoYSwgbXMpOgogICAgaWYgaGFzYXR0cih0aW1lLCAidGlja3NfYWRkIik6CiAgICAgICAgcmV0dXJuIHRpbWUudGlja3NfYWRkKGEsIG1zKQogICAgcmV0dXJuIGEgKyBtcwoKZGVmIF90aWNrc19kaWZmKGEsIGIpOgogICAgaWYgaGFzYXR0cih0aW1lLCAidGlja3NfZGlmZiIpOgogICAgICAgIHJldHVybiB0aW1lLnRpY2tzX2RpZmYoYSwgYikKICAgIHJldHVybiBhIC0gYgoKZGVmIGlzX21pY3JvcHl0aG9uKCk6CiAgICB0cnk6CiAgICAgICAgcmV0dXJuIHN5cy5pbXBsZW1lbnRhdGlvbi5uYW1lID09ICJtaWNyb3B5dGhvbiIKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAg",
    "cmV0dXJuIEZhbHNlCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgT3Bjb2RlcwojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCk9QX0xPQUQgICAgICA9IDEKT1BfQVJHICAgICAgID0gMgpPUF9QSVBFICAgICAgPSAzCk9QX0VYRUMgICAgICA9IDQgICAgICAjIGV4ZWN1dGUgKyBwcmludApPUF9TRVQgICAgICAgPSA1Ck9QX0dFVCAgICAgICA9IDYKT1BfSk1QICAgICAgID0gNwpPUF9KWiAgICAgICAgPSA4Ck9QX0VYRUNRICAgICA9IDkgICAgICAjIGV4ZWN1dGUgcXVpZXRseQpPUF9TRVRMSVNUICAgPSAxMCAgICAgIyB2YXJzW25hbWVdID0gbGlzdChpdGVtcykKT1BfU1BMSVRMICAgID0gMTEgICAgICMgdmFyc1tuYW1lXSA9IGxhc3Rfb3V0cHV0LnNwbGl0bGluZXMoKQpPUF9GT1JFX0lOSVQgPSAxMiAgICAgIyBpbml0IGZvcmVhY2ggaXRlcmF0b3IKT1BfRk9SRV9ORVhUID0gMTMgICAgICMgYWR2YW5jZSBmb3JlYWNoOyBpZiBkb25lIGp1bXAKT1BfRU5EICAgICAgID0gMjU1CgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgSHlicmlkIFBpcGVEYXRhIChSQU0gb3Igc3Bvb2wgZmlsZSkKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFz",
    "cyBQaXBlRGF0YToKICAgIF9fc2xvdHNfXyA9ICgidGV4dCIsICJwYXRoIiwgImlzX2ZpbGUiKQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0ZXh0PU5vbmUsIHBhdGg9Tm9uZSwgaXNfZmlsZT1GYWxzZSk6CiAgICAgICAgc2VsZi50ZXh0ID0gdGV4dAogICAgICAgIHNlbGYucGF0aCA9IHBhdGgKICAgICAgICBzZWxmLmlzX2ZpbGUgPSBpc19maWxlCgogICAgZGVmIGFzX3RleHQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5pc19maWxlOgogICAgICAgICAgICB3aXRoIG9wZW4oc2VsZi5wYXRoLCAiciIpIGFzIGY6CiAgICAgICAgICAgICAgICByZXR1cm4gZi5yZWFkKCkKICAgICAgICByZXR1cm4gIiIgaWYgc2VsZi50ZXh0IGlzIE5vbmUgZWxzZSBzdHIoc2VsZi50ZXh0KQoKICAgIGRlZiBvcGVuX3JlYWRlcihzZWxmKToKICAgICAgICBpZiBzZWxmLmlzX2ZpbGU6CiAgICAgICAgICAgIHJldHVybiBvcGVuKHNlbGYucGF0aCwgInIiKQogICAgICAgIHJldHVybiBfU3RyaW5nTGluZVJlYWRlcihzZWxmLmFzX3RleHQoKSkKCmNsYXNzIF9TdHJpbmdMaW5lUmVhZGVyOgogICAgX19zbG90c19fID0gKCJfcyIsICJfaSIsICJfbiIpCiAgICBkZWYgX19pbml0",
    "X18oc2VsZiwgcyk6CiAgICAgICAgc2VsZi5fcyA9IHMKICAgICAgICBzZWxmLl9pID0gMAogICAgICAgIHNlbGYuX24gPSBsZW4ocykKCiAgICBkZWYgX19pdGVyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgX19uZXh0X18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5faSA+PSBzZWxmLl9uOgogICAgICAgICAgICByYWlzZSBTdG9wSXRlcmF0aW9uCiAgICAgICAgcyA9IHNlbGYuX3MKICAgICAgICBqID0gcy5maW5kKCJcbiIsIHNlbGYuX2kpCiAgICAgICAgaWYgaiA9PSAtMToKICAgICAgICAgICAgbGluZSA9IHNbc2VsZi5faTpdCiAgICAgICAgICAgIHNlbGYuX2kgPSBzZWxmLl9uCiAgICAgICAgICAgIHJldHVybiBsaW5lCiAgICAgICAgbGluZSA9IHNbc2VsZi5faTpqKzFdCiAgICAgICAgc2VsZi5faSA9IGogKyAxCiAgICAgICAgcmV0dXJuIGxpbmUKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgcGFzcwoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIFRva2VuaXplciAocXVvdGVzICsgc3BlY2lhbHM6IHwgOyA+ID4+ICYmIHx8ICYpCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZGVmIHRva2VuaXplKHMpOgog",
    "ICAgb3V0ID0gW10KICAgIGJ1ZiA9ICIiCiAgICBpbl9xID0gRmFsc2UKICAgIGkgPSAwCiAgICBuID0gbGVuKHMpCgogICAgZGVmIGZsdXNoKCk6CiAgICAgICAgbm9ubG9jYWwgYnVmCiAgICAgICAgaWYgYnVmICE9ICIiOgogICAgICAgICAgICBvdXQuYXBwZW5kKGJ1ZikKICAgICAgICAgICAgYnVmID0gIiIKCiAgICB3aGlsZSBpIDwgbjoKICAgICAgICBjaCA9IHNbaV0KCiAgICAgICAgaWYgY2ggPT0gJyInOgogICAgICAgICAgICBpbl9xID0gbm90IGluX3EKICAgICAgICAgICAgaSArPSAxCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIG5vdCBpbl9xOgogICAgICAgICAgICBpZiBjaC5pc3NwYWNlKCk6CiAgICAgICAgICAgICAgICBmbHVzaCgpCiAgICAgICAgICAgICAgICBpICs9IDEKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIHR3by1jaGFyIG9wcwogICAgICAgICAgICBpZiBjaCA9PSAiJiIgYW5kIGkgKyAxIDwgbiBhbmQgc1tpKzFdID09ICImIjoKICAgICAgICAgICAgICAgIGZsdXNoKCk7IG91dC5hcHBlbmQoIiYmIik7IGkgKz0gMjsgY29udGludWUKICAgICAgICAgICAgaWYgY2ggPT0gInwiIGFu",
    "ZCBpICsgMSA8IG4gYW5kIHNbaSsxXSA9PSAifCI6CiAgICAgICAgICAgICAgICBmbHVzaCgpOyBvdXQuYXBwZW5kKCJ8fCIpOyBpICs9IDI7IGNvbnRpbnVlCiAgICAgICAgICAgIGlmIGNoID09ICI+IiBhbmQgaSArIDEgPCBuIGFuZCBzW2krMV0gPT0gIj4iOgogICAgICAgICAgICAgICAgZmx1c2goKTsgb3V0LmFwcGVuZCgiPj4iKTsgaSArPSAyOyBjb250aW51ZQoKICAgICAgICAgICAgIyBvbmUtY2hhciBzcGVjaWFscwogICAgICAgICAgICBpZiBjaCBpbiAoInwiLCAiOyIsICI+IiwgIiYiKToKICAgICAgICAgICAgICAgIGZsdXNoKCk7IG91dC5hcHBlbmQoY2gpOyBpICs9IDE7IGNvbnRpbnVlCgogICAgICAgIGJ1ZiArPSBjaAogICAgICAgIGkgKz0gMQoKICAgIGZsdXNoKCkKICAgIHJldHVybiBvdXQKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBDb21waWxlciB3aXRoIGxvb3BzICsgaWYgKyBjaGFpbnMgJiYvfHwgKyByZWRpcmVjdGlvbgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNsYXNzIENvbXBpbGVFcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKY2xhc3MgQ29tcGlsZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdG9rZW5z",
    "KToKICAgICAgICBzZWxmLnRva3MgPSB0b2tlbnMKICAgICAgICBzZWxmLmkgPSAwCiAgICAgICAgc2VsZi5jb2RlID0gW10KICAgICAgICBzZWxmLmxvb3Bfc3RhY2sgPSBbXSAgICMgeyJzdGFydCI6IHBjLCAiYnJlYWtfam1wcyI6Wy4uLl19CiAgICAgICAgc2VsZi5fdG1wX2NvdW50ZXIgPSAwCgogICAgZGVmIHBlZWsoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYudG9rc1tzZWxmLmldIGlmIHNlbGYuaSA8IGxlbihzZWxmLnRva3MpIGVsc2UgTm9uZQoKICAgIGRlZiBwb3Aoc2VsZik6CiAgICAgICAgdCA9IHNlbGYucGVlaygpCiAgICAgICAgaWYgdCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHNlbGYuaSArPSAxCiAgICAgICAgcmV0dXJuIHQKCiAgICBkZWYgZXhwZWN0KHNlbGYsIHMpOgogICAgICAgIHQgPSBzZWxmLnBvcCgpCiAgICAgICAgaWYgdCAhPSBzOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoIkV4cGVjdGVkICclcycgYnV0IGdvdCAnJXMnIiAlIChzLCB0KSkKCiAgICBkZWYgZW1pdChzZWxmLCBvcCwgYXJnPU5vbmUpOgogICAgICAgIHNlbGYuY29kZS5hcHBlbmQoKG9wLCBhcmcpKQogICAg",
    "ICAgIHJldHVybiBsZW4oc2VsZi5jb2RlKSAtIDEKCiAgICBkZWYgcGF0Y2goc2VsZiwgaWR4LCBuZXdfYXJnKToKICAgICAgICBvcCwgXyA9IHNlbGYuY29kZVtpZHhdCiAgICAgICAgc2VsZi5jb2RlW2lkeF0gPSAob3AsIG5ld19hcmcpCgogICAgZGVmIG5ld190bXAoc2VsZiwgcHJlZml4PSJfX3RtcCIpOgogICAgICAgIHNlbGYuX3RtcF9jb3VudGVyICs9IDEKICAgICAgICByZXR1cm4gIiVzJWQiICUgKHByZWZpeCwgc2VsZi5fdG1wX2NvdW50ZXIpCgogICAgZGVmIGNvbXBpbGUoc2VsZik6CiAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXNldCgpKQogICAgICAgIHNlbGYuZW1pdChPUF9FTkQsIE5vbmUpCiAgICAgICAgcmV0dXJuIHNlbGYuY29kZQoKICAgIGRlZiBjb21waWxlX3N0bXRzKHNlbGYsIHRlcm1pbmF0b3JzKToKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0ID0gc2VsZi5wZWVrKCkKICAgICAgICAgICAgaWYgdCBpcyBOb25lIG9yIHQgaW4gdGVybWluYXRvcnM6CiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIHQgPT0gIjsiOgogICAgICAgICAgICAgICAgc2VsZi5wb3AoKQog",
    "ICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIHQgPT0gImlmIjoKICAgICAgICAgICAgICAgIHNlbGYuY29tcGlsZV9pZigpCiAgICAgICAgICAgIGVsaWYgdCA9PSAid2hpbGUiOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX3doaWxlKCkKICAgICAgICAgICAgZWxpZiB0ID09ICJmb3IiOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX2ZvcigpCiAgICAgICAgICAgIGVsaWYgdCA9PSAiZm9yZWFjaCI6CiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfZm9yZWFjaCgpCiAgICAgICAgICAgIGVsaWYgdCA9PSAiYnJlYWsiOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX2JyZWFrKCkKICAgICAgICAgICAgICAgIHNlbGYuZW1pdChPUF9FWEVDUSwgTm9uZSkgICMgYm91bmRhcnkKICAgICAgICAgICAgZWxpZiB0ID09ICJjb250aW51ZSI6CiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfY29udGludWUoKQogICAgICAgICAgICAgICAgc2VsZi5lbWl0KE9QX0VYRUNRLCBOb25lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX2NoYWluKHN0b3BfdG9rZW5zPXRlcm1pbmF0",
    "b3JzKQoKICAgICAgICAgICAgaWYgc2VsZi5wZWVrKCkgPT0gIjsiOgogICAgICAgICAgICAgICAgc2VsZi5wb3AoKQoKICAgICMgLS0tLSBpZiAvIHdoaWxlIC8gZm9yIC8gZm9yZWFjaCAtLS0tCiAgICBkZWYgY29tcGlsZV9pZihzZWxmKToKICAgICAgICBzZWxmLmV4cGVjdCgiaWYiKQogICAgICAgIHNlbGYuY29tcGlsZV9waXBlbGluZShzdG9wX3Rva2Vucz17InRoZW4ifSkKICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAganpfaWR4ID0gc2VsZi5lbWl0KE9QX0paLCBOb25lKQoKICAgICAgICBzZWxmLmV4cGVjdCgidGhlbiIpCiAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXsiZWxzZSIsICJmaSJ9KQoKICAgICAgICBpZiBzZWxmLnBlZWsoKSA9PSAiZWxzZSI6CiAgICAgICAgICAgIGptcF9lbmQgPSBzZWxmLmVtaXQoT1BfSk1QLCBOb25lKQogICAgICAgICAgICBzZWxmLmV4cGVjdCgiZWxzZSIpCiAgICAgICAgICAgIHNlbGYucGF0Y2goanpfaWR4LCBsZW4oc2VsZi5jb2RlKSkKICAgICAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXsiZmkifSkKICAgICAgICAgICAgc2Vs",
    "Zi5leHBlY3QoImZpIikKICAgICAgICAgICAgc2VsZi5wYXRjaChqbXBfZW5kLCBsZW4oc2VsZi5jb2RlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmV4cGVjdCgiZmkiKQogICAgICAgICAgICBzZWxmLnBhdGNoKGp6X2lkeCwgbGVuKHNlbGYuY29kZSkpCgogICAgZGVmIGNvbXBpbGVfd2hpbGUoc2VsZik6CiAgICAgICAgc2VsZi5leHBlY3QoIndoaWxlIikKICAgICAgICBsb29wX3N0YXJ0ID0gbGVuKHNlbGYuY29kZSkKCiAgICAgICAgc2VsZi5jb21waWxlX3BpcGVsaW5lKHN0b3BfdG9rZW5zPXsiZG8ifSkKICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAganpfZXhpdCA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKCiAgICAgICAgc2VsZi5leHBlY3QoImRvIikKICAgICAgICBjdHggPSB7InN0YXJ0IjogbG9vcF9zdGFydCwgImJyZWFrX2ptcHMiOiBbXX0KICAgICAgICBzZWxmLmxvb3Bfc3RhY2suYXBwZW5kKGN0eCkKCiAgICAgICAgc2VsZi5jb21waWxlX3N0bXRzKHRlcm1pbmF0b3JzPXsiZG9uZSJ9KQogICAgICAgIHNlbGYuZXhwZWN0KCJkb25lIikKCiAgICAgICAgc2VsZi5lbWl0KE9QX0pNUCwgbG9v",
    "cF9zdGFydCkKCiAgICAgICAgZXhpdF90YXJnZXQgPSBsZW4oc2VsZi5jb2RlKQogICAgICAgIHNlbGYucGF0Y2goanpfZXhpdCwgZXhpdF90YXJnZXQpCiAgICAgICAgZm9yIGppZHggaW4gY3R4WyJicmVha19qbXBzIl06CiAgICAgICAgICAgIHNlbGYucGF0Y2goamlkeCwgZXhpdF90YXJnZXQpCiAgICAgICAgc2VsZi5sb29wX3N0YWNrLnBvcCgpCgogICAgZGVmIGNvbXBpbGVfZm9yKHNlbGYpOgogICAgICAgICMgZm9yIGkgMSAxMCBbc3RlcF0gZG8gLi4uIGRvbmUKICAgICAgICBzZWxmLmV4cGVjdCgiZm9yIikKICAgICAgICB2YXIgPSBzZWxmLnBvcCgpCiAgICAgICAgaWYgbm90IHZhcjoKICAgICAgICAgICAgcmFpc2UgQ29tcGlsZUVycm9yKCJmb3I6IG1pc3NpbmcgdmFyaWFibGUgbmFtZSIpCgogICAgICAgIHN0YXJ0ID0gc2VsZi5wb3AoKQogICAgICAgIGVuZCA9IHNlbGYucG9wKCkKICAgICAgICBpZiBzdGFydCBpcyBOb25lIG9yIGVuZCBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImZvcjogbmVlZHMgc3RhcnQgYW5kIGVuZCIpCgogICAgICAgIHN0ZXAgPSBOb25lCiAgICAgICAgaWYgc2VsZi5wZWVrKCkgIT0g",
    "ImRvIjoKICAgICAgICAgICAgc3RlcCA9IHNlbGYucG9wKCkKICAgICAgICBpZiBzZWxmLnBlZWsoKSAhPSAiZG8iOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImZvcjogZXhwZWN0ZWQgJ2RvJyIpCgogICAgICAgICMgaW5pdCB2YXI9c3RhcnQKICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCBzdGFydCkKICAgICAgICBzZWxmLmVtaXQoT1BfU0VULCB2YXIpCgogICAgICAgIGxvb3Bfc3RhcnQgPSBsZW4oc2VsZi5jb2RlKQoKICAgICAgICAjIGNvbmRpdGlvbiB1c2luZyB0ZXN0OgogICAgICAgIGNtcG9wID0gIi1sZSIKICAgICAgICBpZiBzdGVwIGlzIG5vdCBOb25lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBpbnQoc3RyKHN0ZXApLnN0cmlwKCkpIDwgMDoKICAgICAgICAgICAgICAgICAgICBjbXBvcCA9ICItZ2UiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBjbXBvcCA9ICItbGUiCgogICAgICAgIHNlbGYuZW1pdChPUF9MT0FELCAidGVzdCIpCiAgICAgICAgc2VsZi5lbWl0KE9QX0dFVCwgdmFyKQogICAgICAgIHNlbGYuZW1pdChPUF9BUkcsIGNtcG9wKQogICAgICAgIHNl",
    "bGYuZW1pdChPUF9BUkcsIGVuZCkKICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAganpfZXhpdCA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKCiAgICAgICAgc2VsZi5leHBlY3QoImRvIikKCiAgICAgICAgY3R4ID0geyJzdGFydCI6IGxvb3Bfc3RhcnQsICJicmVha19qbXBzIjogW119CiAgICAgICAgc2VsZi5sb29wX3N0YWNrLmFwcGVuZChjdHgpCgogICAgICAgIHNlbGYuY29tcGlsZV9zdG10cyh0ZXJtaW5hdG9ycz17ImRvbmUifSkKICAgICAgICBzZWxmLmV4cGVjdCgiZG9uZSIpCgogICAgICAgIGlmIHN0ZXAgaXMgTm9uZToKICAgICAgICAgICAgc3RlcCA9ICIxIgogICAgICAgICMgaW5jcmVtZW50IHZhciBieSBzdGVwIChxdWlldCkKICAgICAgICBzZWxmLmVtaXQoT1BfTE9BRCwgImFkZHYiKQogICAgICAgIHNlbGYuZW1pdChPUF9BUkcsIHZhcikKICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCBzdGVwKQogICAgICAgIHNlbGYuZW1pdChPUF9FWEVDUSwgTm9uZSkKCiAgICAgICAgc2VsZi5lbWl0KE9QX0pNUCwgbG9vcF9zdGFydCkKCiAgICAgICAgZXhpdF90YXJnZXQgPSBsZW4oc2VsZi5jb2RlKQogICAgICAgIHNl",
    "bGYucGF0Y2goanpfZXhpdCwgZXhpdF90YXJnZXQpCiAgICAgICAgZm9yIGppZHggaW4gY3R4WyJicmVha19qbXBzIl06CiAgICAgICAgICAgIHNlbGYucGF0Y2goamlkeCwgZXhpdF90YXJnZXQpCiAgICAgICAgc2VsZi5sb29wX3N0YWNrLnBvcCgpCgogICAgZGVmIGNvbXBpbGVfZm9yZWFjaChzZWxmKToKICAgICAgICAjIGZvcmVhY2ggdiBpbiBhIGIgYyBkbyAuLi4gZG9uZQogICAgICAgICMgZm9yZWFjaCB2IGluIDxwaXBlbGluZT4gZG8gLi4uIGRvbmUgICAoc3BsaXQgcGlwZWxpbmUgb3V0cHV0IGJ5IGxpbmVzKQogICAgICAgIHNlbGYuZXhwZWN0KCJmb3JlYWNoIikKICAgICAgICB2YXIgPSBzZWxmLnBvcCgpCiAgICAgICAgaWYgbm90IHZhcjoKICAgICAgICAgICAgcmFpc2UgQ29tcGlsZUVycm9yKCJmb3JlYWNoOiBtaXNzaW5nIHZhcmlhYmxlIG5hbWUiKQogICAgICAgIHNlbGYuZXhwZWN0KCJpbiIpCgogICAgICAgIGxpc3RfdmFyID0gc2VsZi5uZXdfdG1wKCJfX2ZvcmVhY2hfbGlzdF8iKQoKICAgICAgICBjb2xsZWN0ZWQgPSBbXQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgICAgICBp",
    "ZiB0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImZvcmVhY2g6IG1pc3NpbmcgJ2RvJyIpCiAgICAgICAgICAgIGlmIHQgPT0gImRvIjoKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGNvbGxlY3RlZC5hcHBlbmQoc2VsZi5wb3AoKSkKCiAgICAgICAgaWYgInwiIGluIGNvbGxlY3RlZDoKICAgICAgICAgICAgc3ViID0gQ29tcGlsZXIoY29sbGVjdGVkKQogICAgICAgICAgICBzdWIuY29tcGlsZV9waXBlbGluZShzdG9wX3Rva2Vucz1zZXQoKSkKICAgICAgICAgICAgc2VsZi5jb2RlLmV4dGVuZChzdWIuY29kZSkKICAgICAgICAgICAgc2VsZi5lbWl0KE9QX0VYRUNRLCBOb25lKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfU1BMSVRMLCBsaXN0X3ZhcikKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmVtaXQoT1BfU0VUTElTVCwgKGxpc3RfdmFyLCBjb2xsZWN0ZWQpKQoKICAgICAgICBzZWxmLmV4cGVjdCgiZG8iKQoKICAgICAgICBzZWxmLmVtaXQoT1BfRk9SRV9JTklULCAodmFyLCBsaXN0X3ZhcikpCiAgICAgICAgbG9vcF9zdGFydCA9IGxlbihzZWxmLmNvZGUpCiAgICAgICAgZm9yZV9u",
    "ZXh0ID0gc2VsZi5lbWl0KE9QX0ZPUkVfTkVYVCwgTm9uZSkgICMgcGF0Y2hlZCB0byBleGl0CgogICAgICAgIGN0eCA9IHsic3RhcnQiOiBsb29wX3N0YXJ0LCAiYnJlYWtfam1wcyI6IFtdfQogICAgICAgIHNlbGYubG9vcF9zdGFjay5hcHBlbmQoY3R4KQoKICAgICAgICBzZWxmLmNvbXBpbGVfc3RtdHModGVybWluYXRvcnM9eyJkb25lIn0pCiAgICAgICAgc2VsZi5leHBlY3QoImRvbmUiKQoKICAgICAgICBzZWxmLmVtaXQoT1BfSk1QLCBsb29wX3N0YXJ0KQoKICAgICAgICBleGl0X3RhcmdldCA9IGxlbihzZWxmLmNvZGUpCiAgICAgICAgc2VsZi5wYXRjaChmb3JlX25leHQsIGV4aXRfdGFyZ2V0KQogICAgICAgIGZvciBqaWR4IGluIGN0eFsiYnJlYWtfam1wcyJdOgogICAgICAgICAgICBzZWxmLnBhdGNoKGppZHgsIGV4aXRfdGFyZ2V0KQogICAgICAgIHNlbGYubG9vcF9zdGFjay5wb3AoKQoKICAgIGRlZiBjb21waWxlX2JyZWFrKHNlbGYpOgogICAgICAgIHNlbGYuZXhwZWN0KCJicmVhayIpCiAgICAgICAgaWYgbm90IHNlbGYubG9vcF9zdGFjazoKICAgICAgICAgICAgcmFpc2UgQ29tcGlsZUVycm9yKCJicmVhayB1c2VkIG91dHNpZGUgb2Yg",
    "YSBsb29wIikKICAgICAgICBqaWR4ID0gc2VsZi5lbWl0KE9QX0pNUCwgTm9uZSkKICAgICAgICBzZWxmLmxvb3Bfc3RhY2tbLTFdWyJicmVha19qbXBzIl0uYXBwZW5kKGppZHgpCgogICAgZGVmIGNvbXBpbGVfY29udGludWUoc2VsZik6CiAgICAgICAgc2VsZi5leHBlY3QoImNvbnRpbnVlIikKICAgICAgICBpZiBub3Qgc2VsZi5sb29wX3N0YWNrOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoImNvbnRpbnVlIHVzZWQgb3V0c2lkZSBvZiBhIGxvb3AiKQogICAgICAgIHNlbGYuZW1pdChPUF9KTVAsIHNlbGYubG9vcF9zdGFja1stMV1bInN0YXJ0Il0pCgogICAgIyAtLS0tICYmIC8gfHwgY2hhaW5zICsgcmVkaXJlY3Rpb24gLS0tLQogICAgZGVmIGNvbXBpbGVfY2hhaW4oc2VsZiwgc3RvcF90b2tlbnMpOgogICAgICAgICMgYXNzaWdubWVudCBsaWtlIHg9MwogICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgIGlmIHQgaXMgbm90IE5vbmUgYW5kICgiPSIgaW4gdCkgYW5kIChub3QgdC5zdGFydHN3aXRoKCIkIikpIGFuZCAodCAhPSAifCIpOgogICAgICAgICAgICBuYW1lLCB2YWwgPSB0LnNwbGl0KCI9IiwgMSkKICAgICAgICAgICAg",
    "c2VsZi5wb3AoKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCB2YWwpCiAgICAgICAgICAgIHNlbGYuZW1pdChPUF9TRVQsIG5hbWUpCiAgICAgICAgICAgICMgdXBkYXRlIGxhc3RfdHJ1dGggcXVpZXRseSBiYXNlZCBvbiB2YWx1ZQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfTE9BRCwgImVjaG8iKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfR0VULCBuYW1lKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQ1EsIE5vbmUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5jb21waWxlX3BpcGVsaW5lKHN0b3BfdG9rZW5zPXN0b3BfdG9rZW5zLnVuaW9uKHsiJiYiLCAifHwiLCAiPiIsICI+PiJ9KSkKICAgICAgICAgICAgc2VsZi5jb21waWxlX3JlZGlyZWN0aW9uX2lmX3ByZXNlbnQoKQogICAgICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQywgTm9uZSkKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgb3AgPSBzZWxmLnBlZWsoKQogICAgICAgICAgICBpZiBvcCBub3QgaW4gKCImJiIsICJ8fCIpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHNlbGYucG9wKCkKCiAgICAgICAgICAgIGlmIG9wID09ICIm",
    "JiI6CiAgICAgICAgICAgICAgICBza2lwX3JocyA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYuY29tcGlsZV9waXBlbGluZShzdG9wX3Rva2Vucz1zdG9wX3Rva2Vucy51bmlvbih7IiYmIiwgInx8IiwgIj4iLCAiPj4ifSkpCiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfcmVkaXJlY3Rpb25faWZfcHJlc2VudCgpCiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfRVhFQywgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYucGF0Y2goc2tpcF9yaHMsIGxlbihzZWxmLmNvZGUpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcnVuX3JocyA9IHNlbGYuZW1pdChPUF9KWiwgTm9uZSkKICAgICAgICAgICAgICAgIHNraXBfcmhzID0gc2VsZi5lbWl0KE9QX0pNUCwgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYucGF0Y2gocnVuX3JocywgbGVuKHNlbGYuY29kZSkpCiAgICAgICAgICAgICAgICBzZWxmLmNvbXBpbGVfcGlwZWxpbmUoc3RvcF90b2tlbnM9c3RvcF90b2tlbnMudW5pb24oeyImJiIsICJ8fCIsICI+IiwgIj4+In0pKQogICAgICAgICAgICAgICAgc2VsZi5jb21waWxlX3JlZGlyZWN0aW9u",
    "X2lmX3ByZXNlbnQoKQogICAgICAgICAgICAgICAgc2VsZi5lbWl0KE9QX0VYRUMsIE5vbmUpCiAgICAgICAgICAgICAgICBzZWxmLnBhdGNoKHNraXBfcmhzLCBsZW4oc2VsZi5jb2RlKSkKCiAgICBkZWYgY29tcGlsZV9yZWRpcmVjdGlvbl9pZl9wcmVzZW50KHNlbGYpOgogICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgIGlmIHQgbm90IGluICgiPiIsICI+PiIpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBvcCA9IHNlbGYucG9wKCkKICAgICAgICBmbmFtZSA9IHNlbGYucG9wKCkKICAgICAgICBpZiBmbmFtZSBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBDb21waWxlRXJyb3IoInJlZGlyZWN0aW9uIG1pc3NpbmcgZmlsZW5hbWUiKQogICAgICAgIHNlbGYuZW1pdChPUF9QSVBFLCBOb25lKQogICAgICAgIHNlbGYuZW1pdChPUF9MT0FELCAiYXBwZW5kIiBpZiBvcCA9PSAiPj4iIGVsc2UgIndyaXRlIikKICAgICAgICBzZWxmLmVtaXQoT1BfQVJHLCBmbmFtZSkKCiAgICAjIC0tLS0gcGlwZWxpbmVzIC0tLS0KICAgIGRlZiBjb21waWxlX3BpcGVsaW5lKHNlbGYsIHN0b3BfdG9rZW5zKToKICAgICAgICBleHBlY3RpbmdfY21kID0gVHJ1",
    "ZQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHQgPSBzZWxmLnBlZWsoKQogICAgICAgICAgICBpZiB0IGlzIE5vbmUgb3IgdCBpbiBzdG9wX3Rva2VucyBvciB0ID09ICI7IjoKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgaWYgdCA9PSAifCI6CiAgICAgICAgICAgICAgICBzZWxmLnBvcCgpCiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfUElQRSwgTm9uZSkKICAgICAgICAgICAgICAgIGV4cGVjdGluZ19jbWQgPSBUcnVlCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgc2VsZi5wb3AoKQoKICAgICAgICAgICAgaWYgdC5zdGFydHN3aXRoKCIkIikgYW5kIGxlbih0KSA+IDE6CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfR0VULCB0WzE6XSkKICAgICAgICAgICAgICAgIGV4cGVjdGluZ19jbWQgPSBGYWxzZQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIGV4cGVjdGluZ19jbWQ6CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoT1BfTE9BRCwgdCkKICAgICAgICAgICAgICAgIGV4cGVjdGluZ19jbWQgPSBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAg",
    "ICAgICAgc2VsZi5lbWl0KE9QX0FSRywgdCkKCmRlZiBjb21waWxlX2xpbmUobGluZSk6CiAgICB0b2tzID0gdG9rZW5pemUobGluZS5zdHJpcCgpKQogICAgYmcgPSBGYWxzZQogICAgaWYgdG9rcyBhbmQgdG9rc1stMV0gPT0gIiYiOgogICAgICAgIGJnID0gVHJ1ZQogICAgICAgIHRva3MgPSB0b2tzWzotMV0KICAgIGMgPSBDb21waWxlcih0b2tzKQogICAgcmV0dXJuIGMuY29tcGlsZSgpLCBiZwoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIENvb3BlcmF0aXZlIGpvYiBzeXN0ZW0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFzcyBKb2I6CiAgICBfX3Nsb3RzX18gPSAoImppZCIsICJuYW1lIiwgImdlbiIsICJkb25lIiwgImVycm9yIikKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBqaWQsIG5hbWUsIGdlbik6CiAgICAgICAgc2VsZi5qaWQgPSBqaWQKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5nZW4gPSBnZW4KICAgICAgICBzZWxmLmRvbmUgPSBGYWxzZQogICAgICAgIHNlbGYuZXJyb3IgPSBOb25lCgogICAgZGVmIHN0ZXAoc2VsZiwgbj0xKToKICAgICAgICBpZiBzZWxmLmRvbmU6CiAgICAgICAgICAgIHJldHVy",
    "bgogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2Uobik6CiAgICAgICAgICAgICAgICBuZXh0KHNlbGYuZ2VuKQogICAgICAgIGV4Y2VwdCBTdG9wSXRlcmF0aW9uOgogICAgICAgICAgICBzZWxmLmRvbmUgPSBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmRvbmUgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZXJyb3IgPSBlCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgVk0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFzcyBWTToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb21tYW5kcz1Ob25lLCBzcG9vbF9wYXRoPSJTVERPVVQiLCBzcG9vbF90aHJlc2hvbGQ9MjA0OCk6CiAgICAgICAgc2VsZi50b2tlbl9zdGFjayA9IFtdCiAgICAgICAgc2VsZi52YWx1ZV9zdGFjayA9IFtdCiAgICAgICAgc2VsZi52YXJzID0ge30KICAgICAgICBzZWxmLnBjID0gMAogICAgICAgIHNlbGYuY29kZSA9IFtdCiAgICAgICAgc2VsZi5jb21tYW5kcyA9IGNvbW1hbmRzIG9yIHt9CgogICAgICAgIHNlbGYubGFzdF9vdXRwdXQgPSAiIgogICAgICAgIHNlbGYubGFzdF90cnV0aCA9IEZhbHNl",
    "CgogICAgICAgIHNlbGYuc3Bvb2xfcGF0aCA9IHNwb29sX3BhdGgKICAgICAgICBzZWxmLnNwb29sX3RocmVzaG9sZCA9IHNwb29sX3RocmVzaG9sZAoKICAgICAgICBzZWxmLl9mb3JlYWNoX3N0YWNrID0gW10gICMgKHZhcm5hbWUsIGl0ZXJhdG9yKQoKICAgICAgICAjIGpvYnMKICAgICAgICBzZWxmLmpvYnMgPSB7fQogICAgICAgIHNlbGYubmV4dF9qaWQgPSAxCgogICAgICAgICMgc2NoZWR1bGVyLXNhZmUgc2xlZXAgc3RhdGUKICAgICAgICBzZWxmLnNsZWVwX3VudGlsID0gTm9uZQoKICAgIGRlZiBjbG9uZV9mb3Jfam9iKHNlbGYpOgogICAgICAgIGp2bSA9IFZNKGNvbW1hbmRzPXNlbGYuY29tbWFuZHMsIHNwb29sX3BhdGg9c2VsZi5zcG9vbF9wYXRoLCBzcG9vbF90aHJlc2hvbGQ9c2VsZi5zcG9vbF90aHJlc2hvbGQpCiAgICAgICAganZtLnZhcnMgPSBkaWN0KHNlbGYudmFycykKICAgICAgICByZXR1cm4ganZtCgogICAgZGVmIHRydXRoeShzZWxmLCBzKToKICAgICAgICBpZiBzIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHR4dCA9IHN0cihzKS5zdHJpcCgpCiAgICAgICAgaWYgdHh0ID09ICIiOgogICAgICAg",
    "ICAgICByZXR1cm4gRmFsc2UKICAgICAgICBsb3cgPSB0eHQubG93ZXIoKQogICAgICAgIHJldHVybiBsb3cgbm90IGluICgiMCIsICJmYWxzZSIsICJubyIsICJuaWwiKQoKICAgIGRlZiBfbWF5YmVfc3Bvb2woc2VsZiwgb3V0KToKICAgICAgICBpZiBvdXQgaXMgTm9uZToKICAgICAgICAgICAgcyA9ICIiCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKG91dCwgc3RyKToKICAgICAgICAgICAgcyA9IG91dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHMgPSBzdHIob3V0KQoKICAgICAgICBpZiBzZWxmLnNwb29sX3RocmVzaG9sZCBhbmQgbGVuKHMpID49IHNlbGYuc3Bvb2xfdGhyZXNob2xkOgogICAgICAgICAgICB3aXRoIG9wZW4oc2VsZi5zcG9vbF9wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKHMpCiAgICAgICAgICAgIHJldHVybiBQaXBlRGF0YShwYXRoPXNlbGYuc3Bvb2xfcGF0aCwgaXNfZmlsZT1UcnVlKQoKICAgICAgICByZXR1cm4gUGlwZURhdGEodGV4dD1zLCBpc19maWxlPUZhbHNlKQoKICAgIGRlZiBydW4oc2VsZiwgdHJhY2U9RmFsc2UpOgogICAgICAgIHNlbGYucGMgPSAwCiAgICAgICAgd2hpbGUgc2VsZi5w",
    "YyA8IGxlbihzZWxmLmNvZGUpOgogICAgICAgICAgICAjIEZvcmVncm91bmQgc2xlZXA6IGJsb2NrLCBidXQga2VlcCBiYWNrZ3JvdW5kIGpvYnMgYWxpdmUuCiAgICAgICAgICAgIGlmIHNlbGYuc2xlZXBfdW50aWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB3aGlsZSBfdGlja3NfZGlmZihzZWxmLnNsZWVwX3VudGlsLCBfdGlja3NfbXMoKSkgPiAwOgogICAgICAgICAgICAgICAgICAgIHNlbGYucG9sbF9qb2JzKHN0ZXBzPTgwKQogICAgICAgICAgICAgICAgICAgIF9zbGVlcF9tcygyMCkKICAgICAgICAgICAgICAgIHNlbGYuc2xlZXBfdW50aWwgPSBOb25lCgogICAgICAgICAgICBvcCwgYXJnID0gc2VsZi5jb2RlW3NlbGYucGNdCiAgICAgICAgICAgIHNlbGYucGMgKz0gMQoKICAgICAgICAgICAgaWYgdHJhY2U6CiAgICAgICAgICAgICAgICBwcmludCgiUEMiLCBzZWxmLnBjLTEsICJPUCIsIG9wLCAiQVJHIiwgYXJnKQoKICAgICAgICAgICAgaWYgb3AgPT0gT1BfTE9BRDoKICAgICAgICAgICAgICAgIHNlbGYudG9rZW5fc3RhY2suYXBwZW5kKCgiY21kIiwgYXJnKSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfQVJHOgogICAgICAg",
    "ICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJhcmciLCBhcmcpKQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjay5hcHBlbmQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9QSVBFOgogICAgICAgICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJwaXBlIiwgTm9uZSkpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVDoKICAgICAgICAgICAgICAgIHZhbCA9IHNlbGYudmFsdWVfc3RhY2sucG9wKCkgaWYgc2VsZi52YWx1ZV9zdGFjayBlbHNlICIiCiAgICAgICAgICAgICAgICBzZWxmLnZhcnNbYXJnXSA9IHZhbAoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9HRVQ6CiAgICAgICAgICAgICAgICB2YWwgPSBzZWxmLnZhcnMuZ2V0KGFyZywgIiIpCiAgICAgICAgICAgICAgICBzZWxmLnRva2VuX3N0YWNrLmFwcGVuZCgoImFyZyIsIHZhbCkpCiAgICAgICAgICAgICAgICBzZWxmLnZhbHVlX3N0YWNrLmFwcGVuZCh2YWwpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VYRUMgb3Igb3AgPT0gT1BfRVhFQ1E6CiAgICAgICAgICAgICAgICBvdXQgPSBzZWxmLmV4ZWNfcGlwZWxpbmUoKQogICAgICAg",
    "ICAgICAgICAgc2VsZi5sYXN0X291dHB1dCA9IG91dAogICAgICAgICAgICAgICAgc2VsZi5sYXN0X3RydXRoID0gc2VsZi50cnV0aHkob3V0KQogICAgICAgICAgICAgICAgaWYgb3AgPT0gT1BfRVhFQyBhbmQgb3V0IGlzIG5vdCBOb25lIGFuZCBvdXQgIT0gIiI6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQob3V0KQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjayA9IFtdCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0pNUDoKICAgICAgICAgICAgICAgIHNlbGYucGMgPSBpbnQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9KWjoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmxhc3RfdHJ1dGg6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVExJU1Q6CiAgICAgICAgICAgICAgICBuYW1lLCBpdGVtcyA9IGFyZwogICAgICAgICAgICAgICAgc2VsZi52YXJzW25hbWVdID0gbGlzdChpdGVtcykKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfU1BMSVRMOgogICAgICAgICAgICAgICAgcyA9ICIiIGlmIHNlbGYubGFzdF9vdXRwdXQgaXMgTm9uZSBl",
    "bHNlIHN0cihzZWxmLmxhc3Rfb3V0cHV0KQogICAgICAgICAgICAgICAgc2VsZi52YXJzW2FyZ10gPSBzLnNwbGl0bGluZXMoKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9GT1JFX0lOSVQ6CiAgICAgICAgICAgICAgICB2YXJuYW1lLCBsaXN0bmFtZSA9IGFyZwogICAgICAgICAgICAgICAgaXRlbXMgPSBzZWxmLnZhcnMuZ2V0KGxpc3RuYW1lLCBbXSkKICAgICAgICAgICAgICAgIGlmIGl0ZW1zIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSBbXQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtcywgc3RyKToKICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IGl0ZW1zLnNwbGl0bGluZXMoKQogICAgICAgICAgICAgICAgaXQgPSBpdGVyKGl0ZW1zKQogICAgICAgICAgICAgICAgc2VsZi5fZm9yZWFjaF9zdGFjay5hcHBlbmQoKHZhcm5hbWUsIGl0KSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfRk9SRV9ORVhUOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2ZvcmVhY2hfc3RhY2s6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAg",
    "ICAgICAgICAgICAgIHZhcm5hbWUsIGl0ID0gc2VsZi5fZm9yZWFjaF9zdGFja1stMV0KICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG54dCA9IG5leHQoaXQpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudmFyc1t2YXJuYW1lXSA9IHN0cihueHQpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFN0b3BJdGVyYXRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2ZvcmVhY2hfc3RhY2sucG9wKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VORDoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJVbmtub3duIG9wY29kZTogJXIiICUgb3ApCgogICAgICAgIHJldHVybiBzZWxmLmxhc3Rfb3V0cHV0CgogICAgZGVmIHJ1bl9nZW5lcmF0b3Ioc2VsZik6CiAgICAgICAgIyBDb29wZXJhdGl2ZSBydW5uZXI6IHlpZWxkcyBmcmVxdWVudGx5IHNvIGl0IGNhbiBiZSB1c2VkIGFzIGEgYmFja2dyb3VuZCBqb2IuCiAgICAgICAgc2VsZi5w",
    "YyA9IDAKICAgICAgICB3aGlsZSBzZWxmLnBjIDwgbGVuKHNlbGYuY29kZSk6CiAgICAgICAgICAgICMgQmFja2dyb3VuZCBzbGVlcDogeWllbGQgcXVpY2tseSB1bnRpbCB3YWtlIHRpbWUgKG5vIHJlLWVudHJhbmN5KS4KICAgICAgICAgICAgaWYgc2VsZi5zbGVlcF91bnRpbCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmIF90aWNrc19kaWZmKHNlbGYuc2xlZXBfdW50aWwsIF90aWNrc19tcygpKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgeWllbGQgTm9uZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2xlZXBfdW50aWwgPSBOb25lCgogICAgICAgICAgICBvcCwgYXJnID0gc2VsZi5jb2RlW3NlbGYucGNdCiAgICAgICAgICAgIHNlbGYucGMgKz0gMQoKICAgICAgICAgICAgaWYgb3AgPT0gT1BfTE9BRDoKICAgICAgICAgICAgICAgIHNlbGYudG9rZW5fc3RhY2suYXBwZW5kKCgiY21kIiwgYXJnKSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfQVJHOgogICAgICAgICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJhcmciLCBhcmcp",
    "KQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjay5hcHBlbmQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9QSVBFOgogICAgICAgICAgICAgICAgc2VsZi50b2tlbl9zdGFjay5hcHBlbmQoKCJwaXBlIiwgTm9uZSkpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVDoKICAgICAgICAgICAgICAgIHZhbCA9IHNlbGYudmFsdWVfc3RhY2sucG9wKCkgaWYgc2VsZi52YWx1ZV9zdGFjayBlbHNlICIiCiAgICAgICAgICAgICAgICBzZWxmLnZhcnNbYXJnXSA9IHZhbAoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9HRVQ6CiAgICAgICAgICAgICAgICB2YWwgPSBzZWxmLnZhcnMuZ2V0KGFyZywgIiIpCiAgICAgICAgICAgICAgICBzZWxmLnRva2VuX3N0YWNrLmFwcGVuZCgoImFyZyIsIHZhbCkpCiAgICAgICAgICAgICAgICBzZWxmLnZhbHVlX3N0YWNrLmFwcGVuZCh2YWwpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VYRUMgb3Igb3AgPT0gT1BfRVhFQ1E6CiAgICAgICAgICAgICAgICBvdXQgPSBzZWxmLmV4ZWNfcGlwZWxpbmUoKQogICAgICAgICAgICAgICAgc2VsZi5sYXN0X291dHB1dCA9IG91dAogICAgICAgICAgICAg",
    "ICAgc2VsZi5sYXN0X3RydXRoID0gc2VsZi50cnV0aHkob3V0KQogICAgICAgICAgICAgICAgc2VsZi52YWx1ZV9zdGFjayA9IFtdCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0pNUDoKICAgICAgICAgICAgICAgIHNlbGYucGMgPSBpbnQoYXJnKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9KWjoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmxhc3RfdHJ1dGg6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX1NFVExJU1Q6CiAgICAgICAgICAgICAgICBuYW1lLCBpdGVtcyA9IGFyZwogICAgICAgICAgICAgICAgc2VsZi52YXJzW25hbWVdID0gbGlzdChpdGVtcykKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfU1BMSVRMOgogICAgICAgICAgICAgICAgcyA9ICIiIGlmIHNlbGYubGFzdF9vdXRwdXQgaXMgTm9uZSBlbHNlIHN0cihzZWxmLmxhc3Rfb3V0cHV0KQogICAgICAgICAgICAgICAgc2VsZi52YXJzW2FyZ10gPSBzLnNwbGl0bGluZXMoKQoKICAgICAgICAgICAgZWxpZiBvcCA9PSBPUF9GT1JFX0lOSVQ6CiAgICAgICAgICAgICAgICB2YXJuYW1lLCBsaXN0bmFt",
    "ZSA9IGFyZwogICAgICAgICAgICAgICAgaXRlbXMgPSBzZWxmLnZhcnMuZ2V0KGxpc3RuYW1lLCBbXSkKICAgICAgICAgICAgICAgIGlmIGl0ZW1zIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSBbXQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtcywgc3RyKToKICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IGl0ZW1zLnNwbGl0bGluZXMoKQogICAgICAgICAgICAgICAgaXQgPSBpdGVyKGl0ZW1zKQogICAgICAgICAgICAgICAgc2VsZi5fZm9yZWFjaF9zdGFjay5hcHBlbmQoKHZhcm5hbWUsIGl0KSkKCiAgICAgICAgICAgIGVsaWYgb3AgPT0gT1BfRk9SRV9ORVhUOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2ZvcmVhY2hfc3RhY2s6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHZhcm5hbWUsIGl0ID0gc2VsZi5fZm9yZWFjaF9zdGFja1stMV0KICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG54dCA9IG5leHQoaXQpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYu",
    "dmFyc1t2YXJuYW1lXSA9IHN0cihueHQpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFN0b3BJdGVyYXRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2ZvcmVhY2hfc3RhY2sucG9wKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wYyA9IGludChhcmcpCgogICAgICAgICAgICBlbGlmIG9wID09IE9QX0VORDoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICB5aWVsZCBOb25lICAjIGNvb3BlcmF0ZSBvZnRlbgoKICAgIGRlZiBleGVjX3BpcGVsaW5lKHNlbGYpOgogICAgICAgIGl0ZW1zID0gc2VsZi50b2tlbl9zdGFjawogICAgICAgIHNlbGYudG9rZW5fc3RhY2sgPSBbXQoKICAgICAgICBwaXBlbGluZSA9IFtdCiAgICAgICAgY3VycmVudF9jbWQgPSBOb25lCiAgICAgICAgY3VycmVudF9hcmdzID0gW10KCiAgICAgICAgZGVmIGZsdXNoKCk6CiAgICAgICAgICAgIG5vbmxvY2FsIGN1cnJlbnRfY21kLCBjdXJyZW50X2FyZ3MKICAgICAgICAgICAgaWYgY3VycmVudF9jbWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBwaXBlbGluZS5hcHBlbmQoKGN1cnJlbnRfY21kLCBjdXJyZW50X2FyZ3MpKQogICAg",
    "ICAgICAgICBjdXJyZW50X2NtZCA9IE5vbmUKICAgICAgICAgICAgY3VycmVudF9hcmdzID0gW10KCiAgICAgICAgZm9yIGtpbmQsIHZhbCBpbiBpdGVtczoKICAgICAgICAgICAgaWYga2luZCA9PSAicGlwZSI6CiAgICAgICAgICAgICAgICBmbHVzaCgpCiAgICAgICAgICAgIGVsaWYga2luZCA9PSAiY21kIjoKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfY21kIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGZsdXNoKCkKICAgICAgICAgICAgICAgIGN1cnJlbnRfY21kID0gdmFsCiAgICAgICAgICAgIGVsaWYga2luZCA9PSAiYXJnIjoKICAgICAgICAgICAgICAgIGN1cnJlbnRfYXJncy5hcHBlbmQodmFsKQoKICAgICAgICBmbHVzaCgpCgogICAgICAgIG91dCA9IFBpcGVEYXRhKHRleHQ9IiIsIGlzX2ZpbGU9RmFsc2UpCiAgICAgICAgZm9yIGNtZCwgYXJncyBpbiBwaXBlbGluZToKICAgICAgICAgICAgb3V0X3JhdyA9IHNlbGYucnVuX2NvbW1hbmQoY21kLCBhcmdzLCBvdXQpCiAgICAgICAgICAgIG91dCA9IHNlbGYuX21heWJlX3Nwb29sKG91dF9yYXcpCgogICAgICAgIHJldHVybiBvdXQuYXNfdGV4dCgpCgogICAgZGVmIHJ1bl9j",
    "b21tYW5kKHNlbGYsIGNtZCwgYXJncywgaW5wdXRfZGF0YSk6CiAgICAgICAgZ2xvYmFsIF9DVVJSRU5UX1ZNCiAgICAgICAgZm4gPSBzZWxmLmNvbW1hbmRzLmdldChjbWQpCiAgICAgICAgaWYgZm4gaXMgTm9uZToKICAgICAgICAgICAgIyBBdXRvLXJlc29sdmU6IGlmIC9saWIvPGNtZD4ucHkgZXhpc3RzLCB0cmVhdCBpdCBsaWtlOiBydW4gPGNtZD4gPGFyZ3MuLi4+CiAgICAgICAgICAgICMgVGhpcyBtYWtlcyBpbnN0YWxsZWQgbW9kdWxlcyBmZWVsIGxpa2UgYnVpbHQtaW4gY29tbWFuZHMuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxpYl9wYXRoID0gIi9saWIvJXMucHkiICUgY21kCiAgICAgICAgICAgICAgICBvcy5zdGF0KGxpYl9wYXRoKSAgIyBleGlzdHM/CiAgICAgICAgICAgICAgICBydW5mbiA9IHNlbGYuY29tbWFuZHMuZ2V0KCJydW4iKQogICAgICAgICAgICAgICAgaWYgcnVuZm4gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgX0NVUlJFTlRfVk0gPSBzZWxmCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJ1bmZuKFtjbWRdICsgbGlzdChhcmdzKSwgaW5wdXRfZGF0YSkKICAgICAgICAgICAgZXhjZXB0",
    "IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuICJFcnJvcjogY29tbWFuZCBub3QgZm91bmQ6ICVzIiAlIGNtZAogICAgICAgIF9DVVJSRU5UX1ZNID0gc2VsZgogICAgICAgIHJldHVybiBmbihhcmdzLCBpbnB1dF9kYXRhKQoKICAgICMgLS0tLSBqb2JzIC0tLS0KICAgIGRlZiBzdGFydF9qb2Ioc2VsZiwgY29kZSwgbmFtZSk6CiAgICAgICAganZtID0gc2VsZi5jbG9uZV9mb3Jfam9iKCkKICAgICAgICBqdm0uY29kZSA9IGNvZGUKICAgICAgICBqaWQgPSBzZWxmLm5leHRfamlkCiAgICAgICAgc2VsZi5uZXh0X2ppZCArPSAxCiAgICAgICAgc2VsZi5qb2JzW2ppZF0gPSBKb2IoamlkLCBuYW1lLCBqdm0ucnVuX2dlbmVyYXRvcigpKQogICAgICAgIHJldHVybiBqaWQKCiAgICBkZWYgcG9sbF9qb2JzKHNlbGYsIHN0ZXBzPTUwKToKICAgICAgICBkZWFkID0gW10KICAgICAgICBmb3IgamlkLCBqb2IgaW4gc2VsZi5qb2JzLml0ZW1zKCk6CiAgICAgICAgICAgIGpvYi5zdGVwKG49c3RlcHMpCiAgICAgICAgICAgIGlmIGpvYi5kb25lOgogICAgICAgICAgICAgICAgZGVhZC5hcHBlbmQoamlkKQoKICAgICAgICBm",
    "b3IgamlkIGluIGRlYWQ6CiAgICAgICAgICAgIGpvYiA9IHNlbGYuam9ic1tqaWRdCiAgICAgICAgICAgIGlmIGpvYi5lcnJvcjoKICAgICAgICAgICAgICAgIHByaW50KCJbe31dIHt9IChlcnJvcjoge30pIi5mb3JtYXQoamlkLCBqb2IubmFtZSwgam9iLmVycm9yKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KCJbe31dIHt9IChkb25lKSIuZm9ybWF0KGppZCwgam9iLm5hbWUpKQogICAgICAgICAgICBkZWwgc2VsZi5qb2JzW2ppZF0KCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBzbGVlcCBjb21tYW5kIChzY2hlZHVsZXItc2FmZSwgd29ya3MgZm9yIGJnIGpvYnMpCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZGVmIGNtZF9zbGVlcChhcmdzLCBpbnB1dF9kYXRhKToKICAgIGdsb2JhbCBfQ1VSUkVOVF9WTQogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICIiCgoKZGVmIGNtZF9ydW4oYXJncywgaW5wdXRfZGF0YSk6CiAgICAjIHJ1biA8bW9kdWxlPiBbYXJncy4uLl0KICAgICMgSW1wb3J0cyBtb2R1bGUgKHR5cGljYWxseSBmcm9tIC9saWIpIGFuZCBjYWxscyBpdHMgbWFpbihhcmd2KSBpZiBwcmVzZW50",
    "LgogICAgIyBhcmd2IGlzIGEgbGlzdCBvZiBzdHJpbmdzOiBlLmcuIFsiaW5zdGFsbCIsInVwaW5nIl0uCiAgICBpZiBub3QgYXJnczoKICAgICAgICByZXR1cm4gInJ1bjogdXNhZ2UgcnVuIDxtb2R1bGU+IFthcmdzLi4uXVxuIgogICAgbW9kbmFtZSA9IGFyZ3NbMF0KICAgIGFyZ3YgPSBbc3RyKGEpIGZvciBhIGluIGFyZ3NbMTpdXQoKICAgICMgQWxsb3cgImZvby5weSIgYXMgbW9kdWxlIG5hbWUKICAgIGlmIG1vZG5hbWUuZW5kc3dpdGgoIi5weSIpOgogICAgICAgIG1vZG5hbWUgPSBtb2RuYW1lWzotM10KCiAgICAjIEVuc3VyZSAvbGliIGlzIG9uIHBhdGggKE1pY3JvUHl0aG9uIHVzdWFsbHkgaW5jbHVkZXMgaXQsIGJ1dCBtYWtlIGl0IHJvYnVzdCkKICAgIHRyeToKICAgICAgICBpZiAiL2xpYiIgbm90IGluIHN5cy5wYXRoOgogICAgICAgICAgICBzeXMucGF0aC5hcHBlbmQoIi9saWIiKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgdHJ5OgogICAgICAgIG1vZCA9IF9faW1wb3J0X18obW9kbmFtZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gInJ1bjogY291bGRuJ3QgaW1wb3J0ICVz",
    "ICglcylcbiIgJSAobW9kbmFtZSwgZSkKCiAgICAjIFByZWZlciBtYWluKGFyZ3YpLiBGYWxsYmFjayB0byBydW4oYXJndikuCiAgICBmbiA9IGdldGF0dHIobW9kLCAibWFpbiIsIE5vbmUpCiAgICBpZiBmbiBpcyBOb25lOgogICAgICAgIGZuID0gZ2V0YXR0cihtb2QsICJydW4iLCBOb25lKQoKICAgIGlmIGZuIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuICJydW46ICVzIGhhcyBubyBtYWluKGFyZ3YpXG4iICUgbW9kbmFtZQoKICAgIHRyeToKICAgICAgICByZXMgPSBmbihhcmd2KQogICAgICAgIGlmIHJlcyBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICByZXR1cm4gc3RyKHJlcykKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gInJ1bjogZXJyb3IgcnVubmluZyAlczogJXNcbiIgJSAobW9kbmFtZSwgZSkKCiAgICB0cnk6CiAgICAgICAgc2VjcyA9IGZsb2F0KGFyZ3NbMF0pCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiIgogICAgbXMgPSBpbnQoc2VjcyAqIDEwMDApCiAgICBpZiBtcyA8PSAwOgogICAgICAgIHJldHVybiAiIgogICAgaWYgX0NVUlJFTlRfVk0gaXMgTm9uZToK",
    "ICAgICAgICByZXR1cm4gIiIKICAgIF9DVVJSRU5UX1ZNLnNsZWVwX3VudGlsID0gX3RpY2tzX2FkZChfdGlja3NfbXMoKSwgbXMpCiAgICByZXR1cm4gIiIKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBDb21tYW5kcyAoU2lnbmF0dXJlOiBmbihhcmdzLCBpbnB1dF9kYXRhKS0+c3RyKQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmRlZiBjbWRfaGVscChhcmdzLCBpbnB1dF9kYXRhKToKICAgIHJldHVybiAoCiAgICAgICAgIlBVU0ggdmVyOiAiICsgVkVSU0lPTiArICJcblxuIgogICAgICAgICJjb21tYW5kczogZXhpdCwgbHMsIHVuYW1lLCBmcmVlLCBkZiwgcHdkLCBjYXQsIGNwLCBjZCwgbWtkaXIsXG4iCiAgICAgICAgImdyZXAsIHJtZGlyLCBleGVjLCBybSwgZGF0ZSxcbiIKICAgICAgICAic2NhbndpZmksIGNvbm5lY3QsIGlmY29uZmlnLCBlZGl0LCByZW5hbWVcbiIKICAgICAgICAiZXh0cmFzOiBlY2hvLCB1cHBlciwgd2MsIHRlc3QsIHdyaXRlICg+KSwgYXBwZW5kICg+PiksIHNsZWVwXG4iCiAgICAgICAgImZsb3c6IGlmL3doaWxlL2Zvci9mb3JlYWNoLCBicmVhay9jb250aW51ZSwgJiYvfHwsIHZhcnMgeD12YWwgJHgsIGpvYnMg",
    "JlxuIgogICAgICAgICJqb2JjdGw6IGpvYnMsIGtpbGwgPGlkPiwgZmcgPGlkPlxuIgogICAgKQoKZGVmIGNtZF9scyhhcmdzLCBpbnB1dF9kYXRhKToKICAgIHBhdGggPSBhcmdzWzBdIGlmIGFyZ3MgZWxzZSAiIgogICAgdHJ5OgogICAgICAgIGlmIHBhdGg6CiAgICAgICAgICAgIHJldHVybiAiXG4iLmpvaW4ob3MubGlzdGRpcihwYXRoKSkKICAgICAgICByZXR1cm4gIlxuIi5qb2luKG9zLmxpc3RkaXIoKSkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJTeW50YXggRXJyb3JcbiIKCmRlZiBjbWRfdW5hbWUoYXJncywgaW5wdXRfZGF0YSk6CiAgICB0cnk6CiAgICAgICAgcmV0dXJuICJcbiIuam9pbihvcy51bmFtZSgpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gInVuYW1lIG5vdCBzdXBwb3J0ZWRcbiIKCmRlZiBjbWRfZnJlZShhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIGdjIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuICJmcmVlIG5vdCBzdXBwb3J0ZWRcbiIKICAgIHJldHVybiBzdHIoZ2MubWVtX2ZyZWUoKSkKCmRlZiBjbWRfZGYoYXJncywgaW5wdXRfZGF0YSk6CiAgICB0cnk6CiAgICAgICAgc3Qg",
    "PSBvcy5zdGF0dmZzKCIvIikKICAgICAgICB0b3RhbCA9IGZsb2F0KHN0WzJdKSAqIGZsb2F0KHN0WzBdKQogICAgICAgIHVzZWQgID0gZmxvYXQoc3RbM10pICogZmxvYXQoc3RbMF0pCiAgICAgICAgZnJlZSAgPSB0b3RhbCAtIHVzZWQKICAgICAgICByZXR1cm4gIkZyZWU6ICVzIFVzZWQ6ICVzIFRvdGFsOiAlcyIgJSAoZnJlZSwgdXNlZCwgdG90YWwpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiZGYgZXJyb3JcbiIKCmRlZiBjbWRfcHdkKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgcmV0dXJuIG9zLmdldGN3ZCgpCgpkZWYgY21kX2NkKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgcGF0aCA9IGFyZ3NbMF0gaWYgYXJncyBlbHNlICIiCiAgICB0cnk6CiAgICAgICAgb3MuY2hkaXIocGF0aCkKICAgICAgICByZXR1cm4gcGF0aAogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkVycm9yLiBDb3VsZG4ndCBjZFxuIgoKZGVmIGNtZF9jYXQoYXJncywgaW5wdXRfZGF0YSk6CiAgICBpZiBhcmdzOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGFyZ3NbMF0sICJyIikgYXMgZjoKICAgICAgICAgICAgICAg",
    "IHJldHVybiBmLnJlYWQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiAiQ291bGRuJ3Qgb3BlbiBmaWxlXG4iCiAgICByZXR1cm4gaW5wdXRfZGF0YS5hc190ZXh0KCkgaWYgaW5wdXRfZGF0YSBpcyBub3QgTm9uZSBlbHNlICIiCgpkZWYgY21kX3djKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgdHJ5OgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHggPSAwCiAgICAgICAgICAgIHdpdGggb3BlbihhcmdzWzBdLCAiciIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgXyBpbiBmOgogICAgICAgICAgICAgICAgICAgIHggKz0gMQogICAgICAgICAgICByZXR1cm4gc3RyKHgpICsgIlxuIgogICAgICAgIHMgPSBpbnB1dF9kYXRhLmFzX3RleHQoKSBpZiBpbnB1dF9kYXRhIGlzIG5vdCBOb25lIGVsc2UgIiIKICAgICAgICByZXR1cm4gc3RyKGxlbihzLnNwbGl0bGluZXMoKSkpICsgIlxuIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IG9wZW4gZmlsZVxuIgoKZGVmIGNtZF9ncmVwKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaW1wb3J0IHJlCiAgICBpZiBub3QgYXJnczoKICAgICAg",
    "ICByZXR1cm4gIiIKICAgIHJneCA9IGFyZ3NbMF0KICAgIG91dCA9IFtdCiAgICB0cnk6CiAgICAgICAgaWYgbGVuKGFyZ3MpID49IDI6CiAgICAgICAgICAgIHdpdGggb3BlbihhcmdzWzFdLCAiciIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGlmIHJlLnNlYXJjaChyZ3gsIGxpbmUpOgogICAgICAgICAgICAgICAgICAgICAgICBvdXQuYXBwZW5kKGxpbmUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgciA9IGlucHV0X2RhdGEub3Blbl9yZWFkZXIoKSBpZiBpbnB1dF9kYXRhIGlzIG5vdCBOb25lIGVsc2UgX1N0cmluZ0xpbmVSZWFkZXIoIiIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIHI6CiAgICAgICAgICAgICAgICAgICAgaWYgcmUuc2VhcmNoKHJneCwgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIG91dC5hcHBlbmQobGluZSkKICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgIHRyeTogci5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICByZXR1cm4gIiIuam9pbihvdXQpCiAgICBleGNlcHQg",
    "RXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3QgcGVyZm9ybS5cbiIKCmRlZiBjbWRfY3AoYXJncywgaW5wdXRfZGF0YSk6CiAgICBpZiBsZW4oYXJncykgPCAyOgogICAgICAgIHJldHVybiAiQ291bGRuJ3QgY29weS5cbiIKICAgIHNyYywgZHN0ID0gYXJnc1swXSwgYXJnc1sxXQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihzcmMsICJyIikgYXMgZjoKICAgICAgICAgICAgZGF0YSA9IGYucmVhZCgpCiAgICAgICAgd2l0aCBvcGVuKGRzdCwgInciKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGRhdGEpCiAgICAgICAgcmV0dXJuICJGaWxlICIgKyBzcmMgKyAiIGNvcGllZC4iCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3QgY29weS5cbiIKCmRlZiBjbWRfcmVuYW1lKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaWYgbGVuKGFyZ3MpIDwgMjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IHJlbmFtZVxuIgogICAgc3JjLCBkc3QgPSBhcmdzWzBdLCBhcmdzWzFdCiAgICB0cnk6CiAgICAgICAgb3MucmVuYW1lKHNyYywgZHN0KQogICAgICAgIHJldHVybiBzcmMgKyAiIHJlbmFtZWQuLiIKICAgIGV4Y2Vw",
    "dCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCByZW5hbWVcbiIKCmRlZiBjbWRfbWtkaXIoYXJncywgaW5wdXRfZGF0YSk6CiAgICBuYW1lID0gYXJnc1swXSBpZiBhcmdzIGVsc2UgIiIKICAgIHRyeToKICAgICAgICBvcy5ta2RpcihuYW1lKQogICAgICAgIHJldHVybiAiRGlyZWN0b3J5ICIgKyBuYW1lICsgIiBjcmVhdGVkLlxuIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IG1ha2UgZGlyZWN0b3J5XG4iCgpkZWYgY21kX3JtZGlyKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgbmFtZSA9IGFyZ3NbMF0gaWYgYXJncyBlbHNlICIiCiAgICB0cnk6CiAgICAgICAgb3Mucm1kaXIobmFtZSkKICAgICAgICByZXR1cm4gIlJlbW92ZWQgIiArIG5hbWUgKyAiLlxuIgogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IHJlbW92ZSBkaXIuXG4iCgpkZWYgY21kX3JtKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgbmFtZSA9IGFyZ3NbMF0gaWYgYXJncyBlbHNlICIiCiAgICB0cnk6CiAgICAgICAgb3MudW5saW5rKG5hbWUpCiAgICAgICAgcmV0dXJuICJSZW1vdmVkIGZpbGUgIiAr",
    "IG5hbWUgKyAiXG4iCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3QgcmVtb3ZlIGZpbGVcbiIKCmRlZiBjbWRfZGF0ZShhcmdzLCBpbnB1dF9kYXRhKToKICAgIGRhdGVUaW1lT2JqID0gdGltZS5sb2NhbHRpbWUoKQogICAgeWVhcixtb250aCxkYXksaG91cixtaW51LHNlYyx3ZGF5LHlkYXkgPSAoZGF0ZVRpbWVPYmopCiAgICByZXR1cm4gIiVzLyVzLyVzICVzOiVzOiVzIiAlIChtb250aCwgZGF5LCB5ZWFyLCBob3VyLCBtaW51LCBzZWMpCgpkZWYgY21kX2V4ZWMoYXJncywgaW5wdXRfZGF0YSk6CiAgICAjIGV4ZWMgbW9kdWxlLmZ1bmMoImFyZyIpCiAgICBpbXBvcnQgcmUKICAgIHMgPSAiICIuam9pbihhcmdzKQogICAgaWYgIi4iIG5vdCBpbiBzIG9yICIoIiBub3QgaW4gcyBvciAiKSIgbm90IGluIHM6CiAgICAgICAgcmV0dXJuICJFcnJvcjogQ2hlY2sgU3ludGF4XG4iCiAgICB0cnk6CiAgICAgICAgbW9kdWxlID0gcmUuc2VhcmNoKHIiXiguKj8pXC4iLCBzKS5ncm91cCgxKQogICAgICAgIHJlc3QgPSBzW2xlbihtb2R1bGUpKzE6XQogICAgICAgIGZ1bmMgPSByZS5zZWFyY2gociJeKC4qPylcKCIsIHJlc3Qp",
    "Lmdyb3VwKDEpCiAgICAgICAgYXJnc3RyID0gcmUuc2VhcmNoKHIiXCgoLio/KVwpIiwgcmVzdCkuZ3JvdXAoMSkKCiAgICAgICAgc2NyaXB0ID0gZ2V0YXR0cihfX2ltcG9ydF9fKG1vZHVsZSksIGZ1bmMpCiAgICAgICAgaWYgbm90IGFyZ3N0cjoKICAgICAgICAgICAgcmV0dXJuIHN0cihzY3JpcHQoKSkKICAgICAgICBhcmdzdHIgPSBhcmdzdHIucmVwbGFjZSgnIicsICIiKQogICAgICAgIHJldHVybiBzdHIoc2NyaXB0KGFyZ3N0cikpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiRXJyb3I6IENoZWNrIFN5bnRheFxuIgoKZGVmIGNtZF9zY2Fud2lmaShhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIG5ldHdvcmsgaXMgTm9uZToKICAgICAgICByZXR1cm4gInNjYW53aWZpOiBuZXR3b3JrIG1vZHVsZSBub3QgYXZhaWxhYmxlXG4iCiAgICB0cnk6CiAgICAgICAgd2xhbiA9IG5ldHdvcmsuV0xBTihuZXR3b3JrLlNUQV9JRikKICAgICAgICB3bGFuLmFjdGl2ZShUcnVlKQogICAgICAgIG5ldHMgPSB3bGFuLnNjYW4oKQogICAgICAgIG91dCA9IFtdCiAgICAgICAgZm9yIGkgaW4gbmV0czoKICAgICAgICAgICAgdHJ5OgogICAgICAg",
    "ICAgICAgICAgb3V0LmFwcGVuZChpWzBdLmRlY29kZSgpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgb3V0LmFwcGVuZChzdHIoaVswXSkpCiAgICAgICAgcmV0dXJuICJcbiIuam9pbihvdXQpICsgKCJcbiIgaWYgb3V0IGVsc2UgIiIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3Qgc2NhbiBuZXR3b3Jrcy5cbiIKCmRlZiBjbWRfY29ubmVjdChhcmdzLCBpbnB1dF9kYXRhKToKICAgIGlmIG5ldHdvcmsgaXMgTm9uZToKICAgICAgICByZXR1cm4gImNvbm5lY3Q6IG5ldHdvcmsgbW9kdWxlIG5vdCBhdmFpbGFibGVcbiIKICAgIHByaW50KCJFbnRlciBTU0lEOiAiKQogICAgc3NpZCA9IGlucHV0KCkKICAgIHByaW50KCJFbnRlciB3aWZpIHB3OiAiKQogICAgd2lmaXB3ID0gaW5wdXQoKQogICAgdHJ5OgogICAgICAgIHByaW50KCJhdHRlbXB0aW5nIHRvIGNvbm5lY3QuLlxuIikKICAgICAgICB3bGFuID0gbmV0d29yay5XTEFOKG5ldHdvcmsuU1RBX0lGKQogICAgICAgIHdsYW4uYWN0aXZlKFRydWUpCiAgICAgICAgd2xhbi5jb25uZWN0KHNzaWQsIHdpZmlwdykKICAgICAgICB0",
    "aW1lLnNsZWVwKDUpCiAgICAgICAgcmV0dXJuICJDaGVjayBpZmNvbmZpZy4uXG4iCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiRXJyb3I6IGNvdWxkbid0IG9idGFpbiBhZGRyZXNzXG4iCgpkZWYgY21kX2lmY29uZmlnKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaWYgbmV0d29yayBpcyBOb25lOgogICAgICAgIHJldHVybiAiaWZjb25maWc6IG5ldHdvcmsgbW9kdWxlIG5vdCBhdmFpbGFibGVcbiIKICAgIHRyeToKICAgICAgICB3bGFuID0gbmV0d29yay5XTEFOKG5ldHdvcmsuU1RBX0lGKQogICAgICAgIHN0YXR1cyA9IHdsYW4uaWZjb25maWcoKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICJcbklQLi4uLi4uLi4uLi4gIiArIHN0YXR1c1swXSArCiAgICAgICAgICAgICJcbk5FVE1BU0suLi4uLi4uIiArIHN0YXR1c1sxXSArICJcbiIgKwogICAgICAgICAgICAiR0FURVdBWS4uLi4uLi4iICsgc3RhdHVzWzJdCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIkNvdWxkbid0IGdldCBpbnRlcmZhY2Ugb3IgY2hlY2sgc3ludGF4LlxuIgoKZGVmIGNtZF9lZGl0KGFyZ3MsIGlucHV0X2Rh",
    "dGEpOgogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCB3cml0ZSBmaWxlXG4iCiAgICBwYXRoID0gYXJnc1swXQogICAgcHJpbnQoIkVESVQgTU9ERSBERVRFQ1RFRC4uLlxuIikKICAgIHByaW50KCIoRU5URVIgU1RPUEVESVQgdG8gc3RvcClcbiIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IikgYXMgZjoKICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgIGxpbmUgPSBpbnB1dCgpCiAgICAgICAgICAgICAgICBpZiAiU1RPUEVESVQiIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGYud3JpdGUobGluZSArICJcbiIpCiAgICAgICAgcmV0dXJuICJGaWxlICIgKyBwYXRoICsgIiBjcmVhdGVkLi5cbiIKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJDb3VsZG4ndCB3cml0ZSBmaWxlXG4iCgojIGV4dHJhcwpkZWYgY21kX2VjaG8oYXJncywgaW5wdXRfZGF0YSk6CiAgICByZXR1cm4gIiAiLmpvaW4oW3N0cihhKSBmb3IgYSBpbiBhcmdzXSkKCmRlZiBjbWRfdXBwZXIoYXJncywgaW5wdXRfZGF0YSk6CiAgICBzID0gaW5wdXRf",
    "ZGF0YS5hc190ZXh0KCkgaWYgaW5wdXRfZGF0YSBpcyBub3QgTm9uZSBlbHNlICIiCiAgICByZXR1cm4gcy51cHBlcigpCgpkZWYgY21kX3dyaXRlKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgaWYgbm90IGFyZ3M6CiAgICAgICAgcmV0dXJuICJ3cml0ZTogbWlzc2luZyBmaWxlbmFtZVxuIgogICAgcGF0aCA9IGFyZ3NbMF0KICAgIHMgPSBpbnB1dF9kYXRhLmFzX3RleHQoKSBpZiBpbnB1dF9kYXRhIGlzIG5vdCBOb25lIGVsc2UgIiIKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInciKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKHMpCiAgICAgICAgcmV0dXJuICIiCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAiQ291bGRuJ3Qgd3JpdGUgZmlsZVxuIgoKZGVmIGNtZF9hcHBlbmQoYXJncywgaW5wdXRfZGF0YSk6CiAgICBpZiBub3QgYXJnczoKICAgICAgICByZXR1cm4gImFwcGVuZDogbWlzc2luZyBmaWxlbmFtZVxuIgogICAgcGF0aCA9IGFyZ3NbMF0KICAgIHMgPSBpbnB1dF9kYXRhLmFzX3RleHQoKSBpZiBpbnB1dF9kYXRhIGlzIG5vdCBOb25lIGVsc2UgIiIKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4ocGF0",
    "aCwgImEiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKHMpCiAgICAgICAgcmV0dXJuICIiCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICMgZmFsbGJhY2sgaWYgYXBwZW5kIG5vdCBzdXBwb3J0ZWQKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9sZCA9ICIiCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIpIGFzIHI6CiAgICAgICAgICAgICAgICAgICAgb2xkID0gci5yZWFkKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIG9sZCA9ICIiCiAgICAgICAgICAgIHdpdGggb3BlbihwYXRoLCAidyIpIGFzIHc6CiAgICAgICAgICAgICAgICB3LndyaXRlKG9sZCArIHMpCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiAiQ291bGRuJ3QgYXBwZW5kIGZpbGVcbiIKCmRlZiBjbWRfdGVzdChhcmdzLCBpbnB1dF9kYXRhKToKICAgICMgc3VwcG9ydCBbIC4uLiBdIGJ5IGlnbm9yaW5nIHRyYWlsaW5nIF0KICAgIGlmIGFyZ3MgYW5kIGFyZ3NbLTFdID09ICJdIjoKICAgICAgICBhcmdzID0gYXJnc1s6",
    "LTFdCiAgICBpZiBub3QgYXJnczoKICAgICAgICByZXR1cm4gIiIKCiAgICBpZiBsZW4oYXJncykgPT0gMjoKICAgICAgICBvcCwgYSA9IGFyZ3NbMF0sIGFyZ3NbMV0KICAgICAgICBpZiBvcCA9PSAiLWYiOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5zdGF0KGEpCiAgICAgICAgICAgICAgICByZXR1cm4gIjEiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBpZiBvcCA9PSAiLWQiOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5saXN0ZGlyKGEpCiAgICAgICAgICAgICAgICByZXR1cm4gIjEiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBpZiBvcCA9PSAiLXoiOgogICAgICAgICAgICByZXR1cm4gIjEiIGlmIHN0cihhKSA9PSAiIiBlbHNlICIiCiAgICAgICAgaWYgb3AgPT0gIi1uIjoKICAgICAgICAgICAgcmV0dXJuICIxIiBpZiBzdHIoYSkgIT0gIiIgZWxzZSAiIgoKICAgIGlmIGxlbihhcmdzKSA+PSAzOgogICAgICAgIGEsIG9wLCBiID0gYXJnc1swXSwgYXJnc1sxXSwg",
    "YXJnc1syXQogICAgICAgIGlmIG9wID09ICI9IjoKICAgICAgICAgICAgcmV0dXJuICIxIiBpZiBzdHIoYSkgPT0gc3RyKGIpIGVsc2UgIiIKICAgICAgICBpZiBvcCA9PSAiIT0iOgogICAgICAgICAgICByZXR1cm4gIjEiIGlmIHN0cihhKSAhPSBzdHIoYikgZWxzZSAiIgogICAgICAgIGlmIG9wIGluICgiLWVxIiwgIi1uZSIsICItbHQiLCAiLWxlIiwgIi1ndCIsICItZ2UiKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYWkgPSBpbnQoc3RyKGEpLnN0cmlwKCkpCiAgICAgICAgICAgICAgICBiaSA9IGludChzdHIoYikuc3RyaXAoKSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICBpZiBvcCA9PSAiLWVxIjogcmV0dXJuICIxIiBpZiBhaSA9PSBiaSBlbHNlICIiCiAgICAgICAgICAgIGlmIG9wID09ICItbmUiOiByZXR1cm4gIjEiIGlmIGFpICE9IGJpIGVsc2UgIiIKICAgICAgICAgICAgaWYgb3AgPT0gIi1sdCI6IHJldHVybiAiMSIgaWYgYWkgPCAgYmkgZWxzZSAiIgogICAgICAgICAgICBpZiBvcCA9PSAiLWxlIjogcmV0dXJuICIxIiBpZiBhaSA8PSBiaSBl",
    "bHNlICIiCiAgICAgICAgICAgIGlmIG9wID09ICItZ3QiOiByZXR1cm4gIjEiIGlmIGFpID4gIGJpIGVsc2UgIiIKICAgICAgICAgICAgaWYgb3AgPT0gIi1nZSI6IHJldHVybiAiMSIgaWYgYWkgPj0gYmkgZWxzZSAiIgogICAgcmV0dXJuICIiCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgVk0gY29uc3RydWN0aW9uIChjb21tYW5kcyArIGpvYiBjb250cm9sKQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmRlZiBtYWtlX3ZtKCk6CiAgICAjIElmIHlvdSdyZSB0aWdodCBvbiBSQU0sIGxvd2VyIHRoaXMgdG8gNTEyIG9yIDI1Ni4KICAgIHZtID0gVk0oY29tbWFuZHM9e30sIHNwb29sX3BhdGg9IlNURE9VVCIsIHNwb29sX3RocmVzaG9sZD0yMDQ4KQoKICAgIGRlZiBjbWRfYWRkdihhcmdzLCBpbnB1dF9kYXRhKToKICAgICAgICAjIGFkZHYgdmFyIGRlbHRhIChxdWlldCkKICAgICAgICBpZiBsZW4oYXJncykgPCAyOgogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBuYW1lLCBkZWx0YV9zID0gYXJnc1swXSwgYXJnc1sxXQogICAgICAgIHYgPSB2bS52YXJzLmdldChuYW1lLCAiMCIpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBuID0gaW50",
    "KHN0cih2KS5zdHJpcCgpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIG4gPSAwCiAgICAgICAgdHJ5OgogICAgICAgICAgICBkID0gaW50KHN0cihkZWx0YV9zKS5zdHJpcCgpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGQgPSAwCiAgICAgICAgdm0udmFyc1tuYW1lXSA9IHN0cihuICsgZCkKICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgY21kX2pvYnMoYXJncywgaW5wdXRfZGF0YSk6CiAgICAgICAgaWYgbm90IHZtLmpvYnM6CiAgICAgICAgICAgIHJldHVybiAiKG5vIGpvYnMpXG4iCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIGZvciBqaWQsIGpvYiBpbiB2bS5qb2JzLml0ZW1zKCk6CiAgICAgICAgICAgIHN0YXRlID0gImRvbmUiIGlmIGpvYi5kb25lIGVsc2UgInJ1bm5pbmciCiAgICAgICAgICAgIGxpbmVzLmFwcGVuZCgiW3t9XSB7fSAtIHt9Ii5mb3JtYXQoamlkLCBzdGF0ZSwgam9iLm5hbWUpKQogICAgICAgIHJldHVybiAiXG4iLmpvaW4obGluZXMpICsgIlxuIgoKICAgIGRlZiBjbWRfa2lsbChhcmdzLCBpbnB1dF9kYXRhKToKICAgICAgICBpZiBub3QgYXJnczoKICAgICAgICAgICAg",
    "cmV0dXJuICJraWxsOiB1c2FnZSBraWxsIDxqb2JpZD5cbiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGppZCA9IGludChhcmdzWzBdKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiAia2lsbDogYmFkIGpvYmlkXG4iCiAgICAgICAgam9iID0gdm0uam9icy5nZXQoamlkKQogICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgIHJldHVybiAia2lsbDogbm8gc3VjaCBqb2JcbiIKICAgICAgICBqb2IuZG9uZSA9IFRydWUKICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgY21kX2ZnKGFyZ3MsIGlucHV0X2RhdGEpOgogICAgICAgIGlmIG5vdCBhcmdzOgogICAgICAgICAgICByZXR1cm4gImZnOiB1c2FnZSBmZyA8am9iaWQ+XG4iCiAgICAgICAgdHJ5OgogICAgICAgICAgICBqaWQgPSBpbnQoYXJnc1swXSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gImZnOiBiYWQgam9iaWRcbiIKICAgICAgICBqb2IgPSB2bS5qb2JzLmdldChqaWQpCiAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgcmV0dXJuICJmZzogbm8gc3VjaCBqb2JcbiIKICAgICAgICB3aGlsZSBub3Qgam9iLmRv",
    "bmU6CiAgICAgICAgICAgIGpvYi5zdGVwKG49MjAwKQogICAgICAgIGVyciA9IGpvYi5lcnJvcgogICAgICAgIGRlbCB2bS5qb2JzW2ppZF0KICAgICAgICBpZiBlcnI6CiAgICAgICAgICAgIHJldHVybiAiZmc6IGpvYiBlcnJvcjogJXNcbiIgJSBlcnIKICAgICAgICByZXR1cm4gIiIKCiAgICB2bS5jb21tYW5kcy51cGRhdGUoewogICAgICAgICMgeW91ciBjb21tYW5kcwogICAgICAgICJoZWxwIjogY21kX2hlbHAsCiAgICAgICAgImxzIjogY21kX2xzLAogICAgICAgICJ1bmFtZSI6IGNtZF91bmFtZSwKICAgICAgICAiZnJlZSI6IGNtZF9mcmVlLAogICAgICAgICJkZiI6IGNtZF9kZiwKICAgICAgICAicHdkIjogY21kX3B3ZCwKICAgICAgICAiY2F0IjogY21kX2NhdCwKICAgICAgICAid2MiOiBjbWRfd2MsCiAgICAgICAgImdyZXAiOiBjbWRfZ3JlcCwKICAgICAgICAiY3AiOiBjbWRfY3AsCiAgICAgICAgImNkIjogY21kX2NkLAogICAgICAgICJyZW5hbWUiOiBjbWRfcmVuYW1lLAogICAgICAgICJta2RpciI6IGNtZF9ta2RpciwKICAgICAgICAicm1kaXIiOiBjbWRfcm1kaXIsCiAgICAgICAgImV4ZWMiOiBjbWRfZXhlYywKICAgICAgICAicm0i",
    "OiBjbWRfcm0sCiAgICAgICAgImRhdGUiOiBjbWRfZGF0ZSwKICAgICAgICAic2NhbndpZmkiOiBjbWRfc2NhbndpZmksCiAgICAgICAgImNvbm5lY3QiOiBjbWRfY29ubmVjdCwKICAgICAgICAiaWZjb25maWciOiBjbWRfaWZjb25maWcsCiAgICAgICAgImVkaXQiOiBjbWRfZWRpdCwKCiAgICAgICAgIyBleHRyYXMKICAgICAgICAiZWNobyI6IGNtZF9lY2hvLAogICAgICAgICJ1cHBlciI6IGNtZF91cHBlciwKCiAgICAgICAgIyByZWRpcmVjdGlvbgogICAgICAgICJ3cml0ZSI6IGNtZF93cml0ZSwKICAgICAgICAiYXBwZW5kIjogY21kX2FwcGVuZCwKCiAgICAgICAgIyB0ZXN0ICsgaGVscGVycyB1c2VkIGJ5IGxvb3BzL2NoYWlucwogICAgICAgICJ0ZXN0IjogY21kX3Rlc3QsCiAgICAgICAgIlsiOiBjbWRfdGVzdCwKICAgICAgICAiYWRkdiI6IGNtZF9hZGR2LAoKICAgICAgICAjIHNsZWVwCiAgICAgICAgInNsZWVwIjogY21kX3NsZWVwLAogICAgICAgICJydW4iOiBjbWRfcnVuLAoKICAgICAgICAjIGpvYiBjb250cm9sCiAgICAgICAgImpvYnMiOiBjbWRfam9icywKICAgICAgICAia2lsbCI6IGNtZF9raWxsLAogICAgICAgICJmZyI6IGNtZF9m",
    "ZywKICAgIH0pCgogICAgcmV0dXJuIHZtCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgUkVQTCAoYXV0bzogbGl2ZSBvbiBNaWNyb1B5dGhvbiB3aGVuIHBvbGxhYmxlLCBiYXNpYyBvdGhlcndpc2UpCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZGVmIHN0ZGluX2lzX3BvbGxhYmxlKCk6CiAgICBpZiBzZWxlY3QgaXMgTm9uZToKICAgICAgICByZXR1cm4gRmFsc2UKICAgIHRyeToKICAgICAgICBwID0gc2VsZWN0LnBvbGwoKQogICAgICAgIHAucmVnaXN0ZXIoc3lzLnN0ZGluLCBzZWxlY3QuUE9MTElOKQogICAgICAgIHAucG9sbCgwKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIHJ1bl9saW5lKHZtLCBsaW5lKToKICAgIGNvZGUsIGJnID0gY29tcGlsZV9saW5lKGxpbmUpCiAgICBpZiBiZzoKICAgICAgICBqaWQgPSB2bS5zdGFydF9qb2IoY29kZSwgbmFtZT1saW5lKQogICAgICAgIHByaW50KCJbe31dIHN0YXJ0ZWQge30iLmZvcm1hdChqaWQsIGxpbmUpKQogICAgZWxzZToKICAgICAgICB2bS5jb2RlID0gY29kZQogICAgICAgIHZtLnJ1bih0cmFjZT1GYWxzZSkK",
    "CmRlZiByZXBsX2Jsb2NraW5nKHZtKToKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdm0ucG9sbF9qb2JzKHN0ZXBzPTIwMCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxpbmUgPSBpbnB1dCgicHVzaD4gIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBicmVhawogICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiBsaW5lID09ICJleGl0IjoKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJ1bl9saW5lKHZtLCBsaW5lKQogICAgICAgIGV4Y2VwdCBDb21waWxlRXJyb3IgYXMgY2U6CiAgICAgICAgICAgIHByaW50KCJDb21waWxlIGVycm9yOiIsIGNlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoIkVycm9yOiIsIGUpCgpkZWYgcmVwbF9ub25ibG9ja2luZyh2bSk6CiAgICBwID0gc2VsZWN0LnBvbGwoKQogICAgcC5yZWdpc3RlcihzeXMuc3RkaW4sIHNlbGVjdC5QT0xMSU4pCgogICAgYnVm",
    "ID0gIiIKICAgIHN5cy5zdGRvdXQud3JpdGUoInB1c2g+ICIpCiAgICB0cnk6CiAgICAgICAgc3lzLnN0ZG91dC5mbHVzaCgpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHZtLnBvbGxfam9icyhzdGVwcz04MCkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBldiA9IHAucG9sbCgwKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHByaW50KCJcbihsaXZlIGlucHV0IHVuYXZhaWxhYmxlOyBzd2l0Y2hpbmcgdG8gYmFzaWMgbW9kZSkiKQogICAgICAgICAgICByZXBsX2Jsb2NraW5nKHZtKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgbm90IGV2OgogICAgICAgICAgICBfc2xlZXBfbXMoMTApCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHRyeToKICAgICAgICAgICAgY2ggPSBzeXMuc3RkaW4ucmVhZCgxKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIF9zbGVlcF9tcygxMCkKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgbm90IGNoOgogICAgICAgICAgICBfc2xlZXBfbXMoMTApCiAgICAgICAgICAgIGNvbnRpbnVl",
    "CgogICAgICAgIGlmIGNoID09ICJcciI6CiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIGNoID09ICJcbiI6CiAgICAgICAgICAgIGxpbmUgPSBidWYuc3RyaXAoKQogICAgICAgICAgICBidWYgPSAiIgogICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCJcbiIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQuZmx1c2goKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgaWYgbGluZSA9PSAiZXhpdCI6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgaWYgbGluZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBydW5fbGluZSh2bSwgbGluZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBDb21waWxlRXJyb3IgYXMgY2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIkNvbXBpbGUgZXJyb3I6IiwgY2UpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIkVycm9yOiIsIGUpCgogICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCJwdXNo",
    "PiAiKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgY2ggPT0gIlx4MDgiIG9yIGNoID09ICJceDdmIjoKICAgICAgICAgICAgaWYgYnVmOgogICAgICAgICAgICAgICAgYnVmID0gYnVmWzotMV0KICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoIlxiIFxiIikKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBidWYgKz0gY2gKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKGNoKQogICAgICAgIHRyeToKICAgICAgICAgICAgc3lzLnN0ZG91dC5mbHVzaCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKZGVmIHJlcGxfYXV0byh2bSk6CiAgICAjIEF2b2lkICJkb3VibGUtZWNobyIgaXNzdWVzIG9uIGRlc2t0",
    "b3AgdGVybWluYWxzOiBvbmx5IGRvIGxpdmUgbW9kZSBvbiBNaWNyb1B5dGhvbi4KICAgIGlmIGlzX21pY3JvcHl0aG9uKCkgYW5kIHN0ZGluX2lzX3BvbGxhYmxlKCk6CiAgICAgICAgcHJpbnQoIkludGVyYWN0aXZlIG1vZGU6IGxpdmUgKGJhY2tncm91bmQgam9icyBydW4gd2hpbGUgeW91IHR5cGUpIikKICAgICAgICByZXBsX25vbmJsb2NraW5nKHZtKQogICAgZWxzZToKICAgICAgICBwcmludCgiSW50ZXJhY3RpdmUgbW9kZTogYmFzaWMgKGJhY2tncm91bmQgam9icyBydW4gYmV0d2VlbiBjb21tYW5kcykiKQogICAgICAgIHJlcGxfYmxvY2tpbmcodm0pCgpkZWYgcmVwbCgpOgogICAgdm0gPSBtYWtlX3ZtKCkKICAgIHByaW50KCJQVVNIIFZNIiwgVkVSU0lPTikKICAgIHByaW50KCJUeXBlICdoZWxwJy4gVXNlICdleGl0JyB0byBxdWl0LiIpCiAgICBwcmludCgiQmFja2dyb3VuZDogYWRkICcmJyBhdCBlbmQuIEpvYiBjb250cm9sOiBqb2JzL2tpbGwvZmcuIikKICAgIHJlcGxfYXV0byh2bSkKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICByZXBsKCkK",
)

XPKGB64 = (
    "aW1wb3J0IHVyZXF1ZXN0cwppbXBvcnQganNvbgppbXBvcnQgc3lzCmltcG9ydCBvcwoKREVGQVVMVF9SRVBPID0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9lbGFodHJlYm9yL3hwa2cvbWFpbiIKQ0ZHX1BBVEggPSAiL2xpYi8ueHBrZy9jb25maWcuanNvbiIKCmRlZiBfZW5zdXJlX2RpcnMoKToKICAgIHRyeToKICAgICAgICBvcy5ta2RpcigiL2xpYi8ueHBrZyIpCiAgICBleGNlcHQ6CiAgICAgICAgcGFzcwoKZGVmIGxvYWRfcmVwbygpOgogICAgX2Vuc3VyZV9kaXJzKCkKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oQ0ZHX1BBVEgsICJyIikgYXMgZjoKICAgICAgICAgICAgY2ZnID0ganNvbi5sb2FkcyhmLnJlYWQoKSkKICAgICAgICByZXR1cm4gY2ZnLmdldCgicmVwbyIsIERFRkFVTFRfUkVQTykKICAgIGV4Y2VwdDoKICAgICAgICByZXR1cm4gREVGQVVMVF9SRVBPCgpkZWYgc2F2ZV9yZXBvKHVybCk6CiAgICBfZW5zdXJlX2RpcnMoKQogICAgd2l0aCBvcGVuKENGR19QQVRILCAidyIpIGFzIGY6CiAgICAgICAgZi53cml0ZShqc29uLmR1bXBzKHsicmVwbyI6IHVybH0pKQogICAgcmV0dXJuICJyZXBvIHNldCB0byAlc1xu",
    "IiAlIHVybAoKZGVmIGZldGNoX2luZGV4KHJlcG9fdXJsKToKICAgIHVybCA9IHJlcG9fdXJsLnJzdHJpcCgiLyIpICsgIi9pbmRleC5qc29uIgogICAgciA9IHVyZXF1ZXN0cy5nZXQodXJsKQogICAgdHJ5OgogICAgICAgIGlmIHIuc3RhdHVzX2NvZGUgIT0gMjAwOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkhUVFAgJWQiICUgci5zdGF0dXNfY29kZSkKICAgICAgICByZXR1cm4ganNvbi5sb2FkcyhyLnRleHQpCiAgICBmaW5hbGx5OgogICAgICAgIHIuY2xvc2UoKQoKZGVmIGNtZF9saXN0KHJlcG9fdXJsKToKICAgIGlkeCA9IGZldGNoX2luZGV4KHJlcG9fdXJsKQogICAgb3V0ID0gW10KICAgIGZvciBuYW1lLCBtZXRhIGluIGlkeC5pdGVtcygpOgogICAgICAgIGlmIG5hbWUgaW4gKCJyZXBvIiwgInVwZGF0ZWQiKToKICAgICAgICAgICAgY29udGludWUKICAgICAgICBvdXQuYXBwZW5kKCIlLTEwcyAlcyAtICVzIiAlICgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgbWV0YS5nZXQoInZlcnNpb24iLCAiPyIpLAogICAgICAgICAgICBtZXRhLmdldCgiZGVzYyIsICIiKQogICAgICAgICkpCiAgICByZXR1cm4gIlxuIi5qb2luKG91",
    "dCkgKyAiXG4iCgpkZWYgX2Rvd25sb2FkX3RvX2ZpbGUodXJsLCBkc3QpOgogICAgIyBTdHJlYW0gdG8gZmlsZSB0byBhdm9pZCBiaWcgUkFNIHVzYWdlCiAgICByID0gdXJlcXVlc3RzLmdldCh1cmwpCiAgICB0cnk6CiAgICAgICAgaWYgci5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgIHJldHVybiAiZG93bmxvYWQgZmFpbGVkOiBIVFRQICVkXG4iICUgci5zdGF0dXNfY29kZQogICAgICAgIHdpdGggb3Blbihkc3QsICJ3YiIpIGFzIGY6CiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBjaHVuayA9IHIucmF3LnJlYWQoNTEyKQogICAgICAgICAgICAgICAgaWYgbm90IGNodW5rOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBmLndyaXRlKGNodW5rKQogICAgICAgIHJldHVybiBOb25lCiAgICBmaW5hbGx5OgogICAgICAgIHRyeTogci5jbG9zZSgpCiAgICAgICAgZXhjZXB0OiBwYXNzCgpkZWYgY21kX2luc3RhbGwocGtnLCByZXBvX3VybCk6CiAgICBpZHggPSBmZXRjaF9pbmRleChyZXBvX3VybCkKICAgIGlmIHBrZyBub3QgaW4gaWR4OgogICAgICAgIHJldHVybiAieHBrZzogcGFja2Fn",
    "ZSBub3QgZm91bmQ6ICVzXG4iICUgcGtnCgogICAgbWV0YSA9IGlkeFtwa2ddCiAgICBzcmMgPSByZXBvX3VybC5yc3RyaXAoIi8iKSArICIvcGFja2FnZXMvIiArIG1ldGFbImZpbGUiXQogICAgZHN0ID0gbWV0YS5nZXQoImluc3RhbGwiLCAiL2xpYi8iICsgcGtnICsgIi5weSIpCgogICAgZXJyID0gX2Rvd25sb2FkX3RvX2ZpbGUoc3JjLCBkc3QpCiAgICBpZiBlcnI6CiAgICAgICAgcmV0dXJuIGVycgogICAgcmV0dXJuICJpbnN0YWxsZWQgJXMgLT4gJXNcbiIgJSAocGtnLCBkc3QpCgpkZWYgdXNhZ2UoKToKICAgIHJldHVybiAoCiAgICAgICAgInhwa2cgdXNhZ2U6XG4iCiAgICAgICAgIiAgeHBrZyByZXBvIDx1cmw+XG4iCiAgICAgICAgIiAgeHBrZyBsaXN0XG4iCiAgICAgICAgIiAgeHBrZyBpbnN0YWxsIDxwa2c+XG4iCiAgICApCgpkZWYgbWFpbihhcmd2KToKICAgIGlmIG5vdCBhcmd2OgogICAgICAgIHJldHVybiB1c2FnZSgpCgogICAgcmVwb191cmwgPSBsb2FkX3JlcG8oKQogICAgY21kID0gYXJndlswXQoKICAgIGlmIGNtZCA9PSAicmVwbyI6CiAgICAgICAgaWYgbGVuKGFyZ3YpIDwgMjoKICAgICAgICAgICAgcmV0dXJuICJjdXJyZW50",
    "IHJlcG86ICVzXG4iICUgcmVwb191cmwKICAgICAgICByZXR1cm4gc2F2ZV9yZXBvKGFyZ3ZbMV0pCgogICAgaWYgY21kID09ICJsaXN0IjoKICAgICAgICByZXR1cm4gY21kX2xpc3QocmVwb191cmwpCgogICAgaWYgY21kID09ICJpbnN0YWxsIjoKICAgICAgICBpZiBsZW4oYXJndikgPCAyOgogICAgICAgICAgICByZXR1cm4gInhwa2c6IGluc3RhbGwgcmVxdWlyZXMgYSBwYWNrYWdlIG5hbWVcbiIKICAgICAgICByZXR1cm4gY21kX2luc3RhbGwoYXJndlsxXSwgcmVwb191cmwpCgogICAgcmV0dXJuIHVzYWdlKCkK",
)

DHCPB64 = (
    "aW1wb3J0IG5ldHdvcmsKIyBOT1RFIEVkaXQgdGhpcyBmaWxlIGFuZCBjaGFuZ2UgaXQgdG8gY2hhbmdlIG5ldHdvcmsgY29ubmVjdGlvbgpzc2lkID0gIlNTSURfVkFSIgp3a2V5ID0gIldLRVlfVkFSIgoKd2xhbiA9IG5ldHdvcmsuV0xBTihuZXR3b3JrLlNUQV9JRikKd2xhbi5hY3RpdmUoVHJ1ZSkKc2Nhbm5lZCA9IHdsYW4uc2NhbigpCndsYW4uY29ubmVjdChzc2lkLCB3a2V5KQoKCg==",
)
#for line in PUSHB64:
#  chunk = decode_b64_to_text(line)
#  append_to_file("/pushvm.py", chunk)

write_b64_chunks_to_file("/pushvm.py", PUSHB64)

del PUSHB64
gc.collect()


print("Installing xpkg...")

write_b64_chunks_to_file("/lib/xpkg.py", XPKGB64)
del XPKGB64
gc.collect()

installNetwork = input("Do you want to setup wireless networking? (y|n)")
if installNetwork == "y":
     print("Note this will create a script called dhcp.py and include your credentials in it.")
     print("It will also add the dhcp script to boot so networking is automatic..")
     ssid = input("Enter the SSID>")
     wkey = input("Enter the password")
     print ("Creating dhcp.py")
     dhtxt = decode_b64_to_text(DHCPB64)
     dhtxt = dhtxt.replace("SSID_VAR", ssid).replace("WKEY_VAR", wkey)
     write_text_file("/dhcp.py", dhtxt)
     print ("Appending import dhcp in boot.py")
     append_to_file("/boot.py", "\n" + "import dhcp" + "\n")
else:
     print("Skipping network setup")

print("Install complete.. Please reboot your microcontroller now..")
print("After install.\nTo run push enter:\nimport pushvm\npushvm.repl()\n")




